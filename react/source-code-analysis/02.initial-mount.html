<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react å†…éƒ¨çš„åˆå§‹åŒ–æŒ‚è½½ | é‚“æ”€çš„æŠ€æœ¯åšå®¢</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge/assets/css/0.styles.19179342.css" as="style"><link rel="preload" href="/knowledge/assets/js/app.5153ca81.js" as="script"><link rel="preload" href="/knowledge/assets/js/2.09711cee.js" as="script"><link rel="preload" href="/knowledge/assets/js/1.ecac6abe.js" as="script"><link rel="preload" href="/knowledge/assets/js/10.61451e43.js" as="script"><link rel="prefetch" href="/knowledge/assets/js/100.fb313dd8.js"><link rel="prefetch" href="/knowledge/assets/js/101.f6084221.js"><link rel="prefetch" href="/knowledge/assets/js/11.0d8da72b.js"><link rel="prefetch" href="/knowledge/assets/js/12.7874f28d.js"><link rel="prefetch" href="/knowledge/assets/js/13.7e77d130.js"><link rel="prefetch" href="/knowledge/assets/js/14.73222ce7.js"><link rel="prefetch" href="/knowledge/assets/js/15.0b07f9b9.js"><link rel="prefetch" href="/knowledge/assets/js/16.2cc5269e.js"><link rel="prefetch" href="/knowledge/assets/js/17.4dc16511.js"><link rel="prefetch" href="/knowledge/assets/js/18.0f42d2d9.js"><link rel="prefetch" href="/knowledge/assets/js/19.d5eb91b2.js"><link rel="prefetch" href="/knowledge/assets/js/20.748f25e2.js"><link rel="prefetch" href="/knowledge/assets/js/21.518a3952.js"><link rel="prefetch" href="/knowledge/assets/js/22.215fc719.js"><link rel="prefetch" href="/knowledge/assets/js/23.85574af4.js"><link rel="prefetch" href="/knowledge/assets/js/24.179f0801.js"><link rel="prefetch" href="/knowledge/assets/js/25.e813b79e.js"><link rel="prefetch" href="/knowledge/assets/js/26.ea3c2f8a.js"><link rel="prefetch" href="/knowledge/assets/js/27.d9a0e0aa.js"><link rel="prefetch" href="/knowledge/assets/js/28.499e6f9d.js"><link rel="prefetch" href="/knowledge/assets/js/29.7ecc7047.js"><link rel="prefetch" href="/knowledge/assets/js/3.6c565688.js"><link rel="prefetch" href="/knowledge/assets/js/30.938ba476.js"><link rel="prefetch" href="/knowledge/assets/js/31.0a6ecdcd.js"><link rel="prefetch" href="/knowledge/assets/js/32.8aef7027.js"><link rel="prefetch" href="/knowledge/assets/js/33.6f6a3468.js"><link rel="prefetch" href="/knowledge/assets/js/34.d901a786.js"><link rel="prefetch" href="/knowledge/assets/js/35.1fd0524e.js"><link rel="prefetch" href="/knowledge/assets/js/36.77bc3059.js"><link rel="prefetch" href="/knowledge/assets/js/37.679cc1e5.js"><link rel="prefetch" href="/knowledge/assets/js/38.f75e290e.js"><link rel="prefetch" href="/knowledge/assets/js/39.1d0ee5d8.js"><link rel="prefetch" href="/knowledge/assets/js/4.587ffb67.js"><link rel="prefetch" href="/knowledge/assets/js/40.3cb3a24b.js"><link rel="prefetch" href="/knowledge/assets/js/41.027942e8.js"><link rel="prefetch" href="/knowledge/assets/js/42.8eb2c3d5.js"><link rel="prefetch" href="/knowledge/assets/js/43.090ab8dc.js"><link rel="prefetch" href="/knowledge/assets/js/44.3bd0b34a.js"><link rel="prefetch" href="/knowledge/assets/js/45.f8142d41.js"><link rel="prefetch" href="/knowledge/assets/js/46.82abb8fa.js"><link rel="prefetch" href="/knowledge/assets/js/47.0f319d1e.js"><link rel="prefetch" href="/knowledge/assets/js/48.c6480f5c.js"><link rel="prefetch" href="/knowledge/assets/js/49.f4067732.js"><link rel="prefetch" href="/knowledge/assets/js/5.15716dac.js"><link rel="prefetch" href="/knowledge/assets/js/50.757a56db.js"><link rel="prefetch" href="/knowledge/assets/js/51.7ebfa544.js"><link rel="prefetch" href="/knowledge/assets/js/52.9611130c.js"><link rel="prefetch" href="/knowledge/assets/js/53.9a8b6f46.js"><link rel="prefetch" href="/knowledge/assets/js/54.a5ab0902.js"><link rel="prefetch" href="/knowledge/assets/js/55.cba7ef0d.js"><link rel="prefetch" href="/knowledge/assets/js/56.af6cd21e.js"><link rel="prefetch" href="/knowledge/assets/js/57.59fb1a6a.js"><link rel="prefetch" href="/knowledge/assets/js/58.d606fdf7.js"><link rel="prefetch" href="/knowledge/assets/js/59.6761b349.js"><link rel="prefetch" href="/knowledge/assets/js/6.6a6617af.js"><link rel="prefetch" href="/knowledge/assets/js/60.a7f4c4ff.js"><link rel="prefetch" href="/knowledge/assets/js/61.e9190c42.js"><link rel="prefetch" href="/knowledge/assets/js/62.a9401860.js"><link rel="prefetch" href="/knowledge/assets/js/63.b827600a.js"><link rel="prefetch" href="/knowledge/assets/js/64.e38255e6.js"><link rel="prefetch" href="/knowledge/assets/js/65.02b1dd62.js"><link rel="prefetch" href="/knowledge/assets/js/66.8f2338cb.js"><link rel="prefetch" href="/knowledge/assets/js/67.c01adc05.js"><link rel="prefetch" href="/knowledge/assets/js/68.e358bf7d.js"><link rel="prefetch" href="/knowledge/assets/js/69.39b37e2d.js"><link rel="prefetch" href="/knowledge/assets/js/7.ba76af71.js"><link rel="prefetch" href="/knowledge/assets/js/70.dcc63002.js"><link rel="prefetch" href="/knowledge/assets/js/71.12f2ab04.js"><link rel="prefetch" href="/knowledge/assets/js/72.2bfd6ad1.js"><link rel="prefetch" href="/knowledge/assets/js/73.1bc5932a.js"><link rel="prefetch" href="/knowledge/assets/js/74.d9482a02.js"><link rel="prefetch" href="/knowledge/assets/js/75.67d0111b.js"><link rel="prefetch" href="/knowledge/assets/js/76.150ac4a4.js"><link rel="prefetch" href="/knowledge/assets/js/77.4deee2b6.js"><link rel="prefetch" href="/knowledge/assets/js/78.5921430f.js"><link rel="prefetch" href="/knowledge/assets/js/79.f74ff1d0.js"><link rel="prefetch" href="/knowledge/assets/js/80.5c34c25e.js"><link rel="prefetch" href="/knowledge/assets/js/81.6e54321c.js"><link rel="prefetch" href="/knowledge/assets/js/82.e8bbc1c5.js"><link rel="prefetch" href="/knowledge/assets/js/83.49d5e292.js"><link rel="prefetch" href="/knowledge/assets/js/84.98c35d72.js"><link rel="prefetch" href="/knowledge/assets/js/85.f73eb0e7.js"><link rel="prefetch" href="/knowledge/assets/js/86.3d3735cc.js"><link rel="prefetch" href="/knowledge/assets/js/87.5d806d0d.js"><link rel="prefetch" href="/knowledge/assets/js/88.57c59503.js"><link rel="prefetch" href="/knowledge/assets/js/89.aa1e2fe4.js"><link rel="prefetch" href="/knowledge/assets/js/90.2c50ee69.js"><link rel="prefetch" href="/knowledge/assets/js/91.ae6cb9aa.js"><link rel="prefetch" href="/knowledge/assets/js/92.ff541495.js"><link rel="prefetch" href="/knowledge/assets/js/93.8f52d80b.js"><link rel="prefetch" href="/knowledge/assets/js/94.e6d1e6c5.js"><link rel="prefetch" href="/knowledge/assets/js/95.c55344fe.js"><link rel="prefetch" href="/knowledge/assets/js/96.6a87e9ca.js"><link rel="prefetch" href="/knowledge/assets/js/97.43e0ca7f.js"><link rel="prefetch" href="/knowledge/assets/js/98.3fcabc73.js"><link rel="prefetch" href="/knowledge/assets/js/99.f68c9886.js"><link rel="prefetch" href="/knowledge/assets/js/vendors~docsearch.7a484b82.js">
    <link rel="stylesheet" href="/knowledge/assets/css/0.styles.19179342.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge/" class="home-link router-link-active"><!----> <span class="site-name">é‚“æ”€çš„æŠ€æœ¯åšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge/" aria-current="page" class="sidebar-link">æ¬¢è¿</a></li><li><section class="sidebar-group depth-0"><a href="/knowledge/vue" class="sidebar-heading clickable"><span>Vue</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/vue/å“åº”å¼.html" class="sidebar-link">å“åº”å¼</a></li><li><a href="/knowledge/vue/ç¼–è¯‘.html" class="sidebar-link">ç¼–è¯‘</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/react" class="sidebar-heading clickable router-link-active open"><span>React</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/react/01.JSX.html" class="sidebar-link">JSX</a></li><li><a href="/knowledge/react/02.Fiber.html" class="sidebar-link">Fiber</a></li><li><a href="/knowledge/react/03.bit.html" class="sidebar-link">Bit</a></li><li><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html" class="sidebar-link">BuildYourOwnReact</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Source Code Analysis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/react/source-code-analysis/01.travers-fiber-tree.html" class="sidebar-link">Travers Fiber Tree</a></li><li><a href="/knowledge/react/source-code-analysis/02.initial-mount.html" aria-current="page" class="active sidebar-link">Initial Mount</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge/react/source-code-analysis/02.initial-mount.html#fiber-ç»“æ„ä»‹ç»" class="sidebar-link">Fiber ç»“æ„ä»‹ç»</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/source-code-analysis/02.initial-mount.html#å¤§è‡´è¿‡ç¨‹" class="sidebar-link">å¤§è‡´è¿‡ç¨‹</a></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/typescript" class="sidebar-heading clickable"><span>TypeScript</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/typescript/type-challenges.html" class="sidebar-link">ç±»å‹ä½“æ“</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/nextjs" class="sidebar-heading clickable"><span>nextjs</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/nextjs/docs/05.Fetching Data.html" class="sidebar-link">Fetching Data</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/nodejs" class="sidebar-heading clickable"><span>Node.js</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/nodejs/å¼‚æ­¥å¼io.html" class="sidebar-link">å¼‚æ­¥å¼IO</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/algorithm" class="sidebar-heading clickable"><span>ç®—æ³•</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/algorithm/äºŒåˆ†æŸ¥æ‰¾.html" class="sidebar-link">äºŒåˆ†æŸ¥æ‰¾</a></li><li><a href="/knowledge/algorithm/å¤§æ•°ç›¸åŠ .html" class="sidebar-link">å¤§æ•°ç›¸åŠ </a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/system-design" class="sidebar-heading clickable"><span>ç³»ç»Ÿè®¾è®¡</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/system-design/news-feed.html" class="sidebar-link">news feed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/interview" class="sidebar-heading clickable"><span>é¢è¯•ç›¸å…³</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/interview/html.html" class="sidebar-link">HTML</a></li><li><a href="/knowledge/interview/JavaScript.html" class="sidebar-link">JavaScript</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/GFE" class="sidebar-heading clickable"><span>GFE</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/GFE/01.debounce/" class="sidebar-link">Debounce</a></li><li><a href="/knowledge/GFE/02.myReduce/" class="sidebar-link">MyReduce</a></li><li><a href="/knowledge/GFE/03.classnames/" class="sidebar-link">ClassNames</a></li><li><a href="/knowledge/GFE/04.flatten/" class="sidebar-link">Flatten</a></li><li><a href="/knowledge/GFE/05.throttle/" class="sidebar-link">Throttle</a></li><li><a href="/knowledge/GFE/06.Type%20Utilities/" class="sidebar-link">Type Utilities</a></li><li><a href="/knowledge/GFE/07.Type%20Utilities%20II/" class="sidebar-link">Type Utilities II</a></li><li><a href="/knowledge/GFE/08.Promise.all/" class="sidebar-link">Promise.all</a></li><li><a href="/knowledge/GFE/09.Data%20Merging/" class="sidebar-link">Data Merging</a></li><li><a href="/knowledge/GFE/10.Deep%20Clone/" class="sidebar-link">Deep Clone</a></li><li><a href="/knowledge/GFE/11.Event%20Emitter/" class="sidebar-link">Event Emitter</a></li><li><a href="/knowledge/GFE/12.getElementsByStyle/" class="sidebar-link">getElementsByStyle</a></li><li><a href="/knowledge/GFE/13.Function.prototype.call/" class="sidebar-link">Function.prototype.call</a></li><li><a href="/knowledge/GFE/14.List%20Format/" class="sidebar-link">List Format</a></li><li><a href="/knowledge/GFE/15.Map%20Async%20Limit/" class="sidebar-link">Map Async Limit</a></li><li><a href="/knowledge/GFE/16.Deep%20Equal/" class="sidebar-link">Deep Equal</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/Blind" class="sidebar-heading clickable"><span>Blind</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/Blind/01.Balanced%20Brackets/" class="sidebar-link">Balanced Brackets</a></li><li><a href="/knowledge/Blind/02.Find%20Duplicates%20in%20Array/" class="sidebar-link">Find Duplicates in Array</a></li><li><a href="/knowledge/Blind/03.Find%20Missing%20Number%20in%20Sequence/" class="sidebar-link">Find Missing Number in Sequence</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/git" class="sidebar-heading clickable"><span>Git</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/git/commit.html" class="sidebar-link">commit</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-å†…éƒ¨çš„åˆå§‹åŒ–æŒ‚è½½"><a href="#react-å†…éƒ¨çš„åˆå§‹åŒ–æŒ‚è½½" class="header-anchor">#</a> react å†…éƒ¨çš„åˆå§‹åŒ–æŒ‚è½½</h1> <p>ç°åœ¨ä¸‹é¢æœ‰å¦‚ä¸‹é¡µé¢æ¸²æŸ“ä»£ç ï¼š</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>React in HTML<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./react.development.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./react-dom.development.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>
      <span class="token attr-name">crossorigin</span>
      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/@babel/standalone/babel.min.js<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.component</span> <span class="token punctuation">{</span>
      <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span>
      <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
      <span class="token property">margin</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- ä½¿ç”¨ type=&quot;text/babel&quot; è®© Babel ç¼–è¯‘ JSX --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/babel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;component&quot;</span> data<span class="token operator">-</span>name<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// åˆ›å»º React ç»„ä»¶</span>
      <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">A</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// æ¸²æŸ“ç»„ä»¶åˆ° DOM</span>
      <span class="token keyword">const</span> root <span class="token operator">=</span> ReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      root<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="fiber-ç»“æ„ä»‹ç»"><a href="#fiber-ç»“æ„ä»‹ç»" class="header-anchor">#</a> Fiber ç»“æ„ä»‹ç»</h2> <p>ä¸Šé¢çš„ä»£ç å¤§æ¦‚æ˜¯å¦‚ä¸‹çš„å±‚çº§ç»“æ„ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">A</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">A</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">B</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">A</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">App</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>ä¸Šé¢çš„ç»“æ„åœ¨<code>React</code>ä¸­ä¼šæ„å»ºå¦‚ä¸‹å›¾çš„ä¸€ä¸ª<code>FiberTree</code> <img src="/knowledge/assets/img/image-2.add44ecc.png" alt="alt text"></p> <p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¯¥<code>FiberTree</code>ä¸­ä¸€å…±åŒ…å« 2 ç§ä¸åŒçš„ç±»å‹ï¼š</p> <ul><li><code>FiberRootNode</code>: <code>FiberRootNode</code> æ˜¯ä¸€ä¸ªç‰¹æ®ŠèŠ‚ç‚¹ï¼Œå……å½“ <code>React</code> çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒä¿å­˜ç€æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€çš„å…ƒæ•°æ®ã€‚å…¶ <code>current</code> å±æ€§æŒ‡å‘å®é™…çš„ <code>Fiber</code> æ ‘ç»“æ„ï¼Œæ¯æ¬¡æ„å»ºæ–°çš„ <code>Fiber</code> æ ‘æ—¶ï¼Œå®ƒéƒ½ä¼šå°† <code>current</code> é‡æ–°æŒ‡å‘æ–°çš„ <code>HostRoot</code>ã€‚</li> <li><code>FiberNode</code>: <code>react</code>å†…éƒ¨ä¸­å¯¹ç»“ç‚¹çš„ä¸€ç§è¡¨ç¤ºï¼ŒåŒ…å«å¾ˆå¤šå±æ€§å¯ä»¥å¯¹å…¶ç»“ç‚¹è¿›è¡Œæè¿°
<ul><li><code>tag</code>: <code>FiberNode</code>æœ‰è®¸å¤šä¸åŒçš„å­ç±»å‹ï¼Œåœ¨<code>render</code>ä»¥åŠ<code>commit</code>é˜¶æ®µä¼šæ ¹æ®è¯¥å€¼è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œå¦‚<code>HostRoot</code>ã€<code>FunctionComponent</code>ã€<code>ClassComponent</code>ã€<code>HostComponent</code>ç­‰ç­‰</li> <li><code>stateNode</code>: å¯¹äº<code>tag</code>ä¸º<code>HostComponet</code>çš„<code>FiberNode</code>ï¼Œå…¶æŒ‡å‘é¡µé¢ä¸­å®é™…æ¸²æŸ“çš„<code>DOM</code>èŠ‚ç‚¹</li> <li><code>child</code>ã€<code>sibling</code>ã€<code>return</code>: åˆ†åˆ«æŒ‡å‘å­èŠ‚ç‚¹ï¼Œå…„å¼ŸèŠ‚ç‚¹ä»¥åŠçˆ¶èŠ‚ç‚¹ï¼Œç”¨äºæ„é€ å®Œæ•´<code>Fiber</code>æ ‘</li> <li><code>flags</code>: ç”¨äºè¡¨ç¤ºåœ¨ <code>commit</code> é˜¶æ®µéœ€è¦æ›´æ–°çš„ç±»å‹ã€‚subtreeFlags è¡¨ç¤ºå…¶å­æ ‘éœ€è¦æ›´æ–°çš„ç±»å‹</li></ul></li></ul> <p>ä¸Šé¢å¯¹äº<code>FiberNode</code>çš„å±æ€§ä»‹ç»åªåŒ…å«å½“å‰åˆå§‹åŒ–é¡µé¢æ‰€éœ€è¦çš„å±æ€§ï¼Œå…¶ä»–å±æ€§åœ¨åé¢éœ€è¦ç”¨åˆ°æ—¶å†è¿›è¡Œè§£é‡Šã€‚</p> <h2 id="å¤§è‡´è¿‡ç¨‹"><a href="#å¤§è‡´è¿‡ç¨‹" class="header-anchor">#</a> å¤§è‡´è¿‡ç¨‹</h2> <p>æˆ‘ä»¬å…ˆæ¥æŠŠæ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹è¿›è¡Œä¸€ä¸ªç²—ç•¥çš„ä»‹ç»ï¼Œæˆ‘ä»¬åœ¨æ¸²æŸ“é¡µé¢æ—¶ï¼Œä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç </p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> root <span class="token operator">=</span> ReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
root<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ†ä¸ºäº†ä»¥ä¸‹ä¸¤ä¸ªä¸»è¦è¿‡ç¨‹ï¼š</p> <ol><li><code>createRoot</code></li> <li><code>render</code></li></ol> <h3 id="createroot"><a href="#createroot" class="header-anchor">#</a> <code>createRoot</code></h3> <p>ä¸Šé¢çš„<code>createRoot</code>ä¼šåˆ›å»ºä¸€ä¸ª<code>FiberRootNode</code></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>
    container<span class="token punctuation">,</span>
    ConcurrentRoot<span class="token punctuation">,</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    isStrictMode<span class="token punctuation">,</span>
    concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span>
    identifierPrefix<span class="token punctuation">,</span>
    onRecoverableError<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>
  <span class="token parameter">containerInfo<span class="token punctuation">,</span>
  tag<span class="token punctuation">,</span>
  hydrationCallbacks<span class="token punctuation">,</span>
  isStrictMode<span class="token punctuation">,</span>
  concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span>
  identifierPrefix<span class="token punctuation">,</span>
  onRecoverableError<span class="token punctuation">,</span>
  transitionCallbacks<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hydrate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> initialChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>
    containerInfo<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    hydrate<span class="token punctuation">,</span>
    initialChildren<span class="token punctuation">,</span>
    hydrationCallbacks<span class="token punctuation">,</span>
    isStrictMode<span class="token punctuation">,</span>
    concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span>
    identifierPrefix<span class="token punctuation">,</span>
    onRecoverableError<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>
  <span class="token parameter">containerInfo<span class="token punctuation">,</span>
  tag<span class="token punctuation">,</span>
  hydrate<span class="token punctuation">,</span>
  initialChildren<span class="token punctuation">,</span>
  hydrationCallbacks<span class="token punctuation">,</span>
  isStrictMode<span class="token punctuation">,</span>
  concurrentUpdatesByDefaultOverride<span class="token punctuation">,</span>
  identifierPrefix<span class="token punctuation">,</span>
  onRecoverableError<span class="token punctuation">,</span>
  transitionCallbacks<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>
    containerInfo<span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>
    hydrate<span class="token punctuation">,</span>
    identifierPrefix<span class="token punctuation">,</span>
    onRecoverableError<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> isStrictMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>
  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢ä»£ç çš„å¤§è‡´æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-13.2d32b932.png" alt="alt text"></p> <p>æ‰§è¡Œå®Œæˆåï¼Œä¼šåˆ›å»ºä¸€ä¸ª<code>FiberRootNode</code>ï¼Œä¿å­˜åœ¨<code>ReactDomRoot</code>å®ä¾‹çš„<code>this._internalRoot</code>ä¸­ï¼Œå……å½“ <code>React</code> çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒä¿å­˜ç€æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€çš„å…ƒæ•°æ®ã€‚å…¶ <code>current</code> å±æ€§æŒ‡å‘å®é™…çš„ <code>Fiber</code> æ ‘ç»“æ„ï¼Œæ¯æ¬¡æ„å»ºæ–°çš„ <code>Fiber</code> æ ‘æ—¶ï¼Œå®ƒéƒ½ä¼šå°† <code>current</code> é‡æ–°æŒ‡å‘æ–°çš„ <code>HostRoot</code>ã€‚ç”Ÿæˆå¦‚ä¸‹<code>FiberTree</code>ç»“æ„ï¼š
<img src="/knowledge/assets/img/image-8.3b77527a.png" alt="alt text"></p> <p>å½“å‰çš„<code>root</code>å±æ€§å¦‚ä¸‹ï¼š</p> <p><img src="/knowledge/assets/img/image-4.1070aed8.png" alt="alt text"></p> <p>ä¸Šå›¾ä¸­çš„<code>root</code>ä¸ºå½“å‰<code>ReactDOMRoot</code>çš„å®ä¾‹ï¼Œå†…éƒ¨<code>_internalRoot</code>ä¸ºå½“å‰å®ä¾‹çš„<code>FiberRootNode</code>ï¼Œå…¶<code>current</code>æŒ‡å‘å½“å‰é¡µé¢çš„<code>FiberNode</code>èŠ‚ç‚¹ã€‚å…¶ä¸­<code>tag</code>çš„å€¼ä¸º<code>3</code>ï¼Œè¡¨ç¤º<code>FiberNode</code>çš„èŠ‚ç‚¹ç±»å‹ä¸º<code>HostRoot</code>ã€‚</p> <p><img src="/knowledge/assets/img/image-5.2a498547.png" alt="alt text"></p> <h3 id="render"><a href="#render" class="header-anchor">#</a> render</h3> <p>åœ¨<code>render</code>è¿‡ç¨‹ä¸­ä¸»è¦æ‰§è¡Œäº†ä¸‹é¢å†…å®¹ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// some other code...</span>
  <span class="token keyword">var</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">element</span><span class="token operator">:</span> element<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current$1<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿›å…¥è°ƒåº¦å™¨ schedule</span>
    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current$1<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoLanes <span class="token operator">&amp;&amp;</span>
    root <span class="token operator">===</span> workInProgressRoot
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// some code...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç¡®ä¿FiberRootNodeè¢«è°ƒåº¦</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// some code...</span>
  <span class="token comment">// è·å–æ›´æ–°ä¼˜å…ˆçº§ï¼Œæ‹¿å–æœ€é«˜çº§åˆ«çš„ä¼˜å…ˆçº§ä»»åŠ¡è¿›è¡Œæ‰§è¡Œ</span>
  <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
  <span class="token function">commitRoot</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span>
    workInProgressRootRecoverableErrors<span class="token punctuation">,</span>
    workInProgressTransitions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‹é¢çš„æµç¨‹å›¾ï¼š
<img src="/knowledge/assets/img/image-6.090ed020.png" alt="alt text"></p> <p>å…¶ä¸­<code>scheduleUpdateOnFiber</code>ã€<code>ensureRootIsScheduled</code>ä»¥åŠ<code>scheduleSyncCallback</code>éƒ½æ˜¯è°ƒåº¦ç›¸å…³çš„å‡½æ•°ï¼Œæœ¬ç« çš„é‡ç‚¹æ˜¯æ¸²æŸ“ï¼Œå…ˆæš‚æ—¶è·³è¿‡è¿™äº›å†…å®¹ï¼ŒåæœŸè°ƒåº¦ç›¸å…³ä¼šè¯¦ç»†è®²è§£ã€‚æ¸²æŸ“ç›¸å…³çš„æ ¸å¿ƒå‡½æ•°ä¸º<code>performSyncWorkOnRoot</code>ï¼Œä»¥åŠ<code>performConcurrentWorkOnRoot</code>å‡½æ•°ï¼Œ<code>performSyncWorkOnRoot</code>ä¸º<strong>åŒæ­¥æ¨¡å¼</strong>ï¼Œ<code>performConcurrentWorkOnRoot</code>ä¸º<strong>å¹¶å‘æ¨¡å¼</strong></p> <h4 id="åŒæ­¥æ¨¡å¼"><a href="#åŒæ­¥æ¨¡å¼" class="header-anchor">#</a> åŒæ­¥æ¨¡å¼</h4> <div class="language-text extra-class"><pre class="language-text"><code>performSyncWorkOnRoot
    â†“
renderRootSync  // åŒæ­¥æ¸²æŸ“æ ¹èŠ‚ç‚¹
    â†“
workLoopSync    // åŒæ­¥å·¥ä½œå¾ªç¯ï¼ˆä¸å¯ä¸­æ–­ï¼‰
    â†“
completeUnitWork // å®Œæˆå•å…ƒå·¥ä½œ
    â†“
commitRoot      // æäº¤å˜æ›´åˆ°DOM
</code></pre></div><h4 id="å¹¶å‘æ¨¡å¼"><a href="#å¹¶å‘æ¨¡å¼" class="header-anchor">#</a> å¹¶å‘æ¨¡å¼</h4> <div class="language-text extra-class"><pre class="language-text"><code>performConcurrentWorkOnRoot
    â†“
renderRootConcurrent  // å¹¶å‘æ¸²æŸ“æ ¹èŠ‚ç‚¹
    â†“
workLoopConcurrent    // å¹¶å‘å·¥ä½œå¾ªç¯ï¼ˆå¯ä¸­æ–­ï¼‰
    â†“
shouldYield? â†’ æ˜¯ â†’ æš‚åœå¹¶è¿”å›
    â†“
completeUnitWork
    â†“
commitRoot
</code></pre></div><p>ä¸Šé¢çš„åŒæ­¥æ¨¡å¼ä¸å¹¶å‘æ¨¡å¼çš„ä¸»è¦åŒºåˆ«ä¸ºæ¸²æŸ“æ ¹èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œ<strong>åŒæ­¥æ¨¡å¼</strong>åˆ›å»º<code>FiberTree</code>çš„è¿‡ç¨‹<strong>ä¸å¯ä¸­æ–­</strong>ï¼Œ<strong>å¹¶å‘æ¨¡å¼</strong>åˆ™å¯ä»¥è¢«<strong>é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¸­æ–­</strong>ï¼Œè€Œ<code>commitRoot</code>è¿‡ç¨‹åˆ™æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯åŒæ­¥æ‰§è¡Œã€‚</p> <p>ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°<code>render</code>å‡½æ•°ä¸­æ‰§è¡Œäº†<code>renderRootSync</code>ä¸<code>commitRoot</code>ä¸¤ä¸ªå‡½æ•°ï¼Œä¹Ÿæ˜¯<code>React</code>ä¸­æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º<code>FiberNode</code>ä»¥åŠå¯¹åº”çš„<code>stateNode</code>ã€<code>flags</code>ã€<code>subtreeFlags</code>,å¹¶ç”Ÿæˆ<code>FiberTree</code>ï¼Œå¦ä¸€ä¸ªæ˜¯æ ¹æ®å‰é¢åˆ›å»ºçš„<code>FiberTree</code>ï¼Œè·å–å¯¹åº”èŠ‚ç‚¹çš„<code>flags</code>ä»¥åŠ<code>subtreeFlags</code>æ¥è¿›è¡Œå¯¹åº”çš„<code>DOM</code>èŠ‚ç‚¹æŒ‚è½½æ“ä½œã€‚</p> <p>ğŸ“¢ æ³¨æ„ï¼šç”±äº<code>commitRoot</code>æ˜¯<strong>ä¸€æ¬¡æ‰§è¡Œå®Œæˆçš„æŒ‚è½½è¿‡ç¨‹</strong>ï¼Œä¸ºäº†é¿å…æµè§ˆå™¨äº§ç”Ÿé—ªçƒä»¥åŠé‡ç»˜ç­‰ï¼Œ<code>React</code>å†…éƒ¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨<code>render</code>çš„<code>complete</code>é˜¶æ®µï¼Œå°±å°†å­æ ‘çš„æ•´ä¸ª<code>DOM</code>æ ‘æ„å»ºå®Œæˆäº†ï¼Œå¹¶å°†å…¶å¯¹åº”çš„<code>flags</code>å†’æ³¡åˆ°çˆ¶èŠ‚ç‚¹çš„<code>subtreeFlags</code>å±æ€§ä¸­ï¼Œåç»­åœ¨<code>commit</code>é˜¶æ®µç›´æ¥æ¯”è¾ƒè¯¥å±æ€§è¿›è¡Œç›¸åº”çš„å­æ ‘æŒ‚è½½å³å¯ã€‚ä¸‹é¢ä¼šè¿›è¡Œè¯¦ç»†çš„è§£æï¼š</p> <h4 id="renderrootsync"><a href="#renderrootsync" class="header-anchor">#</a> renderRootSync</h4> <p>åœ¨<code>renderRootSync</code>å‡½æ•°ä¸­çš„æ ¸å¿ƒä¸º<code>do...while(true)</code>çš„æ‰§è¡Œ<code>workLoopSync</code>å‡½æ•°</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">return</span> workInProgressRootExitStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  workInProgressRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token keyword">var</span> rootWorkInProgress <span class="token operator">=</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  workInProgress <span class="token operator">=</span> rootWorkInProgress<span class="token punctuation">;</span>
  <span class="token function">finishQueueingConcurrentUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> rootWorkInProgress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> pendingProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> workInProgress <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We use a double buffering pooling technique because we know that we'll</span>
    <span class="token comment">// only ever need at most two versions of a tree. We pool the &quot;other&quot; unused</span>
    <span class="token comment">// node that we're free to reuse. This is lazily created to avoid allocating</span>
    <span class="token comment">// extra objects for things that are never updated. It also allow us to</span>
    <span class="token comment">// reclaim the extra memory if needed.</span>
    <span class="token comment">// åŒç¼“å­˜æœºåˆ¶ï¼Œåˆ›å»º alternate</span>
    workInProgress <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>
      current<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
      pendingProps<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">=</span> current<span class="token punctuation">.</span>elementType<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>type <span class="token operator">=</span> current<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

    workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span>
    current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgress<span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>type <span class="token operator">=</span> current<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>flags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>subtreeFlags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>deletions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  workInProgress<span class="token punctuation">.</span>flags <span class="token operator">=</span> current<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> StaticMask<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>childLanes <span class="token operator">=</span> current<span class="token punctuation">.</span>childLanes<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>lanes <span class="token operator">=</span> current<span class="token punctuation">.</span>lanes<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> current<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>

  <span class="token keyword">var</span> currentDependencies <span class="token operator">=</span> current<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>sibling <span class="token operator">=</span> current<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>index <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>ref <span class="token operator">=</span> current<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>

  <span class="token keyword">return</span> workInProgress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">unitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token function">setCurrentFiber</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> next<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ProfileMode<span class="token punctuation">)</span> <span class="token operator">!==</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">resetCurrentFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  unitOfWork<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ReactCurrentOwner$2<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä¸»è¦å®ç°äº†ä¸¤éƒ¨åˆ†é‡è¦å†…å®¹ï¼š</p> <ul><li>1.åˆ›å»º<code>workInProgress</code>ï¼š<code>prepareFreshStack</code>å‡½æ•°å°†å½“å‰<code>FiberRootNode</code>ç±»å‹çš„èŠ‚ç‚¹ä¼ å…¥ï¼Œä½¿ç”¨å…¶<code>root.current</code>å±æ€§åˆ›å»º<code>workInProgress</code>ï¼Œ<code>root.current</code>ä¸ºå½“å‰å®¹å™¨çš„<code>FiberNode</code>èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯<code>FiberNode(HostRoot)</code></li> <li>2.å¼€å¯å·¥ä½œå¾ªç¯ï¼š<code>workLoopSync</code>ä»¥åŠ<code>performUnitOfWork</code>å‡½æ•°å®ç°äº†å¯¹<code>FiberTree</code>çš„åˆ›å»ºï¼Œå…¶ä¸­<code>beginWork</code>æ˜¯åˆ›å»º<code>FiberNode</code>ï¼Œ<code>completeUnitOfWork</code>ä¸ºåˆ›å»º<code>stateNode</code>å¹¶æ„å»ºä»¥å½“å‰èŠ‚ç‚¹ä¸ºæ ¹ç»“ç‚¹çš„<code>DOM</code>æ ‘çš„è¿‡ç¨‹ã€‚</li></ul> <p>æ‰§è¡Œå®Œä¸Šé¢çš„å†…å®¹åï¼Œå½“å‰å†…å­˜ä¸­çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-14.21f91550.png" alt="alt text"></p> <h5 id="workloopsync"><a href="#workloopsync" class="header-anchor">#</a> workLoopSync</h5> <p>ä¸‹é¢æ˜¯<code>beginWork</code>å‡½æ•°çš„ä¸»è¦å†…å®¹ï¼Œä¸»è¦å°±æ˜¯æ ¹æ®<code>fiberNode</code>çš„<code>tag</code>å€¼æ‰§è¡Œä¸åŒçš„æ–¹æ³•</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IndeterminateComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">var</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">var</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token literal-property property">HostText</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">var</span> prevState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">var</span> prevChildren <span class="token operator">=</span> prevState<span class="token punctuation">.</span>element<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextChildren <span class="token operator">=</span> nextState<span class="token punctuation">.</span>element<span class="token punctuation">;</span>

  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è®©æˆ‘ä»¬ä»å¤´è¿›å…¥è¯¥å‡½æ•°ï¼Œäº†è§£ä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹ï¼Œç°åœ¨ä½¿ç”¨äº†å¦‚ä¸‹çš„ç»“æ„è¿›è¡Œæ¸²æŸ“ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">A</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">A</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">B</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">A</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">App</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="beginwork-é˜¶æ®µ"><a href="#beginwork-é˜¶æ®µ" class="header-anchor">#</a> beginWork é˜¶æ®µ</h4> <h5 id="ç¬¬ä¸€æ¬¡-workloop"><a href="#ç¬¬ä¸€æ¬¡-workloop" class="header-anchor">#</a> <strong>ç¬¬ä¸€æ¬¡ workLoop</strong></h5> <p>å‡½æ•°æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/react-begin-loop1.e4e600cb.png" alt="alt text"></p> <p>è¿™æ˜¯ç¬¬ä¸€æ¬¡<code>workLoop</code>å¾ªç¯ï¼Œå½“å‰çš„<code>workInProgress === FiberNode(HostRoot)</code>ï¼Œè¿›å…¥<code>beginWork</code>å‡½æ•°ï¼Œæ ¹æ®å½“å‰<code>tag === 3</code>ï¼Œè¿›å…¥<code>updateHostRoot</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥<code>reconcileChildren</code>å‡½æ•°ä¸­ï¼Œæ­¤æ—¶ï¼Œä¼šå°† <code>root.render(&lt;App /&gt;)</code>ä»£ç ä¸­çš„<code>&lt;App /&gt;</code>å‡½æ•°ç»„ä»¶ï¼Œç»è¿‡<code>babel</code>ç¼–è¯‘åçš„<code>ReactElement</code>å¯¹è±¡ä½œä¸º<code>nextChildren</code>ä¼ å…¥<code>reconcileChildFibers</code>ä½œä¸ºå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸ºæ‰§è¡Œ<code>ChildReconciler(true)</code>åè¿”å›çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>ChildReconciler</code>å‡½æ•°ä¸­çš„é—­åŒ…<code>reconcileChildFibers</code>å‡½æ•°ï¼Œå…¶ä¸­<code>shouldTrackSideEffects</code>å‚æ•°ä¸º<code>true</code>ã€‚åé¢ç»§ç»­è¿›å…¥<code>reconcileSingleElement</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»º<code>FiberNode(&lt;App /&gt;)</code>ï¼Œå¹¶å°†å…¶<code>return</code>å±æ€§ï¼ŒæŒ‡å‘å½“å‰<code>FiberNode(HostRoot)</code>ã€‚åç»­å°†å½“å‰æ–°åˆ›å»ºçš„<code>FiberNode(&lt;App /&gt;)</code>ä½œä¸ºå‚æ•°ä¼ å…¥<code>placeSingleChild</code>å‡½æ•°ï¼Œæ·»åŠ <code>flags</code>ï¼Œå…¶<code>shouldTrackSideEffects === true</code>ï¼Œåˆ™<code>FiberNode(&lt;App /&gt;).flags === Placement</code>ï¼Œæ‰§è¡Œåˆ°å½“å‰çš„å†…å­˜æ•°æ®æ¥å£å¦‚ä¸‹ï¼š</p> <p><img src="/knowledge/assets/img/image-17.1a0fbf7b.png" alt="alt text"></p> <p>ç„¶åä»<code>placeSingleChild</code>ä¾æ¬¡ä»è°ƒç”¨æ ˆä¸­è¿›è¡Œè¿”å›ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯åœ¨<code>reconcileChildren</code>å‡½æ•°ä¸­ï¼Œå°†<code>workInProgress.child</code>å±æ€§æŒ‡å‘äº†æ–°åˆ›å»ºçš„<code>FiberNode(&lt;App /&gt;)</code>èŠ‚ç‚¹ã€‚æ­¤æ—¶ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-18.fe10bc6d.png" alt="alt text"></p> <p>ç„¶ååœ¨<code>performUnitOfWork</code>å‡½æ•°ä¸­ï¼Œå°†<code>workInProgress</code>æŒ‡å‘äº†<code>FiberNode(&lt;App /&gt;)</code>èŠ‚ç‚¹ã€‚æ­¤æ—¶ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-19.d89377c2.png" alt="alt text"></p> <h5 id="ç¬¬äºŒæ¬¡-workloop"><a href="#ç¬¬äºŒæ¬¡-workloop" class="header-anchor">#</a> <strong>ç¬¬äºŒæ¬¡ workLoop</strong></h5> <p>æ­¤æ—¶è¿›å…¥ä¸‹ä¸€æ¬¡<code>workLoopSync</code>å¾ªç¯ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/react-work-loop2.618477c7.png" alt="alt text"></p> <p>å½“å‰å¾ªç¯ä¸ä¸Šä¸€æ¬¡å¾ªç¯ä¸åŒä¹‹å¤„åœ¨äºï¼Œæ­¤æ—¶çš„<code>FiberNode(&lt;App /&gt;).tag === IndeterminateComponent</code>å¹¶ä¸”æ­¤æ—¶<code>workInProgress</code>çš„<code>current</code>ä¸º<code>null</code>ï¼Œäºæ˜¯è¿›å…¥<code>mountIndeterminateComponent</code>å‡½æ•°ï¼Œå°†è¯¥<code>FiberNode&lt;App /&gt;.tag</code>ä¿®æ”¹ä¸º<code>FunctionComponent</code>ï¼Œç„¶åç»§ç»­æ‰§è¡Œ<code>renderWithHooks</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…ï¼Œå¦‚æœæ˜¯å‡½æ•°ç»„ä»·ï¼Œåˆ™è·å–å…¶<code>type</code>ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æ¥è¿›è¡Œæ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆåçš„è¿”å›å€¼ï¼Œä¼ å…¥<code>reconcileChildren</code>å‡½æ•°å†…ï¼Œç”±äº<code>current === null</code>ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>mountChildFibers</code>å‡½æ•°ï¼Œåˆ›å»º<code>FiberNode(&lt;A /&gt;)</code>ï¼Œå½“å‰æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-22.32c1a5f7.png" alt="alt text"></p> <p>åœ¨å‡½æ•°è¿”å›åé€æ¸è¿”å›è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œå¹¶åœ¨<code>reconcileChildren</code>å‡½æ•°ä¸­å°†<code>workInProgress.child</code>æŒ‡å‘å½“å‰æ–°çš„ç»“ç‚¹<code>FiberNode(&lt;A /&gt;)</code>ï¼Œå¹¶åœ¨<code>performUnitOfWork</code>å‡½æ•°ä¸­å°†å½“å‰æ–°åˆ›å»ºçš„ç»“ç‚¹æŒ‡å‘<code>workInProgress</code>ï¼Œå½“å‰æ•°æ®ç»“æ„å¦‚ä¸‹:
<img src="/knowledge/assets/img/image-23.365039a6.png" alt="alt text"></p> <h5 id="ç¬¬ä¸‰æ¬¡-workloop"><a href="#ç¬¬ä¸‰æ¬¡-workloop" class="header-anchor">#</a> <strong>ç¬¬ä¸‰æ¬¡ workLoop</strong></h5> <p>ç»§ç»­æ‰§è¡Œç¬¬ä¸‰æ¬¡<code>workLoop</code>å¾ªç¯ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/react-work-loop3.e7aa4899.png" alt="alt text">
å½“å‰å¾ªç¯ä¸ä¸Šæ¬¡å¾ªç¯è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œé™¤äº†ç”Ÿæˆçš„<code>FiberNode</code>çš„<code>tag === HostComponent</code>ç±»å‹ï¼Œè¿™æ˜¯åœ¨<code>createFiberFromTypeAndProps</code>å‡½æ•°ä¸­æ ¹æ®å½“å‰çš„<code>type</code>å€¼å†³å®šçš„ï¼Œå½“å‰<code>type === div</code>ï¼Œè¡¨ç¤ºä¸º<strong>å®¿ä¸»ç»„ä»¶</strong>ï¼Œåˆ™å°†<code>tag = HostComponent</code>ï¼Œå½“å‰æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-24.907a1911.png" alt="alt text">
ä¾æ¬¡è¿”å›è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œæœ¬è½®å¾ªç¯æ‰§è¡Œå®Œæˆåæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-25.429d7779.png" alt="alt text"></p> <h5 id="ç¬¬å››æ¬¡-workloop"><a href="#ç¬¬å››æ¬¡-workloop" class="header-anchor">#</a> <strong>ç¬¬å››æ¬¡ workLoop</strong></h5> <p><img src="/knowledge/assets/img/react-work-loop4.cce3e72b.png" alt="alt text"></p> <p>ç¬¬å››æ¬¡å¾ªç¯æµç¨‹å¦‚ä¸Šå›¾ ğŸ‘†ğŸ»ï¼Œå½“å‰<code>workInProgress === FiberNode(div)</code>ï¼Œåˆ™åœ¨<code>beginWork</code>å‡½æ•°ä¸­æ ¹æ®<code>tag === HostComponent</code>ï¼Œä¼šè¿›å…¥<code>updateHostComponent</code>å‡½æ•°ï¼Œ<code>babel</code>åœ¨ç¼–è¯‘æ—¶å°†<code>HostComponent</code>ç»„ä»¶çš„å­å…ƒç´ ä½œä¸º<code>children</code>å±æ€§æ”¾åœ¨äº†å…¶<code>element.props</code>ä¸­ï¼Œç„¶åå†åˆ›å»º<code>FiberNode</code>æ—¶ï¼Œä¿å­˜åœ¨äº†<code>FiberNode(div).pendingProps</code>å±æ€§ä¸­ã€‚å¦‚ä¸‹ä»£ç ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> type <span class="token operator">=</span> element<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token keyword">var</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">var</span> pendingProps <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">var</span> fiber <span class="token operator">=</span> <span class="token function">createFiberFromTypeAndProps</span><span class="token punctuation">(</span>
    type<span class="token punctuation">,</span>
    key<span class="token punctuation">,</span>
    pendingProps<span class="token punctuation">,</span>
    owner<span class="token punctuation">,</span>
    mode<span class="token punctuation">,</span>
    lanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶åå†<code>updateHostComponent</code>ä¸­æ‰§è¡Œä¸‹é¢ä»£ç ï¼Œå°†å…¶å­å…ƒç´ ä¼ å…¥äº†<code>reconcileChildren</code>å‡½æ•°</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">var</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
<span class="token keyword">var</span> prevProps <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nextChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
</code></pre></div><p>æ‰§è¡Œåˆ°<code>reconcileChildFibers</code>å‡½æ•°å†…éƒ¨ï¼Œå‘ç°å…¶<code>isArray(newChild) === true</code>ï¼Œåˆ™æ‰§è¡Œäº†<code>reconcileChildrenArray</code>å‡½æ•°</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>
  <span class="token parameter">returnFiber<span class="token punctuation">,</span>
  currentFirstChild<span class="token punctuation">,</span>
  newChildren<span class="token punctuation">,</span>
  lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token keyword">var</span> lastPlacedIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>_newFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>_newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> _newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> _newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      previousNewFiber <span class="token operator">=</span> _newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆåçš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-27.d1d754c5.png" alt="alt text">
å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç”Ÿæˆäº†å¯¹åº”çš„<code>FiberNode(div-A)</code>èŠ‚ç‚¹ï¼Œä»¥åŠ<code>FiberNode(div-B)</code>èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶é€šè¿‡<code>sibling</code>å±æ€§è¿›è¡Œè¿æ¥ã€‚å¹¶ä¸”å®ƒä»¬çš„<code>return</code>èŠ‚ç‚¹éƒ½æŒ‡å‘äº†<code>FiberNode(div)</code>èŠ‚ç‚¹ã€‚</p> <p>åç»­ä¾æ¬¡è¿”å›è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œæœ¬è½®å¾ªç¯æ‰§è¡Œå®Œæˆåæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-29.faf15c54.png" alt="alt text"></p> <h5 id="ç¬¬äº”æ¬¡-workloop"><a href="#ç¬¬äº”æ¬¡-workloop" class="header-anchor">#</a> <strong>ç¬¬äº”æ¬¡ workLoop</strong></h5> <p>è¿›å…¥ç¬¬äº”æ¬¡<code>workLoop</code>å¾ªç¯ä¸­çš„<code>beginWork</code>å‡½æ•°ï¼Œå½“å‰<code>workInProgress === FiberNode(div-A)</code>ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/react-work-loop5.8d345559.png" alt="alt text">ï¼Œå¤§è‡´æµç¨‹ä¸ä¸Šæ¬¡å¾ªç¯ä¸€è‡´ï¼Œä¸åŒç‚¹ä¸ºæ²¡æœ‰å…¶å­å…ƒç´ ï¼Œå‡½æ•°è¿”å›çš„ä¸º<code>null</code>ï¼Œå…¶æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œäºæ˜¯è¿›å…¥<code>performUnitOfWork</code>å‡½æ•°ä¸­çš„<code>completeUnitOfWork</code>å‡½æ•°ã€‚å½“å‰å†…å­˜ä¸­æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-30.867c3b09.png" alt="alt text"></p> <p>ä¸Šé¢æ•´ä¸ª<code>beginWork</code>é˜¶æ®µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<img src="/knowledge/assets/img/beginWork.bb244227.png" alt="alt text"></p> <h4 id="completeunitofwork-é˜¶æ®µ"><a href="#completeunitofwork-é˜¶æ®µ" class="header-anchor">#</a> completeUnitOfWork é˜¶æ®µ</h4> <p>ä¸Šé¢çš„<code>beginWork</code>æ‰§è¡Œåˆ°<code>FiberNode(div-A)</code>èŠ‚ç‚¹åï¼Œè¿”å›çš„<code>workInProgress.child === null</code>ï¼Œè¡¨æ˜<code>FiberNode(div-A)</code>ä¸‹é¢æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šå°†<code>FiberNode(div-A)</code>èŠ‚ç‚¹ä¼ å…¥<code>completeUnitOfWork</code>å‡½æ•°ï¼Œè¿›å…¥<code>complete</code>é˜¶æ®µã€‚</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">unitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> completedWork <span class="token operator">=</span> unitOfWork<span class="token punctuation">;</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> current <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">var</span> returnFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>return<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>completedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Incomplete <span class="token operator">===</span> NoFlags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentFiber</span><span class="token punctuation">(</span>completedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> next <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

      next <span class="token operator">=</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> completedWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resetCurrentFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        workInProgress <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®¾ç½®çˆ¶èŠ‚ç‚¹çš„æ ‡è¯†ä¸º Incompleteï¼Œé‡ç½®å­æ ‘çš„æ ‡è¯†ä½ä¸º NoFlagsï¼Œåˆ é™¤çˆ¶èŠ‚ç‚¹çš„ deletions</span>
        returnFiber<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Incomplete<span class="token punctuation">;</span>
        returnFiber<span class="token punctuation">.</span>subtreeFlags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
        returnFiber<span class="token punctuation">.</span>deletions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> siblingFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>siblingFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      workInProgress <span class="token operator">=</span> siblingFiber<span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    completedWork <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
    workInProgress <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>completedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IndeterminateComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">LazyComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ForwardRef</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Fragment</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Mode</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Profiler</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ContextConsumer</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">MemoComponent</span><span class="token operator">:</span>
      <span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
      <span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">var</span> rootContainerInstance <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>
          type<span class="token punctuation">,</span>
          newProps<span class="token punctuation">,</span>
          rootContainerInstance<span class="token punctuation">,</span>
          workInProgress<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">appendAllChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">bubbleProperties</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">var</span> prevProps <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>children<span class="token punctuation">;</span>

  <span class="token keyword">var</span> isDirectTextChild <span class="token operator">=</span> <span class="token function">shouldSetTextContent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirectTextChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> NoLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">appendAllChildren</span><span class="token punctuation">(</span>
  <span class="token parameter">parent<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  needsVisibilityToggle<span class="token punctuation">,</span>
  isHidden<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> node <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ·±åº¦ä¼˜å…ˆéå†ï¼Œæ‰¾åˆ°ç±»å‹æ˜¯ HostComponent æˆ– HostText çš„èŠ‚ç‚¹ï¼Œæ‰å¹¶å°†å…¶æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹ä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">appendInitialChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœå­èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™å°†å­èŠ‚ç‚¹çš„ return æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼Œç„¶åç»§ç»­éå†å­èŠ‚ç‚¹</span>
      node<span class="token punctuation">.</span>child<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">;</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œåˆ™ç»§ç»­éå†çˆ¶èŠ‚ç‚¹</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸€ç›´å¾€åæ’å…¥å­å…ƒç´ </span>
<span class="token keyword">function</span> <span class="token function">appendInitialChild</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  parentInstance<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="loop1"><a href="#loop1" class="header-anchor">#</a> Loop1</h5> <p><img src="/knowledge/assets/img/complete1.60aa0b73.png" alt="alt text"></p> <p>æ‰§è¡Œå®Œæˆåå½“å‰çš„å†…å­˜æ•°æ®ç»“æ„å¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/complete-data1.ca236f72.png" alt="alt text"></p> <h5 id="loop2"><a href="#loop2" class="header-anchor">#</a> Loop2</h5> <p>ä¸Šé¢ä»£ç ä¹‹å‰å®Œæˆä¹‹åï¼Œä¼šè¿›å…¥<code>completeUnitOfWork</code>å‡½æ•°ä¸­çš„ä¸‹é¢ä»£ç ï¼Œè·å–å½“å‰èŠ‚ç‚¹çš„å…„å¼Ÿå…ƒç´ ï¼Œå¦‚æœå­˜åœ¨å…„å¼Ÿå…ƒç´ ï¼Œèµ‹å€¼ç»™<code>workInProgress</code>å˜é‡ï¼Œé‡æ–°è¿›å…¥<code>beginWork</code>é˜¶æ®µï¼Œæ‰§è¡Œåå…¶<code>workInProgress.child === null</code>ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ<code>completeUnitOfWork</code>å‡½æ•°ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">var</span> siblingFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>siblingFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress <span class="token operator">=</span> siblingFiber<span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/complete2.35a39b31.png" alt="alt text"></p> <p>å†…å­˜ä¸­æ•°æ®æ¨¡å‹å¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/image-31.90bffc8e.png" alt="alt text"></p> <p>æ‰§è¡Œå®Œæˆ<code>completeWork</code>çš„<code>FiberNode(div-B)</code>èŠ‚ç‚¹åï¼Œå‘ç°å…¶æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œåˆ™è¿›å…¥å¦‚ä¸‹ä»£ç ï¼Œè·å–å…¶å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ<code>do...while</code>å¾ªç¯ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> returnFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  completedWork <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  workInProgress <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>completedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å…¶æµç¨‹å›¾å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/complete3.e376aee7.png" alt="alt text"></p> <p>è¿™ä¸ªè¿‡ç¨‹éœ€è¦æ³¨æ„ ğŸ“¢ çš„æ˜¯ï¼Œåœ¨<code>appendAllChildren</code>å‡½æ•°ä¸­ï¼Œä¼šå°†å…¶<code>child</code>ä»¥åŠå…¶æ‰€æœ‰å…„å¼Ÿå…ƒç´ æ’å…¥åˆ°å½“å‰<code>FiberNode(div)</code>çš„<code>DOM</code>ä¸­ï¼Œä¹Ÿå°±æ˜¯ï¼Œä¼šå°†<code>FiberNode(div-A)</code>ä»¥åŠ<code>FiberNode(div-B)</code>çš„<code>DOM</code>èŠ‚ç‚¹éƒ½æ’å…¥è¿›å»ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„ï¼Œä¼šæ„å»ºä»¥å½“å‰èŠ‚ç‚¹ä¸º<strong>æ ¹èŠ‚ç‚¹</strong>çš„å®Œæ•´<code>DOM</code>æ ‘ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¼šæ‰§è¡Œ<code>bubbleProperties</code>å‡½æ•°ï¼Œå°†å…¶å­èŠ‚ç‚¹çš„<code>flags</code>å±æ€§åˆå¹¶åˆ°å½“å‰èŠ‚ç‚¹çš„<code>subtreeFlags</code>å±æ€§ä¸­ã€‚</p> <p>å†…å­˜ä¸­æ•°æ®æ¨¡å‹å¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/image-32.bea0f602.png" alt="alt text"></p> <p>å®Œæˆå½“å‰èŠ‚ç‚¹<code>FiberNode(div)</code>çš„<code>complete</code>èŠ‚ç‚¹ï¼Œå‘ç°å…¶æ²¡æœ‰<code>sibling</code>èŠ‚ç‚¹ï¼Œåˆ™ç»§ç»­è·å–å…¶çˆ¶èŠ‚ç‚¹<code>returnFiber</code>ç»§ç»­æ‰§è¡Œ<code>completeWork</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ ¹æ®ç±»å‹åˆ¤æ–­ä¸º<code>FunctionComponent</code>ï¼Œåˆ™è¿›å…¥<code>bubbleProperties</code>å‡½æ•°ã€‚è¿™æ˜¯ä¸ä¸Šé¢çš„æœ€å¤§åŒºåˆ«ï¼Œä¸Šé¢æ‰§è¡Œæ—¶èµ·<code>FiberNode</code>çš„ç±»å‹ä¸º<code>HostComponent</code>ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ›å»ºä»¥åŠæ’å…¥<code>DOM</code>æ“ä½œï¼Œè€Œ<code>FunctionComponent</code>ç±»å‹æ˜¯åœ¨<code>react</code>ä¸­å®šä¹‰çš„ç»„ä»¶ç±»å‹ï¼Œæ²¡æœ‰å¯¹åº”çš„å®¿ä¸»å…ƒç´ ï¼Œåªéœ€è¦æ‰§è¡Œ<code>bubbleProperties</code>å‡½æ•°å³å¯ï¼Œä¹Ÿå°±æ˜¯å°†å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„å±æ€§å†’æ³¡åˆ°å½“å‰èŠ‚ç‚¹ä¸­ï¼Œæ–¹ä¾¿åœ¨åç»­<code>commit</code>é˜¶æ®µå¯¹çˆ¶èŠ‚ç‚¹çš„å±æ€§è¿›è¡Œå¯¹æ¯”ï¼Œç›´æ¥æŒ‚è½½æ•´ä¸ª<code>DOM</code>æ ‘ï¼Œå‡å°‘å¯¹<code>FiberTree</code>çš„éå†æ“ä½œã€‚</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">bubbleProperties</span><span class="token punctuation">(</span><span class="token parameter">completedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> didBailout <span class="token operator">=</span>
    completedWork<span class="token punctuation">.</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    completedWork<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child <span class="token operator">===</span> completedWork<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token keyword">var</span> newChildLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">var</span> subtreeFlags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>didBailout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>completedWork<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ProfileMode<span class="token punctuation">)</span> <span class="token operator">!==</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newChildLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>
          newChildLanes<span class="token punctuation">,</span>
          <span class="token function">mergeLanes</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> child<span class="token punctuation">.</span>childLanes<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        subtreeFlags <span class="token operator">|=</span> child<span class="token punctuation">.</span>subtreeFlags<span class="token punctuation">;</span>
        subtreeFlags <span class="token operator">|=</span> child<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
        child <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      completedWork<span class="token punctuation">.</span>actualDuration <span class="token operator">=</span> actualDuration<span class="token punctuation">;</span>
      completedWork<span class="token punctuation">.</span>treeBaseDuration <span class="token operator">=</span> treeBaseDuration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _child <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>child<span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>_child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newChildLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>
          newChildLanes<span class="token punctuation">,</span>
          <span class="token function">mergeLanes</span><span class="token punctuation">(</span>_child<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> _child<span class="token punctuation">.</span>childLanes<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        subtreeFlags <span class="token operator">|=</span> _child<span class="token punctuation">.</span>subtreeFlags<span class="token punctuation">;</span>
        subtreeFlags <span class="token operator">|=</span> _child<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

        _child<span class="token punctuation">.</span>return <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
        _child <span class="token operator">=</span> _child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  completedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">|=</span> subtreeFlags<span class="token punctuation">;</span>

  completedWork<span class="token punctuation">.</span>childLanes <span class="token operator">=</span> newChildLanes<span class="token punctuation">;</span>
  <span class="token keyword">return</span> didBailout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æµç¨‹å›¾å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-33.8ccbbde5.png" alt="alt text"></p> <p>å½“å‰å†…å­˜æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-3.fc31c302.png" alt="alt text"></p> <p>å®Œæˆå½“å‰èŠ‚ç‚¹<code>FiberNode(A)</code>çš„<code>complete</code>èŠ‚ç‚¹ï¼Œå‘ç°å…¶æ²¡æœ‰<code>sibling</code>èŠ‚ç‚¹ï¼Œåˆ™ç»§ç»­è·å–å…¶çˆ¶èŠ‚ç‚¹<code>returnFiber</code>ï¼Œå…¶çˆ¶èŠ‚ç‚¹ä¸º<code>FiberNode(App)</code>ï¼Œç»§ç»­æ‰§è¡Œ<code>completeWork</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ ¹æ®ç±»å‹åˆ¤æ–­ä¸º<code>FunctionComponent</code>ï¼Œåˆ™è¿›å…¥<code>bubbleProperties</code>å‡½æ•°ã€‚æµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <p><img src="/knowledge/assets/img/image-34.757017e5.png" alt="alt text">
ä¸ä¸Šé¢æµç¨‹ä¸åŒçš„æ˜¯ï¼Œå½“å‰çš„<code>FiberNode(App)</code>åœ¨<code>beginWork</code>é˜¶æ®µåˆ›å»º<code>FiberNode</code>æ—¶ï¼Œæ‰§è¡Œäº†ä¸‹é¢ä»£ç ï¼Œå°†å…¶<code>flags</code>è®¾ç½®ä¸ºäº†<code>Placement</code></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// This is simpler for the single child case. We only need to do a</span>
  <span class="token comment">// placement for inserting new children.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects <span class="token operator">&amp;&amp;</span> newFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newFiber<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Placement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newFiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰§è¡Œå®Œæˆåï¼Œå…¶å†…å­˜çš„æ•°æ®ç»“æ„å¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/image-35.45e0475c.png" alt="alt text"></p> <p>å®Œæˆå½“å‰èŠ‚ç‚¹<code>FiberNode(App)</code>çš„<code>complete</code>èŠ‚ç‚¹ï¼Œå‘ç°å…¶æ²¡æœ‰<code>sibling</code>èŠ‚ç‚¹ï¼Œåˆ™ç»§ç»­è·å–å…¶çˆ¶èŠ‚ç‚¹<code>returnFiber</code>ç»§ç»­æ‰§è¡Œ<code>completeWork</code>å‡½æ•°ï¼Œå…¶çˆ¶èŠ‚ç‚¹ä¸º<code>FiberNode(HostRoot)</code>ï¼Œåœ¨è¯¥å‡½æ•°å†…æ ¹æ®ç±»å‹åˆ¤æ–­ä¸º<code>HostRoot</code>ï¼Œç»§ç»­æ‰§è¡Œ<code>bubbleProperties</code>å‡½æ•°ã€‚</p> <p><img src="/knowledge/assets/img/image-36.1538a3b5.png" alt="alt text"></p> <p>æ­¤æ—¶å†…å­˜çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p> <p><img src="/knowledge/assets/img/image-7.e0b5497b.png" alt="alt text"></p> <p>å®Œæˆå½“å‰èŠ‚ç‚¹<code>FiberNode(HostRoot)</code>çš„<code>complete</code>èŠ‚ç‚¹ï¼Œå‘ç°å…¶æ²¡æœ‰<code>sibling</code>èŠ‚ç‚¹ï¼Œå°†å…¶<code>workInProgress</code>è®¾ç½®ä¸ºçˆ¶èŠ‚ç‚¹<code>returnFiber</code>ï¼Œå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹<code>return</code>ä¸º<code>null</code>ï¼Œåˆ™è·³å‡ºæ•´ä¸ª<code>workLoopSync</code>å¾ªç¯ï¼Œå®Œæˆäº†æ•´ä¸ª<code>render</code>é˜¶æ®µã€‚æ•´ä¸ª<code>complete</code>é˜¶æ®µçš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <p><img src="/knowledge/assets/img/render-complete.72899627.png" alt="alt text"></p> <h3 id="commit"><a href="#commit" class="header-anchor">#</a> commit</h3> <p>å®Œæˆ<code>render</code>é˜¶æ®µåï¼Œæ•´ä¸ª<code>FiberTree</code>è¢«æ„å»ºå®Œæˆï¼Œå¹¶ä¸”æ¯ä¸ª<code>FiberNode</code>èŠ‚ç‚¹éƒ½è¢«æ·»åŠ äº†å¯¹åº”éœ€è¦çš„å±æ€§ï¼Œå¦‚<code>stateNode</code>ï¼Œ<code>flags</code>ï¼Œ<code>subtreeFlags</code>ç­‰ç­‰ï¼Œè¿™äº›å±æ€§ä¼šåœ¨<code>commit</code>é˜¶æ®µè¢«ä½¿ç”¨åˆ°ã€‚</p> <p>ä¸‹é¢æ˜¯æäº¤é˜¶æ®µçš„ç›¸å…³ä»£ç ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> recoverableErrors<span class="token punctuation">,</span> transitions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">commitRootImpl</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> recoverableErrors<span class="token punctuation">,</span> transitions<span class="token punctuation">,</span> previousUpdateLanePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> recoverableErrors<span class="token punctuation">,</span> transitions<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token keyword">var</span> lanes <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedLanes

  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLane<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span>
    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> subtreeHasEffects <span class="token operator">=</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">;</span>
  <span class="token keyword">var</span> rootHasEffect <span class="token operator">=</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>subtreeHasEffects <span class="token operator">||</span> rootHasEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> committedLanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  inProgressLanes <span class="token operator">=</span> committedLanes<span class="token punctuation">;</span>
  inProgressRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token function">setCurrentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitMutationEffectsOnFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setCurrentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  inProgressLanes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  inProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitMutationEffectsOnFiber</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token punctuation">,</span> root<span class="token punctuation">,</span> lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> current <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">var</span> flags <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ForwardRef</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">MemoComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>
        <span class="token function">recursivelyTraverseMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">commitReconciliationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span>Insertion <span class="token operator">|</span> HasEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>return<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>Insertion <span class="token operator">|</span> HasEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>return<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>
        <span class="token function">recursivelyTraverseMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">commitReconciliationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token literal-property property">HostText</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>
        <span class="token function">recursivelyTraverseMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">commitReconciliationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>
        <span class="token function">recursivelyTraverseMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">commitReconciliationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>
        <span class="token function">recursivelyTraverseMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">commitReconciliationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåœ¨æ‰§è¡Œ<code>commitRoot</code>å‡½æ•°ä¹‹å‰ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿‡ç¨‹</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">var</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
</code></pre></div><p>å½“å‰å†…å­˜ä¸­çš„æ•°æ®æ¨¡å‹å¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/image-9.fe73d616.png" alt="alt text"></p> <p>ä»ä¸Šé¢æ•°æ®æ¨¡å‹å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥<code>recursivelyTraverseMutationEffects</code>å‡½æ•°çš„å‚æ•°ä¸º<code>root === FiberRootNode</code>ï¼Œ<code>parentFiber === finishedWork === FiberNode(HostRoot)</code>ï¼Œè¯¥å‡½æ•°å¦‚ä¸‹ï¼š</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">recursivelyTraverseMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> parentFiber<span class="token punctuation">,</span> lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...other code</span>
  <span class="token keyword">var</span> prevDebugFiber <span class="token operator">=</span> <span class="token function">getCurrentFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> MutationMask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> child <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentFiber</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">commitMutationEffectsOnFiber</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      child <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">setCurrentFiber</span><span class="token punctuation">(</span>prevDebugFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å‡½æ•°<code>recursivelyTraverseMutationEffects</code>ä¸­çš„å†…å®¹ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­å½“å‰<code>finishedWork</code>ä¸­çš„<code>subtreeFlags</code>æ ‡è¯†ä½ä¸­æ˜¯å¦åŒ…å«æŒ‚è½½æ ‡è¯†ï¼Œå¦‚æœåŒ…å«ï¼Œåˆ™ç»§ç»­è°ƒç”¨<code>commitMutationEffectsOnFiber</code>å‡½æ•°ï¼Œå¯¹æ•´ä¸ª<code>FiberTree</code>è¿›è¡Œéå†æ“ä½œã€‚å½“å‰æµç¨‹å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-10.ffe14f6c.png" alt="alt text"></p> <p>ç»§ç»­è°ƒç”¨<code>commitMutationEffectsOnFiber</code>å‡½æ•°ï¼Œç»§ç»­æ‰§è¡Œ<code>recursivelyTraverseMutationEffects</code>å‡½æ•°ï¼Œå…¶å‚æ•°<code>parentFiber === finishedWork === FiberNode(App))</code>ï¼Œæ¯”è¾ƒå…¶<code>subtreeFlags &amp; MutationMask === 0</code>ï¼Œä¸è¿›å…¥<code>if</code>æ¡ä»¶è¯­å¥ä¸­ï¼Œè¿”å›ä¸Šçº§å‡½æ•°ï¼Œæ‰§è¡Œ<code>commitReconciliationEffects</code>è¿›è¡Œæäº¤æ“ä½œï¼Œå…¶æµç¨‹å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-11.23a49fa3.png" alt="alt text"></p> <p>å…¶è°ƒç”¨æ ˆå¦‚ä¸‹å›¾ï¼š
<img src="/knowledge/assets/img/image-12.21e3d1a1.png" alt="alt text">
å¯ä»¥ä»ä¸Šé¢çš„è°ƒç”¨æ ˆçœ‹åˆ°ï¼Œè¿›å…¥äº†ä¸¤æ¬¡<code>commitMutationEffectsOnFiber</code>å‡½æ•°ï¼Œæœ€è¿‘ä¸€æ¬¡çš„<code>recursivelyTraverseMutationEffects</code>å‡½æ•°ç”±äºä¸è¿›å…¥<code>if</code>æ¡ä»¶è¯­å¥ä¸­ï¼Œäºæ˜¯è¢«å¼¹å‡ºè°ƒç”¨æ ˆï¼Œæ‰§è¡Œä¸‹é¢çš„å‡½æ•°<code>commitReconciliationEffects</code>ã€‚</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">commitReconciliationEffects</span><span class="token punctuation">(</span><span class="token parameter">finishedWork</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> flags <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>flags
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">commitPlacement</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>return<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> parent <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">var</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostPortal</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _parent <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
      <span class="token keyword">var</span> _before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> _before<span class="token punctuation">,</span> _parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> tag <span class="token operator">=</span> node<span class="token punctuation">.</span>tag<span class="token punctuation">;</span>
  <span class="token keyword">var</span> isHost <span class="token operator">=</span> tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> tag <span class="token operator">===</span> HostText<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> stateNode <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertInContainerBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">appendChildToContainer</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> sibling <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>sibling <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>sibling<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sibling <span class="token operator">=</span> sibling<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“å‰å†…å­˜ä¸­çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/image-37.6ec715e8.png" alt="alt text"></p> <p>åç»­æµç¨‹å›¾å¦‚ä¸‹ï¼š
<img src="/knowledge/assets/img/react-commit.86162abf.png" alt="alt text"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/knowledge/react/source-code-analysis/01.travers-fiber-tree.html" class="prev">
        Travers Fiber Tree
      </a></span> <span class="next"><a href="/knowledge/typescript/type-challenges.html">
        ç±»å‹ä½“æ“
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge/assets/js/app.5153ca81.js" defer></script><script src="/knowledge/assets/js/2.09711cee.js" defer></script><script src="/knowledge/assets/js/1.ecac6abe.js" defer></script><script src="/knowledge/assets/js/10.61451e43.js" defer></script>
  </body>
</html>
