<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Build your own React | é‚“æ”€çš„æŠ€æœ¯åšå®¢</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge/assets/css/0.styles.19179342.css" as="style"><link rel="preload" href="/knowledge/assets/js/app.5153ca81.js" as="script"><link rel="preload" href="/knowledge/assets/js/2.09711cee.js" as="script"><link rel="preload" href="/knowledge/assets/js/1.ecac6abe.js" as="script"><link rel="preload" href="/knowledge/assets/js/84.98c35d72.js" as="script"><link rel="prefetch" href="/knowledge/assets/js/10.61451e43.js"><link rel="prefetch" href="/knowledge/assets/js/100.fb313dd8.js"><link rel="prefetch" href="/knowledge/assets/js/101.f6084221.js"><link rel="prefetch" href="/knowledge/assets/js/11.0d8da72b.js"><link rel="prefetch" href="/knowledge/assets/js/12.7874f28d.js"><link rel="prefetch" href="/knowledge/assets/js/13.7e77d130.js"><link rel="prefetch" href="/knowledge/assets/js/14.73222ce7.js"><link rel="prefetch" href="/knowledge/assets/js/15.0b07f9b9.js"><link rel="prefetch" href="/knowledge/assets/js/16.2cc5269e.js"><link rel="prefetch" href="/knowledge/assets/js/17.4dc16511.js"><link rel="prefetch" href="/knowledge/assets/js/18.0f42d2d9.js"><link rel="prefetch" href="/knowledge/assets/js/19.d5eb91b2.js"><link rel="prefetch" href="/knowledge/assets/js/20.748f25e2.js"><link rel="prefetch" href="/knowledge/assets/js/21.518a3952.js"><link rel="prefetch" href="/knowledge/assets/js/22.215fc719.js"><link rel="prefetch" href="/knowledge/assets/js/23.85574af4.js"><link rel="prefetch" href="/knowledge/assets/js/24.179f0801.js"><link rel="prefetch" href="/knowledge/assets/js/25.e813b79e.js"><link rel="prefetch" href="/knowledge/assets/js/26.ea3c2f8a.js"><link rel="prefetch" href="/knowledge/assets/js/27.d9a0e0aa.js"><link rel="prefetch" href="/knowledge/assets/js/28.499e6f9d.js"><link rel="prefetch" href="/knowledge/assets/js/29.7ecc7047.js"><link rel="prefetch" href="/knowledge/assets/js/3.6c565688.js"><link rel="prefetch" href="/knowledge/assets/js/30.938ba476.js"><link rel="prefetch" href="/knowledge/assets/js/31.0a6ecdcd.js"><link rel="prefetch" href="/knowledge/assets/js/32.8aef7027.js"><link rel="prefetch" href="/knowledge/assets/js/33.6f6a3468.js"><link rel="prefetch" href="/knowledge/assets/js/34.d901a786.js"><link rel="prefetch" href="/knowledge/assets/js/35.1fd0524e.js"><link rel="prefetch" href="/knowledge/assets/js/36.77bc3059.js"><link rel="prefetch" href="/knowledge/assets/js/37.679cc1e5.js"><link rel="prefetch" href="/knowledge/assets/js/38.f75e290e.js"><link rel="prefetch" href="/knowledge/assets/js/39.1d0ee5d8.js"><link rel="prefetch" href="/knowledge/assets/js/4.587ffb67.js"><link rel="prefetch" href="/knowledge/assets/js/40.3cb3a24b.js"><link rel="prefetch" href="/knowledge/assets/js/41.027942e8.js"><link rel="prefetch" href="/knowledge/assets/js/42.8eb2c3d5.js"><link rel="prefetch" href="/knowledge/assets/js/43.090ab8dc.js"><link rel="prefetch" href="/knowledge/assets/js/44.3bd0b34a.js"><link rel="prefetch" href="/knowledge/assets/js/45.f8142d41.js"><link rel="prefetch" href="/knowledge/assets/js/46.82abb8fa.js"><link rel="prefetch" href="/knowledge/assets/js/47.0f319d1e.js"><link rel="prefetch" href="/knowledge/assets/js/48.c6480f5c.js"><link rel="prefetch" href="/knowledge/assets/js/49.f4067732.js"><link rel="prefetch" href="/knowledge/assets/js/5.15716dac.js"><link rel="prefetch" href="/knowledge/assets/js/50.757a56db.js"><link rel="prefetch" href="/knowledge/assets/js/51.7ebfa544.js"><link rel="prefetch" href="/knowledge/assets/js/52.9611130c.js"><link rel="prefetch" href="/knowledge/assets/js/53.9a8b6f46.js"><link rel="prefetch" href="/knowledge/assets/js/54.a5ab0902.js"><link rel="prefetch" href="/knowledge/assets/js/55.cba7ef0d.js"><link rel="prefetch" href="/knowledge/assets/js/56.af6cd21e.js"><link rel="prefetch" href="/knowledge/assets/js/57.59fb1a6a.js"><link rel="prefetch" href="/knowledge/assets/js/58.d606fdf7.js"><link rel="prefetch" href="/knowledge/assets/js/59.6761b349.js"><link rel="prefetch" href="/knowledge/assets/js/6.6a6617af.js"><link rel="prefetch" href="/knowledge/assets/js/60.a7f4c4ff.js"><link rel="prefetch" href="/knowledge/assets/js/61.e9190c42.js"><link rel="prefetch" href="/knowledge/assets/js/62.a9401860.js"><link rel="prefetch" href="/knowledge/assets/js/63.b827600a.js"><link rel="prefetch" href="/knowledge/assets/js/64.e38255e6.js"><link rel="prefetch" href="/knowledge/assets/js/65.02b1dd62.js"><link rel="prefetch" href="/knowledge/assets/js/66.8f2338cb.js"><link rel="prefetch" href="/knowledge/assets/js/67.c01adc05.js"><link rel="prefetch" href="/knowledge/assets/js/68.e358bf7d.js"><link rel="prefetch" href="/knowledge/assets/js/69.39b37e2d.js"><link rel="prefetch" href="/knowledge/assets/js/7.ba76af71.js"><link rel="prefetch" href="/knowledge/assets/js/70.dcc63002.js"><link rel="prefetch" href="/knowledge/assets/js/71.12f2ab04.js"><link rel="prefetch" href="/knowledge/assets/js/72.2bfd6ad1.js"><link rel="prefetch" href="/knowledge/assets/js/73.1bc5932a.js"><link rel="prefetch" href="/knowledge/assets/js/74.d9482a02.js"><link rel="prefetch" href="/knowledge/assets/js/75.67d0111b.js"><link rel="prefetch" href="/knowledge/assets/js/76.150ac4a4.js"><link rel="prefetch" href="/knowledge/assets/js/77.4deee2b6.js"><link rel="prefetch" href="/knowledge/assets/js/78.5921430f.js"><link rel="prefetch" href="/knowledge/assets/js/79.f74ff1d0.js"><link rel="prefetch" href="/knowledge/assets/js/80.5c34c25e.js"><link rel="prefetch" href="/knowledge/assets/js/81.6e54321c.js"><link rel="prefetch" href="/knowledge/assets/js/82.e8bbc1c5.js"><link rel="prefetch" href="/knowledge/assets/js/83.49d5e292.js"><link rel="prefetch" href="/knowledge/assets/js/85.f73eb0e7.js"><link rel="prefetch" href="/knowledge/assets/js/86.3d3735cc.js"><link rel="prefetch" href="/knowledge/assets/js/87.5d806d0d.js"><link rel="prefetch" href="/knowledge/assets/js/88.57c59503.js"><link rel="prefetch" href="/knowledge/assets/js/89.aa1e2fe4.js"><link rel="prefetch" href="/knowledge/assets/js/90.2c50ee69.js"><link rel="prefetch" href="/knowledge/assets/js/91.ae6cb9aa.js"><link rel="prefetch" href="/knowledge/assets/js/92.ff541495.js"><link rel="prefetch" href="/knowledge/assets/js/93.8f52d80b.js"><link rel="prefetch" href="/knowledge/assets/js/94.e6d1e6c5.js"><link rel="prefetch" href="/knowledge/assets/js/95.c55344fe.js"><link rel="prefetch" href="/knowledge/assets/js/96.6a87e9ca.js"><link rel="prefetch" href="/knowledge/assets/js/97.43e0ca7f.js"><link rel="prefetch" href="/knowledge/assets/js/98.3fcabc73.js"><link rel="prefetch" href="/knowledge/assets/js/99.f68c9886.js"><link rel="prefetch" href="/knowledge/assets/js/vendors~docsearch.7a484b82.js">
    <link rel="stylesheet" href="/knowledge/assets/css/0.styles.19179342.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge/" class="home-link router-link-active"><!----> <span class="site-name">é‚“æ”€çš„æŠ€æœ¯åšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge/" aria-current="page" class="sidebar-link">æ¬¢è¿</a></li><li><section class="sidebar-group depth-0"><a href="/knowledge/vue" class="sidebar-heading clickable"><span>Vue</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/vue/å“åº”å¼.html" class="sidebar-link">å“åº”å¼</a></li><li><a href="/knowledge/vue/ç¼–è¯‘.html" class="sidebar-link">ç¼–è¯‘</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/react" class="sidebar-heading clickable router-link-active open"><span>React</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/react/01.JSX.html" class="sidebar-link">JSX</a></li><li><a href="/knowledge/react/02.Fiber.html" class="sidebar-link">Fiber</a></li><li><a href="/knowledge/react/03.bit.html" class="sidebar-link">Bit</a></li><li><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html" aria-current="page" class="active sidebar-link">BuildYourOwnReact</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬-0-æ­¥-å›é¡¾" class="sidebar-link">ç¬¬ 0 æ­¥ï¼šå›é¡¾</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬ä¸€æ­¥-createelementå‡½æ•°" class="sidebar-link">ç¬¬ä¸€æ­¥ï¼šcreateElementå‡½æ•°</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬äºŒæ­¥-renderå‡½æ•°" class="sidebar-link">ç¬¬äºŒæ­¥ï¼šrenderå‡½æ•°</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬ä¸‰æ­¥-concurrentæ¨¡å¼" class="sidebar-link">ç¬¬ä¸‰æ­¥ï¼šConcurrentæ¨¡å¼</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬å››æ­¥-fibers" class="sidebar-link">ç¬¬å››æ­¥ï¼šFibers</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬äº”æ­¥-renderå’Œcommité˜¶æ®µ" class="sidebar-link">ç¬¬äº”æ­¥ï¼šRenderå’ŒCommité˜¶æ®µ</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬å…­æ­¥-reconciliation" class="sidebar-link">ç¬¬å…­æ­¥ï¼šReconciliation</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬ä¸ƒæ­¥-function-components" class="sidebar-link">ç¬¬ä¸ƒæ­¥ï¼šFunction Components</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#ç¬¬å…«æ­¥-hooks" class="sidebar-link">ç¬¬å…«æ­¥ï¼šHooks</a></li><li class="sidebar-sub-header"><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html#å‚è€ƒ" class="sidebar-link">å‚è€ƒ</a></li></ul></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Source Code Analysis</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/typescript" class="sidebar-heading clickable"><span>TypeScript</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/typescript/type-challenges.html" class="sidebar-link">ç±»å‹ä½“æ“</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/nextjs" class="sidebar-heading clickable"><span>nextjs</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/nextjs/docs/05.Fetching Data.html" class="sidebar-link">Fetching Data</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/nodejs" class="sidebar-heading clickable"><span>Node.js</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/nodejs/å¼‚æ­¥å¼io.html" class="sidebar-link">å¼‚æ­¥å¼IO</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/algorithm" class="sidebar-heading clickable"><span>ç®—æ³•</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/algorithm/äºŒåˆ†æŸ¥æ‰¾.html" class="sidebar-link">äºŒåˆ†æŸ¥æ‰¾</a></li><li><a href="/knowledge/algorithm/å¤§æ•°ç›¸åŠ .html" class="sidebar-link">å¤§æ•°ç›¸åŠ </a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/system-design" class="sidebar-heading clickable"><span>ç³»ç»Ÿè®¾è®¡</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/system-design/news-feed.html" class="sidebar-link">news feed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/interview" class="sidebar-heading clickable"><span>é¢è¯•ç›¸å…³</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/interview/html.html" class="sidebar-link">HTML</a></li><li><a href="/knowledge/interview/JavaScript.html" class="sidebar-link">JavaScript</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/GFE" class="sidebar-heading clickable"><span>GFE</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/GFE/01.debounce/" class="sidebar-link">Debounce</a></li><li><a href="/knowledge/GFE/02.myReduce/" class="sidebar-link">MyReduce</a></li><li><a href="/knowledge/GFE/03.classnames/" class="sidebar-link">ClassNames</a></li><li><a href="/knowledge/GFE/04.flatten/" class="sidebar-link">Flatten</a></li><li><a href="/knowledge/GFE/05.throttle/" class="sidebar-link">Throttle</a></li><li><a href="/knowledge/GFE/06.Type%20Utilities/" class="sidebar-link">Type Utilities</a></li><li><a href="/knowledge/GFE/07.Type%20Utilities%20II/" class="sidebar-link">Type Utilities II</a></li><li><a href="/knowledge/GFE/08.Promise.all/" class="sidebar-link">Promise.all</a></li><li><a href="/knowledge/GFE/09.Data%20Merging/" class="sidebar-link">Data Merging</a></li><li><a href="/knowledge/GFE/10.Deep%20Clone/" class="sidebar-link">Deep Clone</a></li><li><a href="/knowledge/GFE/11.Event%20Emitter/" class="sidebar-link">Event Emitter</a></li><li><a href="/knowledge/GFE/12.getElementsByStyle/" class="sidebar-link">getElementsByStyle</a></li><li><a href="/knowledge/GFE/13.Function.prototype.call/" class="sidebar-link">Function.prototype.call</a></li><li><a href="/knowledge/GFE/14.List%20Format/" class="sidebar-link">List Format</a></li><li><a href="/knowledge/GFE/15.Map%20Async%20Limit/" class="sidebar-link">Map Async Limit</a></li><li><a href="/knowledge/GFE/16.Deep%20Equal/" class="sidebar-link">Deep Equal</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/Blind" class="sidebar-heading clickable"><span>Blind</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/Blind/01.Balanced%20Brackets/" class="sidebar-link">Balanced Brackets</a></li><li><a href="/knowledge/Blind/02.Find%20Duplicates%20in%20Array/" class="sidebar-link">Find Duplicates in Array</a></li><li><a href="/knowledge/Blind/03.Find%20Missing%20Number%20in%20Sequence/" class="sidebar-link">Find Missing Number in Sequence</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/git" class="sidebar-heading clickable"><span>Git</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/git/commit.html" class="sidebar-link">commit</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="build-your-own-react"><a href="#build-your-own-react" class="header-anchor">#</a> Build your own React</h1> <p>æˆ‘ä»¬è¦ä»ä¸‹é¢å‡ ä¸ªæ­¥éª¤æ¥åˆ›å»ºä¸€ä¸ª<code>React</code></p> <ul><li>ç¬¬ä¸€æ­¥ï¼š<code>createElement</code>å‡½æ•°</li> <li>ç¬¬äºŒæ­¥ï¼š<code>render</code>å‡½æ•°</li> <li>ç¬¬ä¸‰æ­¥ï¼š<code>concurrent</code>æ¨¡å¼</li> <li>ç¬¬å››æ­¥ï¼š<code>Fiber</code></li> <li>ç¬¬äº”æ­¥ï¼šæ¸²æŸ“<code>Render</code>ä»¥åŠ<code>Commit</code>é˜¶æ®µ</li> <li>ç¬¬å…­æ­¥ï¼šå‡½æ•°ç»„ä»¶</li> <li>ç¬¬ä¸ƒæ­¥ï¼š<code>Hooks</code></li></ul> <h2 id="ç¬¬-0-æ­¥-å›é¡¾"><a href="#ç¬¬-0-æ­¥-å›é¡¾" class="header-anchor">#</a> ç¬¬ 0 æ­¥ï¼šå›é¡¾</h2> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// å®šä¹‰ react ä¸­çš„å…ƒç´  element</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Hello</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token comment">// å®šä¹‰æŒ‚è½½å®¹å™¨</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å°†å…ƒç´ æ¸²æŸ“è¿›å…¥æŒ‚è½½å®¹å™¨ä¸­</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢ä¸‰è¡Œæ˜¯åœ¨æˆ‘ä»¬ä½¿ç”¨<code>react</code>æ—¶å¿…è¦çš„ä»£ç </p> <p>åœ¨ä¸Šé¢çš„ç¬¬ä¸€æ­¥ä¸­ï¼Œå®šä¹‰<code>react</code>ä¸­çš„å…ƒç´ <code>element</code>ï¼Œå…¶ä¸­<code>&lt;h1&gt;</code>å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„<code>JavaScript</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆæ³•çš„<code>JS</code>æ¥ä»£æ›¿å®ƒ</p> <p><code>JSX</code>é€šè¿‡åƒ<code>Babel</code>ç±»çš„æ„å»ºå·¥å…·ï¼Œå°†å…¶è½¬æ¢ä¸º<code>JS</code>ï¼Œè½¬æ¢è§„åˆ™ä¹Ÿæ˜¯ç®€å•çš„ï¼šä½¿ç”¨<code>createElement</code>ä»£æ›¿ï¼Œä¼ é€’è¿›å…¥<code>tag</code>åç§°ä»¥åŠç›¸åº”åœ°<code>props</code>å’Œ<code>children</code>ä½œä¸ºå‚æ•°ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token operator">&lt;</span>h1 title<span class="token operator">=</span><span class="token string">&quot;foo&quot;</span><span class="token operator">&gt;</span>hello<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// è½¬æ¢ä¸º</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;hello&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>createElement</code>æ‰€åšçš„å°±æ˜¯ï¼Œä¸€äº›åŸºæœ¬çš„æ ¡éªŒï¼Œä»¥åŠä»ä¼ å…¥çš„å‚æ•°ä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚å¦‚ï¼Œä¸Šé¢çš„<code>element</code>ä¸ºä¸‹é¢çš„å¯¹è±¡</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>element</code>æ˜¯ä¸€ä¸ªæœ‰ä¸¤ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œ<code>type</code>ä»¥åŠ<code>props</code>ï¼ˆå…¶å®è¿˜æœ‰æ›´å¤šï¼Œä½†æ˜¯ç°åœ¨åªéœ€è¦å…³å¿ƒè¿™ä¸¤ä¸ªå³å¯ã€‚ï¼‰</p> <ul><li><p><code>type</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨æ¥æŒ‡å®šæˆ‘ä»¬æƒ³åˆ›å»ºçš„<code>DOM</code>èŠ‚ç‚¹çš„ç±»å‹ï¼Œå®ƒæ˜¯å½“è¦ä½¿ç”¨<code>document.createElement</code>åˆ›å»º<code>DOM</code>æ—¶ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°çš„<code>tagName</code>ã€‚è¯¥å­—æ®µä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚å½“æˆ‘ä»¬ä½¿ç”¨å‡½æ•°ç»„ä»¶æ—¶ï¼Œè¿™ä¸ª<code>type</code>ç±»å‹ä¹Ÿå°±ä¸ºä¸€ä¸ªå‡½æ•°ã€‚</p></li> <li><p><code>props</code>æ˜¯å¦ä¸€ä¸ªå¯¹è±¡ã€‚å®ƒåŒ…å«äº†<code>JSX</code>ä¸­çš„æ‰€æœ‰çš„<code>keys</code>ä»¥åŠ<code>values</code>ï¼Œä¹ŸåŒ…å«å…¶ä¸­çš„<code>children</code>ã€‚</p></li> <li><p><code>children</code>ï¼šåœ¨å½“å‰çš„ä¾‹å­ä¸­æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯å¸¸è§æƒ…å†µä¸‹ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„</p></li></ul> <blockquote><p>é™¤äº†ä¸Šé¢çš„<code>JSX</code>ï¼Œå¦ä¸€æ–¹é¢æˆ‘ä»¬éœ€è¦æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±çš„å‡½æ•°çš„ä¸º<code>render</code></p></blockquote> <p><code>render</code>å‡½æ•°æ˜¯<code>React</code>ç”¨æ¥æ”¹å˜<code>DOM</code>çš„åœ°æ–¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„æ–¹å¼æ¥è¿›è¡Œæ›´æ–°ã€‚ä½¿ç”¨<code>DOM</code>æ“ä½œ<code>API</code>æ¥å‘é¡µé¢ä¸­æ’å…¥å³å¯</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
node<span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
<span class="token keyword">const</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
text<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
node<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æ‰€ä»¥ä¸Šé¢å®ç°äº†å°†<code>JSX</code>è½¬æ¢ä¸º<code>JS</code>ï¼Œå¹¶å°†å…¶æ ¹æ®<code>type</code>ç±»å‹ç”Ÿæˆå¯¹åº”<code>DOM</code>èŠ‚ç‚¹ï¼Œå¹¶æ’å…¥åˆ°é¡µé¢ä¸­çš„è¿‡ç¨‹ã€‚</p> <h2 id="ç¬¬ä¸€æ­¥-createelementå‡½æ•°"><a href="#ç¬¬ä¸€æ­¥-createelementå‡½æ•°" class="header-anchor">#</a> ç¬¬ä¸€æ­¥ï¼š<code>createElement</code>å‡½æ•°</h2> <p>åœ¨ä¸Šé¢ä¸­å¯ä»¥çœ‹åˆ°ï¼Œéœ€è¦ä½¿ç”¨<code>createElement</code>å‡½æ•°ï¼Œç”Ÿæˆä¸€ä¸ª<code>React</code>ä¸­çš„<code>element</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å…¶<code>createElement</code>å‡½æ•°ä¸»è¦æ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>element</code>å¯¹è±¡ï¼Œç”¨æ¥å¯¹ç›¸åº”çš„<code>DOM</code>èŠ‚ç‚¹è¿›è¡Œæè¿°ï¼Œä¸»è¦æœ‰<code>type</code>ä»¥åŠ<code>props</code>å±æ€§ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªè¿›è¡Œ<code>createElement</code>çš„ç¼–å†™</p> <p>æ¯”å¦‚ï¼š<code>createElement(&quot;div&quot;)</code>è¿”å›ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createElement(&quot;div&quot;, null, a)</code>è¿”å›ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>createElement(&quot;div&quot;, null, a, b)</code>è¿”å›ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¼ å…¥<code>children</code>ä¸­çš„æ•°ç»„çš„å€¼ç±»å‹ï¼Œå³å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª<code>element</code>å¯¹è±¡ï¼Œå¦‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      b
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœå€¼çš„ç±»å‹ä¸ºå­—ç¬¦ä¸²ä»¥åŠæ•°å­—ï¼Œé‚£ä¹ˆä¼šåˆ›å»ºä¸€ä¸ª<code>TEXT_ELEMENT</code>ç±»å‹æ¥æŒ‡å®šå…¶ä¸ºæ–‡æœ¬ç±»å‹èŠ‚ç‚¹ï¼ˆæ³¨æ„ ğŸ“¢ï¼š <code>React</code>æºç ä¸­æ²¡æœ‰å¯¹åŸå§‹å€¼ä»¥åŠæ•°ç»„ä¸ºç©ºçš„æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸ºäº†ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ï¼Œåšäº†è¯¥å¤„ç†ã€‚ï¼‰</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>props<span class="token punctuation">,</span>
      children<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ·»åŠ <code>TEXT_ELEMENT</code>ç±»å‹èŠ‚ç‚¹çš„å¤„ç†é€»è¾‘ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>props<span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">?</span> child <span class="token operator">:</span> <span class="token function">createTextElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createTextElement</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;TEXT_ELEMENT&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">nodeValue</span><span class="token operator">:</span> text<span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸ºäº†ä¸<code>React</code>ä»£ç è¿›è¡ŒåŒºåˆ†ï¼Œå°†æˆ‘ä»¬å…¶å‘½åä¸ºï¼š<code>Deact</code>ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Deact <span class="token operator">=</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
  createTextElement<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="ç¬¬äºŒæ­¥-renderå‡½æ•°"><a href="#ç¬¬äºŒæ­¥-renderå‡½æ•°" class="header-anchor">#</a> ç¬¬äºŒæ­¥ï¼š<code>render</code>å‡½æ•°</h2> <p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ›å»º<code>render</code>å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// éå† element.props ä¸­çš„å±æ€§ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° node ä¸­</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dom<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// éå† element.props.children ä¸­çš„å…ƒç´ ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° node ä¸­</span>
  element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>éœ€è¦å¯¹æ–‡æœ¬ç±»å‹èŠ‚ç‚¹åšç‰¹æ®Šå¤„ç†:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span>
    element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;TEXT_ELEMENT&quot;</span>
      <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// éå† element.props ä¸­çš„å±æ€§ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° node ä¸­</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// éå† element.props.children ä¸­çš„å…ƒç´ ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° node ä¸­</span>
  element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ç¬¬ä¸‰æ­¥-concurrentæ¨¡å¼"><a href="#ç¬¬ä¸‰æ­¥-concurrentæ¨¡å¼" class="header-anchor">#</a> ç¬¬ä¸‰æ­¥ï¼š<code>Concurrent</code>æ¨¡å¼</h2> <p>ä¸Šé¢çš„é€’å½’è°ƒç”¨æœ‰ä¸€ä¸ªé—®é¢˜ã€‚</p> <p>ä¸€æ—¦æˆ‘ä»¬å¼€å§‹æ¸²æŸ“ï¼Œç›´åˆ°æˆ‘ä»¬æ¸²æŸ“å®Œæˆæ•´ä¸ª<code>DOM</code>æ ‘ï¼Œè¿™ä¸ªæ¸²æŸ“è¿‡ç¨‹ä¸ä¼šåœæ­¢ã€‚å¦‚æœè¿™ä¸ªæ ‘éå¸¸å¤§ï¼Œé‚£ä¹ˆä¼šé˜»å¡ä¸»çº¿ç¨‹å¾ˆé•¿æ—¶é—´ã€‚**å¦‚æœæµè§ˆå™¨æœ‰ä¸€äº›å¦‚å¤„ç†ç”¨æˆ·è¾“å…¥æˆ–è€…åŠ¨ç”»ç±»çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œåˆ™å¿…é¡»è¦ç­‰å¾…æ•´ä¸ªæ¸²æŸ“å®Œæˆæ‰èƒ½æ‰§è¡Œã€‚**è¿™æ˜¯éå¸¸ä¸å‹å¥½çš„ï¼Œä¼šç»™ç”¨æˆ·é€ æˆéå¸¸ä¸å¥½çš„ä½“éªŒã€‚</p> <p>æˆ‘ä»¬ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦åšä¸‹é¢ ğŸ‘‡ğŸ» å‡ ä»¶äº‹ï¼š</p> <ol><li>å°†<code>render</code>ä¸­ä¸èƒ½ä¸­æ–­çš„æ¸²æŸ“å¤§ä»»åŠ¡ï¼Œæ‹†è§£ä¸ºå¯ä»¥ä¸­æ–­çš„å°ä»»åŠ¡</li> <li>ç¡®å®šå½“å‰æµè§ˆå™¨æ˜¯å¦æœ‰ç©ºä½™æ—¶é—´</li> <li>éœ€è¦æœ‰ä¸€ä¸ªæœºåˆ¶ï¼Œåœ¨æœ‰ç©ºä½™æ—¶é—´æ—¶ï¼Œå¯ä»¥è¿›è¡Œå¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆ</li> <li>éœ€è¦ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä¿å­˜ä¸‹ä¸€æ¬¡éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚å¯ä»¥å°†ä»»åŠ¡æ¥ç€æ‰§è¡Œ</li></ol> <h3 id="å®ç°å¾ªç¯æœºåˆ¶"><a href="#å®ç°å¾ªç¯æœºåˆ¶" class="header-anchor">#</a> å®ç°å¾ªç¯æœºåˆ¶</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å°†å¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå°ä»»åŠ¡çš„å¾ªç¯æ‰§è¡Œæœºåˆ¶</span>
<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// å…¨å±€å˜é‡ï¼Œä¿å­˜æ¥ä¸‹æ¥éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span>
<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// åˆ¤æ–­æµè§ˆå™¨æ˜¯å¦æœ‰å‰©ä½™æ—¶é—´</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨ä¸€ä¸ªrequestIdleCallbackä¸­ï¼Œæœ‰åç»­ä»»åŠ¡å¹¶ä¸”æµè§ˆå™¨æœ‰å‰©ä½™æ—¶é—´ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ç©ºä½™æ—¶é—´ï¼Œå¦‚æœæ²¡ç©ºä½™æ—¶é—´ï¼Œåˆ™åœæ­¢å¾ªç¯ï¼Œå°†å½“å‰å˜é‡å­˜å‚¨åœ¨nextUnitWorkä¸­</span>
    shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ç»§ç»­ç›‘å¬ä¸‹ä¸€ä¸ªæµè§ˆå™¨ç©ºä½™æ—¶é—´</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯ä»¥ä½¿ç”¨<code>requestIdleCallback</code>æ¥åˆ›å»ºä¸€ä¸ª<code>loop</code>å¾ªç¯ï¼Œå¯ä»¥å°†<code>requestIdleCallback</code>ä½œä¸ºä¸€ä¸ª<code>setTimeout</code>ã€‚</p> <p>æµè§ˆå™¨åœ¨ç©ºé—²æ—¶ä¼šè°ƒç”¨ä¼ å…¥<code>requestIdleCallback</code>çš„å›è°ƒå‡½æ•°ï¼Œå¹¶å‘å…¶ä¸­ä¼ å…¥<code>deadline</code>å˜é‡ï¼Œè¯¥å˜é‡å¯ä»¥è·å–å®æ—¶çš„å‰©ä½™æ—¶é—´ã€‚</p> <p><code>React</code>å†…éƒ¨ä¸åœ¨ä½¿ç”¨<code>requestIdleCallback</code>ï¼Œè€Œæ˜¯ä½¿ç”¨<code>scheduler</code>è°ƒåº¦å™¨ã€‚ä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„æ ¸å¿ƒä¸åœ¨è°ƒåº¦éƒ¨åˆ†ï¼Œæ‰€ä»¥ä»ç„¶ä½¿å®ƒã€‚</p> <p><code>requestIdleCallback</code>ä¼šä¼ å…¥å›è°ƒå‡½æ•°ä¸€ä¸ª<code>deadline</code>å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‚æ•°æ¥åˆ¤æ–­åˆ°æµè§ˆå™¨å†æ¬¡æ§åˆ¶è¿˜å‰©ä½™å¤šå°‘æ—¶é—´</p> <h2 id="ç¬¬å››æ­¥-fibers"><a href="#ç¬¬å››æ­¥-fibers" class="header-anchor">#</a> ç¬¬å››æ­¥ï¼šFibers</h2> <p>ä¸ºäº†ç»„ç»‡å·¥ä½œå•å…ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ•°æ®ç»“æ„ï¼ˆ<strong>å¯ä»¥ä¿å­˜å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä»¥åŠå¯ä»¥éšæ—¶è¿›è¡Œä¸­æ–­</strong>ï¼‰ï¼š<code>fiber</code>æ ‘</p> <p>æˆ‘ä»¬å°†é’ˆå¯¹æ¯ä¸€ä¸ª<code>element</code>éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„<code>fiber</code>ï¼Œæ¯ä¸€ä¸ª<code>fiber</code>å°†æˆä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒ</p> <p>å¦‚æœæˆ‘ä»¬æƒ³æ¸²æŸ“ä¸‹é¢çš„<code>element</code>æ ‘</p> <div class="language-ts extra-class"><pre class="language-ts"><code>Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  container
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>åœ¨<code>render</code>ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæ ¹<code>RootFiber</code>ä»¥åŠå°†å…¶è®¾ç½®ä¸º<code>nextUnitOfWork</code>ã€‚å…¶ä»–çš„å·¥ä½œå°†åœ¨<code>performUnitWork</code>å‡½æ•°ä¸­å‘ç”Ÿï¼Œæˆ‘ä»¬é’ˆå¯¹æ¯ä¸€ä¸ª<code>fiber</code>èŠ‚ç‚¹å°†ä¼šåšä¸‹é¢ä¸‰ä»¶äº‹ï¼š</p> <ol><li>å¢åŠ ä¸€ä¸ªæ’å…¥åˆ°<code>DOM</code>çš„å…ƒç´ <code>element</code></li> <li>ä¸º<code>element</code>çš„å­å­™åˆ›å»º<code>fiber</code></li> <li>é€‰æ‹©ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</li></ol> <p><img src="image.png" alt="alt text"></p> <p>è¿™ç§æ•°æ®ç»“æ„çš„ä¸€ä¸ªç›®çš„å°±æ˜¯<strong>æ›´åŠ å®¹æ˜“çš„å‘ç°ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</strong>ï¼Œé‚£å°±æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ª<code>fiber</code>éƒ½æœ‰ä¸€ä¸ªé“¾æ¥æŒ‡å‘å®ƒçš„ç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼Œå®ƒçš„ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ ä»¥åŠå®ƒçš„çˆ¶çº§å…ƒç´ </p> <p>å½“å®Œæˆä¸€ä¸ª<code>fiber</code>çš„å·¥ä½œï¼Œå¦‚æœå®ƒå­˜åœ¨å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªå­èŠ‚ç‚¹çš„<code>fiber</code>å°†æˆä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</p> <p>åœ¨æˆ‘ä»¬ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œå½“æˆ‘ä»¬å®Œæˆ<code>div</code>çš„<code>fiber</code>çš„å·¥ä½œï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå°±æ˜¯<code>h1</code>çš„<code>fiberNode</code></p> <p>å¦‚æœè¿™ä¸ª<code>fiberNode</code>æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨<code>sibling</code>çš„<code>fiberNoode</code>ä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</p> <p>åœ¨æˆ‘ä»¬ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œ<code>p</code>çš„<code>fiberNode</code>æ‰§è¡Œå®Œæˆåï¼Œæ²¡æœ‰<code>child</code>çš„<code>fiberNode</code>ï¼Œé‚£ä¹ˆå°†è¿”å›<code>a</code>çš„<code>fiberNode</code>ä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</p> <p>å¦‚æœä¸€ä¸ª<code>fiberNode</code>æ—¢æ²¡æœ‰<code>child</code>çš„<code>fiberNode</code>ï¼Œä¹Ÿæ²¡æœ‰<code>sibling</code>çš„<code>fiberNode</code>ï¼Œé‚£å°±å°±ä¼šå»å¯»æ‰¾<code>uncle</code>å”å”èŠ‚ç‚¹çš„<code>fiberNode</code>ï¼Œä¹Ÿå°±æ˜¯<code>sibling</code>çš„<code>parent</code>èŠ‚ç‚¹</p> <p>å¦‚ä¸Šå›¾ä¸­çš„<code>a</code>ä»¥åŠ<code>h2</code>èŠ‚ç‚¹</p> <p>å¦‚æœ<code>parent</code>çš„<code>fiberNode</code>æ²¡æœ‰<code>sibling</code>èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šç»§ç»­å‘ä¸ŠæŸ¥æ‰¾<code>parent</code>çš„<code>fiberNode</code>ç›´åˆ°å‘ç°ä¸€ä¸ª<code>sibling</code>èŠ‚ç‚¹ï¼Œæˆ–è€…ç›´åˆ°åˆ°è¾¾é¡¶å±‚çš„<code>root</code>èŠ‚ç‚¹ã€‚å¦‚æœåˆ°è¾¾<code>root</code>èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ„å‘³ç€æˆ‘ä»¬å·²ç»å®Œæˆäº†è¿™æ¬¡<code>perform</code>æ¸²æŸ“çš„æ‰€æœ‰å·¥ä½œ</p> <p>è®©æˆ‘ä»¬æ ¹æ®ä¸Šé¢çš„æ€æƒ³æ¥è¿›è¡Œä»£ç æ”¹é€ ï¼š</p> <p>å°†<code>render</code>ä¸­ä¸åˆ›å»º<code>DOM</code>ç›¸å…³çš„ä»£ç å•ç‹¬å°è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createDom</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span>
    fiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;TEXT_ELEMENT&quot;</span>
      <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> key <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨<code>render</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†è®¾ç½®<code>nextUnitOfWork</code>ä¸º<code>fiber</code>æ ‘çš„æ ¹èŠ‚ç‚¹</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nextUnitOfWork <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">dom</span><span class="token operator">:</span> container<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶åï¼Œå½“æµè§ˆå™¨å‡†å¤‡å¥½æ—¶ï¼Œå®ƒå°†ä¼šè°ƒç”¨<code>workLoop</code>å‡½æ•°ï¼Œç„¶åå°†ä»<code>root</code>èŠ‚ç‚¹å¼€å§‹å·¥ä½œ.</p> <p>ä¸‹é¢ï¼Œæˆ‘ä»¬éœ€è¦æ¥å®Œ<code>performUnitOfWork</code>å‡½æ•°ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„<code>node</code>ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°<code>DOM</code>ä¸­ã€‚æˆ‘ä»¬é€šè¿‡<code>fiber.dom</code>å±æ€§å»ä¼šè¿½è¸ªå…¶<code>DOM</code>çš„<code>node</code>èŠ‚ç‚¹</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// create new node and append it to the DOM</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token function">createDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶åï¼Œå¯¹äºæ¯ä¸€ä¸ª<code>child</code>ï¼Œæˆ‘ä»¬å°†ä¼šåˆ›å»ºå…¶å¯¹åº”çš„<code>fiber</code>èŠ‚ç‚¹ï¼Œç„¶åå°†å…¶<code>fiber</code>å¯¹åº”çš„<code>child</code>ä»¥åŠ<code>sibling</code>æŒ‡å‘å¯¹åº”çš„<code>fiberNode</code>èŠ‚ç‚¹</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...add dom node</span>
  <span class="token comment">// create new fibers</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> prevSibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      <span class="token literal-property property">parent</span><span class="token operator">:</span> fiber<span class="token punctuation">,</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// childæŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      newFiber<span class="token punctuation">.</span>parent <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¾ªç¯å»ºç«‹siblingè¿æ¥</span>
      prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      newFiber<span class="token punctuation">.</span>parent <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    index<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦è¿”å›æ•°æ®ä»¥ä¾›ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒä½¿ç”¨ï¼ŒæŒ‰ç…§ä¸Šé¢ ğŸ‘†ğŸ» çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬é¦–å…ˆè¿”å›<code>child</code>ï¼Œç„¶åæ˜¯<code>sibling</code>ï¼Œæœ€åæ˜¯<code>uncle</code>ç­‰ç­‰</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...add dom node</span>
  <span class="token comment">// ...create new fibers</span>

  <span class="token comment">// å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥è¿”å›</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æŸ¥æ‰¾siblingèŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›ï¼Œå¦åˆ™è¿”å›parentçš„siblingèŠ‚ç‚¹</span>
  <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ç¬¬äº”æ­¥-renderå’Œcommité˜¶æ®µ"><a href="#ç¬¬äº”æ­¥-renderå’Œcommité˜¶æ®µ" class="header-anchor">#</a> ç¬¬äº”æ­¥ï¼š<code>Render</code>å’Œ<code>Commit</code>é˜¶æ®µ</h2> <p>ä¸Šé¢çš„ä»£ç å®ç°äº†ç”Ÿæˆ<code>fiber</code>ä»¥åŠæ ¹æ®<code>fiber</code>ç”Ÿæˆå¯¹åº”çš„<code>DOM</code>ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°é¡µé¢ä¸­ã€‚ä½†æ˜¯è¿™æ ·ä¹Ÿä¼šé€ æˆå…¶ä»–çš„é—®é¢˜ã€‚</p> <p>æˆ‘ä»¬æ¯æ¬¡å¯¹ä¸€ä¸ª<code>fiber</code>è¿›è¡Œ<code>perform</code>çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>DOM</code>ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°<code>DOM</code>ä¸­ã€‚å¹¶ä¸”ç”±äºæˆ‘ä»¬çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥è¢«æµè§ˆå™¨çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¸­æ–­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°æ²¡æœ‰æ¸²æŸ“å®Œæˆçš„<code>UI</code>ã€‚è¿™æ˜¯éå¸¸ä¸å‹å¥½çš„ã€‚</p> <p>æ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æŒ‚è½½æ’å…¥<code>DOM</code>çš„éƒ¨åˆ†ç§»é™¤</p> <p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦è¿½è¸ª<code>fiber</code>æ ‘çš„è·ŸèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸º<code>workInProgress</code>æˆ–è€…<code>wipRoot</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">dom</span><span class="token operator">:</span> container<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å…¨å±€å˜é‡ï¼Œä¿å­˜æ¥ä¸‹æ¥éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</span>
<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> wipRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div><p>å½“æ‰§è¡Œå®Œæ‰€æœ‰çš„<code>perform</code>åï¼Œå†å°†æ•´ä¸ª<code>fiber</code>æ ‘ä¸€èµ·æäº¤åˆ°<code>DOM</code>ä¸­ï¼Œä¿®æ”¹ä¸ºå¦‚ä¸‹ä»£ç ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å½“nextUnitOfWorkçš„å€¼ä¸ºNullçš„æ—¶å€™ï¼Œä»£è¡¨å·²ç»å®Œæˆäº†æ•´ä¸ªfiberæ ‘çš„performè¿‡ç¨‹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> wipRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨<code>commitRoot</code>ä¸­ï¼Œä½¿ç”¨<code>wipRoot</code>èŠ‚ç‚¹ï¼Œè¯¥å˜é‡ä¿å­˜ç€å¯¹æ•´ä¸ªçš„<code>fiber</code>æ ‘çš„å¼•ç”¨ï¼Œé€’å½’è°ƒç”¨å°†æ‰€æœ‰çš„èŠ‚ç‚¹ä»é¡¶éƒ¨æ·±åº¦ä¼˜å…ˆéå†å°†æ•´ä¸ªæ ‘æŒ‚è½½åœ¨è¿›å…¥é¡µé¢ä¸­</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> wipRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commtWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ç¬¬å…­æ­¥-reconciliation"><a href="#ç¬¬å…­æ­¥-reconciliation" class="header-anchor">#</a> ç¬¬å…­æ­¥ï¼š<code>Reconciliation</code></h2> <p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæ˜¯æ·»åŠ å†…å®¹åˆ°<code>DOM</code>ä¸­ï¼ˆå› ä¸ºåªæœ‰ç¬¬ä¸€æ¬¡çš„æŒ‚è½½ï¼‰ï¼Œä½†æ˜¯å¦‚æœéœ€è¦æ›´æ–°æˆ–è€…åˆ é™¤èŠ‚ç‚¹å‘¢</p> <p>é‚£å°±æ˜¯æˆ‘ä»¬åé¢è¦åšçš„äº‹ï¼Œæˆ‘ä»¬éœ€è¦å»æ¯”è¾ƒ<code>render</code>å‡½æ•°å†…æ¥æ”¶åˆ°çš„<code>element</code>å…ƒç´ ï¼Œä¸æˆ‘ä»¬æœ€è¿‘ä¸€æ¬¡æäº¤åˆ°<code>DOM</code>ä¸Šçš„å…ƒç´ </p> <p>å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨å®Œæˆ<code>commit</code>ä¹‹åä¿å­˜ä¸€ä¸ªâ€œæœ€è¿‘æäº¤çš„ fiber æ ‘â€çš„å¼•ç”¨ï¼Œå°†å…¶ç§°ä¸º<code>currentRoot</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">dom</span><span class="token operator">:</span> container<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">alternate</span><span class="token operator">:</span> currentRoot<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç°åœ¨æˆ‘ä»¬æŠ½å–<code>performUnitOfWork</code>ä¸­å…³äºåˆ›å»º<code>new fiber</code>çš„ç›¸å…³ä»£ç åˆ°å•ç‹¬çš„å‡½æ•°ä¸­</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// other code...</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// other code...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">wipFiber<span class="token punctuation">,</span> elements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> prevSibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      <span class="token literal-property property">parent</span><span class="token operator">:</span> wipFiber<span class="token punctuation">,</span>
      <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wipFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      newFiber<span class="token punctuation">.</span>parent <span class="token operator">=</span> wipFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      newFiber<span class="token punctuation">.</span>parent <span class="token operator">=</span> wipFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    index<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šç”¨è€çš„<code>fiber</code>ä¸æ–°çš„å…ƒç´ è¿›è¡Œ<code>reconcile</code></p> <p>è·å–å½“å‰æ­£åœ¨åˆ›å»ºçš„<code>fiber</code>å…ƒç´ çš„<code>alternate</code>ä¸­çš„å­å…ƒç´ ï¼ˆä¹Ÿå°±æ˜¯æœ€è¿‘ä¸€æ¬¡å·²ç»æäº¤åˆ°é¡µé¢çš„<code>fiber</code>èŠ‚ç‚¹ï¼‰ï¼Œä¸å°†è¦ç”Ÿæˆçš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œæˆ‘ä»¬éœ€è¦æ¯”è¾ƒçœ‹æ˜¯å¦æœ‰æ”¹å˜éœ€è¦è¢«åº”ç”¨åˆ°<code>DOM</code>ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>type</code>ç±»å‹è¿›è¡Œå¦‚ä¸‹æ¯”è¾ƒï¼š</p> <ul><li>æ¯”è¾ƒç±»å‹æ˜¯å¦ç›¸åŒï¼Œç›¸åŒåˆ™å¤ç”¨åŸæœ¬çš„<code>DOM</code>èŠ‚ç‚¹ï¼Œåªéœ€è¦æ›´æ–°ç›¸å…³å±æ€§å³å¯</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">wipFiber<span class="token punctuation">,</span> elements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// fiberèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token comment">// 1. å¦‚æœè€çš„`fiber`å­˜åœ¨ï¼Œåˆ™æˆ‘ä»¬å°†ä¼šç”¨æ–°çš„å…ƒç´ ä¸è€çš„`fiber`è¿›è¡Œæ¯”è¾ƒ</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">||</span> index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> oldFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> element<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token comment">// typeç±»å‹æƒ³é€šè¿‡ï¼Œæ„å‘³ç€ä¸éœ€è¦åˆ›å»ºæ–°çš„domèŠ‚ç‚¹ï¼Œåªéœ€è¦å¤ç”¨è€èŠ‚ç‚¹ï¼Œæ›´æ–°å¯¹åº”å±æ€§å°±å¯ä»¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        <span class="token literal-property property">props</span><span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        <span class="token literal-property property">dom</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
        <span class="token literal-property property">parent</span><span class="token operator">:</span> wipFiber<span class="token punctuation">,</span>
        <span class="token literal-property property">alternate</span><span class="token operator">:</span> oldFiber<span class="token punctuation">,</span>
        <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token string">&quot;UPDATE&quot;</span><span class="token punctuation">,</span> <span class="token comment">// æ›´æ–°æ ‡è¯†ä½</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè€çš„`fiber`èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    index<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>å¦‚æœç±»å‹ä¸åŒï¼Œå¹¶ä¸”å­˜åœ¨æ–°å…ƒç´ ï¼Œé‚£ä¹ˆåˆ›å»ºæ–°å…ƒç´ </li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">wipFiber<span class="token punctuation">,</span> elements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// fiberèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token comment">// 1. å¦‚æœè€çš„`fiber`å­˜åœ¨ï¼Œåˆ™æˆ‘ä»¬å°†ä¼šç”¨æ–°çš„å…ƒç´ ä¸è€çš„`fiber`è¿›è¡Œæ¯”è¾ƒ</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">||</span> index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> oldFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> element<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token comment">// æ–°çš„å…ƒç´ ä¸è€çš„`fiber`çš„ç±»å‹ä¸åŒï¼Œå¹¶ä¸”å½“å‰elementå­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        <span class="token literal-property property">props</span><span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">parent</span><span class="token operator">:</span> wipFiber<span class="token punctuation">,</span>
        <span class="token literal-property property">alternate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token string">&quot;PLACEMENT&quot;</span><span class="token punctuation">,</span> <span class="token comment">// æ’å…¥æ ‡è¯†ä½</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè€çš„`fiber`èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    index<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>å¦‚æœç±»å‹ä¸åŒï¼Œæ—§çš„<code>fiber</code>èŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™åˆ é™¤æ—§èŠ‚ç‚¹</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">wipFiber<span class="token punctuation">,</span> elements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// fiberèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token comment">// 1. å¦‚æœè€çš„`fiber`å­˜åœ¨ï¼Œåˆ™æˆ‘ä»¬å°†ä¼šç”¨æ–°çš„å…ƒç´ ä¸è€çš„`fiber`è¿›è¡Œæ¯”è¾ƒ</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">||</span> index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> oldFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> element<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token comment">// other code...</span>
    <span class="token comment">// æ–°çš„å…ƒç´ ä¸è€çš„`fiber`çš„ç±»å‹ä¸åŒï¼Œå¹¶ä¸”å½“å‰oldFiberå­˜åœ¨ï¼Œåˆ é™¤æ—§çš„èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">;</span>
      deletions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè€çš„`fiber`èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    index<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹<code>commitRoot</code>å‡½æ•°çš„å†…å®¹ï¼Œä¹‹å‰åªæœ‰<code>append</code>çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯<code>PLACEMENT</code>çš„æ ‡è¯†ä½æ“ä½œï¼Œç°åœ¨éœ€è¦æ·»åŠ <code>UPDATE</code>ä»¥åŠ<code>DELETION</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ é™¤èŠ‚ç‚¹</span>
  deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  currentRoot <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…·ä½“çš„<code>DOM</code>æ“ä½œåœ¨<code>commitWork</code>æ‰§è¡Œï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token comment">// æ·»åŠ effectæ ‡è¯†ä½å¤„ç†</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;PLACEMENT&quot;</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>dom <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// PLACEMENTï¼šæ’å…¥æ ‡è¯†ä½</span>
    domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;UPDATE&quot;</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>dom <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// UPDATEï¼šæ›´æ–°æ ‡è¯†ä½</span>
    <span class="token function">updateDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// DELETIONï¼šåˆ é™¤æ ‡è¯†ä½</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…¶ä¸­<code>UPDATE</code>æ ‡è¯†ä½éœ€è¦å¯¹å…¶å±æ€§è¿›è¡Œæ›´æ–°ï¼Œç”±äºå±æ€§è¾ƒå¤šï¼Œéœ€è¦è¿›è¡Œæ¯”è¾ƒéå†æ“ä½œï¼Œæ‰€ä»¥å°†å…¶å°è£…åœ¨<code>updateDom</code>å‡½æ•°ä¸­ï¼Œè¿˜éœ€è¦å¯¹äº‹ä»¶è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œä¸‹é¢æ˜¯æ¯”è¾ƒå±æ€§æ“ä½œ</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> key <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">isNew</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prev<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">isGone</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> prevProps<span class="token punctuation">,</span> nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// remove old properties</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isGone</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// add new properties</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> nextProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸€ç§ç‰¹æ®Šçš„å±æ€§ä¸ºäº‹ä»¶ç›‘å¬å™¨ï¼Œå› æ­¤ä»¥<code>on</code>å‰ç¼€å¼€å¤´çš„å±æ€§åæˆ‘ä»¬éƒ½éœ€è¦ç‰¹æ®Šå¤„</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">isEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> key <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isEvent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">isNew</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prev<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> prevProps<span class="token punctuation">,</span> nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// remove old or changed event listeners</span>
  <span class="token comment">// old event listeners: !(key in nextProps)</span>
  <span class="token comment">// changed event listener: isNew(prevProps, nextProps)(key)</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isEvent<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventType <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> prevProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// add new or changed event listeners</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isEvent<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventType <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> nextProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// remove old properties</span>
  <span class="token comment">// add new properties</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ç¬¬ä¸ƒæ­¥-function-components"><a href="#ç¬¬ä¸ƒæ­¥-function-components" class="header-anchor">#</a> ç¬¬ä¸ƒæ­¥ï¼š<code>Function Components</code></h2> <p>ä¸‹é¢æˆ‘ä»¬è¦åšçš„äº‹å°±æ˜¯éœ€è¦æ”¯æŒå‡½æ•°ç»„ä»¶<code>Function Components</code>ï¼Œå°†`JSXæ ¼å¼çš„å‡½æ•°å¼ç»„ä»¶è¿›è¡Œè½¬æ¢ï¼Œå°±å¾—åˆ°äº†å¦‚ä¸‹ä»£ç ç»“æ„ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello, &quot;</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å‡½æ•°å¼ç»„ä»¶ä¸»è¦æœ‰ä¸¤ç§ä¸åŒçš„åœ°æ–¹ï¼š</p> <ul><li>ä»<strong>å‡½æ•°å¼ç»„ä»¶</strong>åˆ›å»ºçš„<code>fiber</code>èŠ‚ç‚¹æ²¡æœ‰å¯¹åº”çš„<code>dom</code></li> <li>å­èŠ‚ç‚¹æ¥è‡ªäºæ‰§è¡Œå‡½æ•°ï¼Œè€Œéå…¶<code>props</code>ä¸­çš„<code>children</code>å±æ€§</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isFunctionComponent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>type <span class="token keyword">instanceof</span> <span class="token class-name">Function</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isFunctionComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// return next fiber to work on</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>nextFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ›´æ–°å‡½æ•°å¼ç»„ä»¶</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>fiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ›´æ–°å®¿ä¸»ç»„ä»¶</span>
<span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token function">createDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello, &quot;</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨<code>updateFunctionComponent</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ<strong>å‡½æ•°ç»„ä»¶æ¥è·å–å…¶å­èŠ‚ç‚¹</strong>ï¼Œå¹¶å°†å…¶å±æ€§ä½œä¸ºå‚æ•°å€¼è¿›è¡Œä¼ å…¥ã€‚å¦‚ä¸Šé¢çš„<code>App</code>å‡½æ•°ï¼Œåœ¨æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ª<code>h1</code>å¯¹åº”çš„å…ƒç´ èŠ‚ç‚¹ã€‚ç„¶åï¼Œä¸€æ—¦æˆ‘ä»¬ç”Ÿæˆå¯¹åº”çš„<code>children</code>ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼è°ƒç”¨<code>reconcileChildren</code>å‡½æ•°</p> <p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦åšçš„ä¸€ä¸ªæ”¹å˜å°±æ˜¯ï¼Œç”±äºå‡½æ•°ç»„ä»¶æ²¡æœ‰å¯¹åº”çš„<code>dom</code>å±æ€§ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¿®æ”¹<code>commitWork</code>å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å‘ä¸Šå±‚æŸ¥æ‰¾æœ€è¿‘å«æœ‰domå±æ€§çš„fiber</span>
  <span class="token keyword">let</span> domParentFiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>domParentFiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParentFiber <span class="token operator">=</span> domParentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> domParentFiber<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;PLACEMENT&quot;</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>dom <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// PLACEMENTï¼šæ’å…¥æ ‡è¯†ä½</span>
    domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;UPDATE&quot;</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>dom <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// UPDATEï¼šæ›´æ–°æ ‡è¯†ä½</span>
    <span class="token function">updateDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// DELETIONï¼šåˆ é™¤æ ‡è¯†ä½</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> domParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> domParent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">,</span> domParent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é¦–å…ˆï¼Œç”±äºå‡½æ•°ç»„ä»¶æ²¡æœ‰å…¶<code>dom</code>å±æ€§ï¼Œæ‰€ä»¥éœ€è¦å‘ä¸Šå±‚é€’å½’æ‰¾åˆ°å¯¹åº”å­˜åœ¨<code>dom</code>å±æ€§å€¼çš„<code>fiber</code>èŠ‚ç‚¹ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåˆ é™¤èŠ‚ç‚¹éœ€è¦é€’å½’å°†å…¶å‡½æ•°ç»„ä»¶ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œåˆ é™¤</p> <h2 id="ç¬¬å…«æ­¥-hooks"><a href="#ç¬¬å…«æ­¥-hooks" class="header-anchor">#</a> ç¬¬å…«æ­¥ï¼š<code>Hooks</code></h2> <p>æœ€åä¸€æ­¥ï¼Œéœ€è¦ç»™å‡½æ•°ç»„ä»¶æ·»åŠ çŠ¶æ€ã€‚æˆ‘ä»¬å…ˆæ·»åŠ ä¸€ä¸ªå…¸å‹çš„<code>Counter</code>ç»„ä»¶ï¼Œæ¯æ¬¡ç‚¹å‡»åï¼Œéƒ½ä¼šå°†çŠ¶æ€å€¼åŠ 1</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Deact <span class="token operator">=</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
  createTextElement<span class="token punctuation">,</span>
  render<span class="token punctuation">,</span>
  useState<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Count: &quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Increment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="usestate"><a href="#usestate" class="header-anchor">#</a> <code>useState</code></h3> <p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç›´æ¥è°ƒç”¨äº†<code>Deact</code>å¯¹è±¡çš„<code>useState</code>æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>Deact</code>å¯¹è±¡ä¸­å¥–<code>useState</code>æš´éœ²å‡ºå»ã€‚ä¸ºäº†å®ç°<code>useState</code>å‡½æ•°ï¼Œéœ€è¦åšä»¥ä¸‹å·¥ä½œï¼š</p> <ol><li>éœ€è¦ä¸€ä¸ªå…¨å±€å˜é‡ä¿å­˜å½“å‰æ­£åœ¨æ‰§è¡Œçš„<code>fiber</code>èŠ‚ç‚¹ï¼Œä»¥ä¾¿å°†å¯¹åº”çš„<code>hook</code>ä¿¡æ¯æŒ‚è½½åœ¨ä¸Šé¢</li> <li>éœ€è¦ä¸€ä¸ªå…¨å±€çš„<code>hook</code>çš„ç´¢å¼•å˜é‡ï¼Œä½¿ç”¨è¯¥ç´¢å¼•è·å–æ›´æ–°å‰<code>fiber</code>å¯¹åº”çš„<code>hook</code>ï¼Œå¹¶ä»¥æ­¤è·å–å…¶ä¸­çš„<code>state</code>å€¼è¿›è¡Œä½¿ç”¨</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> wipFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hookIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// æ›´æ–°å‡½æ•°å¼ç»„ä»¶</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  hookIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  wipFiber<span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>fiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œ<code>updateFunctionComponent</code>å‡½æ•°ä¸­ï¼Œå°†å¯¹åº”çš„å˜é‡è¿›è¡Œäº†é‡ç½®ï¼Œå¹¶å°†<code>wipFiber.hooks</code>è®¾ç½®ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œï¼Œç„¶åä¼šè°ƒç”¨<code>fiber.type</code>è¿›è¡Œæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œå‡½æ•°ç»„ä»¶ï¼Œåœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨<code>useState</code>æ–¹æ³•ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡<code>useState</code>ï¼Œå°±ä¼šå‘å…¶ä¸­æ¨å…¥ä¸€ä¸ª<code>hook</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¿å­˜ç€çŠ¶æ€å€¼<code>state</code>ä»¥åŠæ›´æ–°é˜Ÿåˆ—<code>queue</code>ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹åˆ›å»ºå¯¹åº”çš„<code>useState</code>æ–¹æ³•</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initial</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span>
    wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> oldHook <span class="token operator">?</span> oldHook<span class="token punctuation">.</span>state <span class="token operator">:</span> initial<span class="token punctuation">,</span>
    <span class="token literal-property property">queue</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> actions <span class="token operator">=</span> oldHook <span class="token operator">?</span> oldHook<span class="token punctuation">.</span>queue <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  actions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    hook<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>hook<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token operator">||</span> initial<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// some code...</span>
  <span class="token punctuation">}</span>
  wipFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  hookIndex<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„<code>useState</code>å‡½æ•°ä¸»è¦åšäº†å‡ ä»¶äº‹ï¼š</p> <ol><li>é€šè¿‡<code>hookIndex</code>ç´¢å¼•åœ¨<code>wipFiber.hooks</code>ä¸­å–å‡ºå¯¹åº”çš„<code>oldHook</code>ï¼Œä¹Ÿè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½å°†<code>hook</code>å†™åœ¨æ¡ä»¶è¯­å¥ä¸­çš„åŸå› ï¼Œä¸åŒæ¡ä»¶åï¼Œ<code>hookIndex</code>æ‰€å¯¹åº”çš„<code>hook</code>å¯¹è±¡ä¸ç›¸åŒï¼Œä¼šå¯¼è‡´å€¼æ›´æ–°é”™è¯¯</li> <li>ä»<code>oldHook</code>ä¸­å–å‡º<code>state</code>ä»¥åŠ<code>actions</code>ï¼Œä¾æ¬¡æ‰§è¡Œ<code>action</code>å‡½æ•°ï¼Œè·å¾—æœ€æ–°<code>hook.state</code>çš„å€¼å°†å…¶å­˜å…¥</li> <li>åˆ›å»º<code>setState</code>å‡½æ•°ï¼Œå°†<code>state</code>ä»¥<code>setState</code>å‡½æ•°ä¸€èµ·ä¼ é€’åˆšç»™å¤–éƒ¨</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¤ç”¨å½“å‰currentRootçš„domä»¥åŠpropsï¼Œå¹¶å°†å½“å‰é¡µé¢æ¸²æŸ“çš„fiberä½œä¸ºalternateå±æ€§</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">dom</span><span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
    <span class="token literal-property property">alternate</span><span class="token operator">:</span> currentRoot<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
  deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢æ˜¯<code>setState</code>çš„å®ç°è¿‡ç¨‹ï¼Œæ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œå°†ä¼ å…¥çš„å‡½æ•°ä½œä¸º<code>action</code>ï¼Œæ”¾å…¥<code>hook</code>çš„æ›´æ–°é˜Ÿåˆ—<code>queue</code>ä¸­ï¼Œå¹¶è®¾ç½®<code>wipRoot</code>ä»¥åŠ<code>nextUnitOfWork</code>å˜é‡ï¼Œç”±äºä»£ç ä¸­çš„<code>workLoop</code>å‡½æ•°åœ¨æµè§ˆå™¨æœ‰ç©ºé—²æ—¶é—´æ—¶ä¸€ç›´å¾ªç¯æ‰§è¡Œçš„ï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¼šä¸€ç›´æ‰“å°ä¸‹é¢çš„<code>workLoop</code>æ—¥å¿—ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'workLoop'</span><span class="token punctuation">,</span> deadline<span class="token punctuation">,</span> nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> wipRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æ‰§è¡Œ<code>workLoop</code>å‡½æ•°åï¼Œå‘ç°å½“å‰çš„<code>nextUnitOfWork</code>å˜é‡å­˜åœ¨ï¼Œåˆ™ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œ<code>performUnitOfWork</code>å‡½æ•°ï¼Œç”Ÿæˆæ–°çš„<code>fiber</code>æ ‘ï¼Œé‡æ–°æ‰§è¡Œå‡½æ•°ç»„ä»¶ä»¥åŠ<code>useState</code>å‡½æ•°ï¼Œéå†<code>actions</code>ç”Ÿæˆæœ€æ–°çš„<code>state</code>æ¥æ›´æ–°ç»„ä»¶çŠ¶æ€ï¼Œå¹¶è¿›è¡Œæ˜¾ç¤ºã€‚</p> <h3 id="useeffect"><a href="#useeffect" class="header-anchor">#</a> <code>useEffect</code></h3> <p><code>useEffect</code>æ˜¯ä¼ å…¥ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ï¼Œç„¶åæ ¹æ®æ˜¯å¦ä¼ å…¥ä¾èµ–å€¼ä»¥åŠä¾èµ–å€¼æ˜¯å¦å˜åŒ–æ¥åˆ¤æ–­è¯¥å‰¯ä½œç”¨å‡½æ•°æ˜¯å¦æ‰§è¡Œã€‚æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ</p> <ul><li>æ²¡æœ‰ä¼ å…¥ä¾èµ–å€¼<code>deps</code>ï¼Œåˆ™æ¯æ¬¡æ‰§è¡Œç»„ä»¶å‡½æ•°ä¹Ÿå°±æ˜¯ç»„ä»¶æ›´æ–°æ—¶éƒ½ä¼šæ‰§è¡Œ</li> <li>ä¼ å…¥ä¸€ä¸ªç©ºæ•°ç»„ä½œä¸ºä¾èµ–å€¼ï¼Œé‚£ä¹ˆåªåœ¨ç¬¬ä¸€æ¬¡ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œ</li> <li>ä¼ å…¥çŠ¶æ€ä½œä¸ºä¾èµ–å€¼ï¼Œåˆ™æ¯æ¬¡æ‰§è¡Œå‡½æ•°ç»„ä»¶æ—¶ä¼šåˆ¤æ–­è¯¥ä¾èµ–æ˜¯å¦è¢«æ›´æ–°ï¼Œå¦‚æœä¸¤æ¬¡ä¾èµ–å€¼ä¸åŒåˆ™æ›´æ–°</li> <li>å‰¯ä½œç”¨å‡½æ•°è¿˜å¯ä»¥è¿”å›ä¸€ä¸ª<code>cleanup</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ä¸‹ä¸€æ¬¡æ›´æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ä¹‹å‰æ‰§è¡Œ</li></ul> <p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½¿ç”¨<code>useEffect</code>æ—¶ï¼Œæ˜¯è¿›è¡Œå‰¯ä½œç”¨å‡½æ•°ä»¥åŠä¾èµ–çš„æ”¶é›†ï¼Œåœ¨å®Œæˆ<code>commit</code>é˜¶æ®µåæ‰ä¼šä»<code>wipRoot</code>èŠ‚ç‚¹å¼€å§‹æ·±åº¦éå†æ‰€æœ‰çš„<code>fiber</code>ï¼Œæ‰¾åˆ°é‡Œé¢çš„<code>hooks</code>ï¼Œå–å‡ºæ‰€æœ‰çš„<code>effect</code>å‡½æ•°æ¥è¿›è¡Œæ‰§è¡Œ</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span>
    wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    effect<span class="token punctuation">,</span>
    deps<span class="token punctuation">,</span>
    <span class="token literal-property property">cleanup</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token literal-property property">_tag</span><span class="token operator">:</span> <span class="token string">'effect'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">queue</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>oldHook <span class="token operator">&amp;&amp;</span> <span class="token function">isEffectHook</span><span class="token punctuation">(</span>oldHook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hasDepsChange <span class="token operator">=</span> <span class="token operator">!</span>deps <span class="token operator">||</span> <span class="token operator">!</span>oldHook<span class="token punctuation">.</span>deps <span class="token operator">||</span> deps<span class="token punctuation">.</span>length <span class="token operator">!==</span> oldHook<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">||</span> deps<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dep <span class="token operator">!==</span> oldHook<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>hasDepsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hook<span class="token punctuation">.</span>cleanup <span class="token operator">=</span> oldHook<span class="token punctuation">.</span>cleanup<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ²¡æœ‰ä¾èµ–é¡¹æ”¹å˜ï¼Œåˆ™ç›´æ¥å¤ç”¨æ—§çš„effect hook</span>
      <span class="token comment">// No change in deps, skip this effect</span>
      hook<span class="token punctuation">.</span>cleanup <span class="token operator">=</span> oldHook<span class="token punctuation">.</span>cleanup<span class="token punctuation">;</span>
      hook<span class="token punctuation">.</span>effect <span class="token operator">=</span> oldHook<span class="token punctuation">.</span>effect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  wipFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  hookIndex<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">shouldRunEffect</span><span class="token punctuation">(</span><span class="token parameter">currentHook<span class="token punctuation">,</span> previousHook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If previousHook doesn't exist or its deps don't exist, run the effect</span>
  <span class="token comment">// If currentHook's deps don't exist, run the effect everytime</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>previousHook <span class="token operator">||</span> <span class="token operator">!</span>previousHook<span class="token punctuation">.</span>deps <span class="token operator">||</span> <span class="token operator">!</span>currentHook<span class="token punctuation">.</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> currentHook<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dep <span class="token operator">!==</span> previousHook<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">runEffectsRecursively</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> preFiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    fiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">hook<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEffectHook</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> effectHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
      <span class="token keyword">const</span> previousHook <span class="token operator">=</span> preFiber <span class="token operator">&amp;&amp;</span> preFiber<span class="token punctuation">.</span>hooks <span class="token operator">?</span> preFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> shouldRun <span class="token operator">=</span> <span class="token function">shouldRunEffect</span><span class="token punctuation">(</span>effectHook<span class="token punctuation">,</span> previousHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// éœ€è¦æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°å¹¶ä¸”å½“å‰effectHookæœ‰ä¿å­˜ä¸Šä¸€æ¬¡çš„cleaupå‡½æ•°</span>
      <span class="token comment">// æ‰§è¡Œcleanupå‡½æ•°</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>shouldRun <span class="token operator">&amp;&amp;</span> effectHook<span class="token punctuation">.</span>cleanup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effectHook<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        effectHook<span class="token punctuation">.</span>cleanup <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>shouldRun<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ”¶é›†cleanupå‡½æ•°ä»¥ä¾¿ä¸‹æ¬¡è°ƒç”¨</span>
        <span class="token keyword">const</span> cleanup <span class="token operator">=</span> effectHook<span class="token punctuation">.</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cleanup <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> cleanup <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          effectHook<span class="token punctuation">.</span>cleanup <span class="token operator">=</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">runEffectsRecursively</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">runEffectsRecursively</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æäº¤é˜¶æ®µå®Œæˆåè¿›è¡Œå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ</span>
  <span class="token comment">// When your component commits, React will run your setup function</span>
  <span class="token function">runEffectsRecursively</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  currentRoot <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="usememo"><a href="#usememo" class="header-anchor">#</a> <code>useMemo</code></h3> <p><code>useMemo</code>å¯ä»¥ç¼“å­˜åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´çš„è®¡ç®—ç»“æœï¼Œä½¿ç”¨æ–¹å¼ï¼š<code>const cachedValue = useMemo(calculateValue, dependencies)</code></p> <p><code>Parameters</code>ï¼š</p> <ul><li><code>calculateValue</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›ä½ æƒ³è¦ç¼“å­˜çš„å€¼ï¼Œè¯¥å‡½æ•°åº”è¯¥æ˜¯ä¸€ä¸ª<strong>å­˜å‡½æ•°</strong>ï¼Œåº”è¯¥æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥è¿”å›ä»»ä½•ç±»å‹çš„å€¼ã€‚<code>React</code>å°†ä¼šåœ¨åˆæ¬¡æ¸²æŸ“çš„æ—¶å€™è°ƒç”¨è¯¥å‡½æ•°ã€‚åœ¨æ¥ä¸‹æ¥çš„æ¸²æŸ“ä¸­ï¼Œ<code>React</code>å°†ä¼šè¿”å›ç›¸åŒçš„å€¼ï¼Œå¦‚æœ<code>dependencies</code>æ²¡æœ‰æ”¹å˜ã€‚å¦åˆ™ï¼Œåˆ™å°±è°ƒç”¨è¯¥å‡½æ•°ï¼Œé‡æ–°è¿”å›è®¡ç®—ç»“æœï¼Œå¹¶å°†å…¶ç»“æœå­˜å‚¨èµ·æ¥ã€‚</li> <li><code>dependencies</code>ï¼šåœ¨<code>calculateValue</code>å‡½æ•°ä¸­ä¾èµ–çš„å“åº”å€¼åˆ—è¡¨ã€‚å“åº”å€¼åŒ…å«<code>props</code>ã€<code>state</code>å’Œæ‰€æœ‰åœ¨ç»„ä»¶å†…éƒ¨å£°æ˜çš„å˜é‡ä»¥åŠå‡½æ•°ã€‚<code>React</code>å°†ä¼šä½¿ç”¨<code>Object.is</code>å‡½æ•°æ¥å°†å…¶ä¹‹å‰çš„æ¯ä¸€ä¸ªä¾èµ–å€¼ä¸ç°åœ¨è¿›è¡Œæ¯”è¾ƒã€‚</li></ul> <p>æ ¹æ®ä¸Šé¢ğŸ‘†ğŸ»ä½¿ç”¨æ–¹æ³•å¯ä»¥å¾—åˆ°ä¸‹é¢çš„ä¿¡æ¯ï¼š</p> <ul><li><code>useMemo</code>éœ€è¦ä¿å­˜è®¡ç®—å€¼ä»¥åŠä¾èµ–ï¼Œåˆ¤æ–­å‰ä¸€æ¬¡ä¾èµ–ä¸æœ¬æ¬¡æ˜¯å¦ç›¸åŒï¼Œä¸ç›¸åŒåˆ™é‡æ–°å¯¹å€¼è¿›è¡Œè®¡ç®—</li> <li><code>useMemo</code>ä¸ä¼šåœ¨ä¾èµ–ä¿®æ”¹çš„æ—¶å€™è§¦å‘é‡æ–°æ¸²æŸ“ï¼Œåªä¼šåœ¨ç»„ä»¶æ‰§è¡ŒæœŸé—´æ ¹æ®ä¾èµ–é¡¹æ˜¯å¦å˜åŒ–åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å€¼</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// useMemo hook</span>
<span class="token keyword">function</span> <span class="token function">isMemoHook</span><span class="token punctuation">(</span><span class="token parameter">hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> hook <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hook <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> hook<span class="token punctuation">.</span>_tag <span class="token operator">===</span> <span class="token string">'memo'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token parameter">factory<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span> wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">_tag</span><span class="token operator">:</span> <span class="token string">'memo'</span><span class="token punctuation">,</span>
    deps<span class="token punctuation">,</span>
    factory<span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> valu
  <span class="token keyword">if</span><span class="token punctuation">(</span>oldHook <span class="token operator">&amp;&amp;</span> <span class="token function">isMemoHook</span><span class="token punctuation">(</span>oldHook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> hasDepsChange <span class="token operator">=</span> <span class="token operator">!</span>deps <span class="token operator">||</span> <span class="token operator">!</span>oldHook<span class="token punctuation">.</span>deps <span class="token operator">||</span> deps<span class="token punctuation">.</span>length <span class="token operator">!==</span> oldHook<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">||</span> deps<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dep <span class="token operator">!==</span> oldHook<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>hasDepsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> oldHook<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>state <span class="token operator">=</span> value<span class="token punctuation">;</span>

  wipFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  hookIndex<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> hook<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="usecallback"><a href="#usecallback" class="header-anchor">#</a> <code>useCallback</code></h3> <p><code>useCallback</code>æ˜¯ä¸€ä¸ª<code>React</code>çš„<code>Hook</code>ï¼Œå®ƒå¯ä»¥è®©ä½ åœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ç¼“å­˜å‡½æ•°ï¼Œä½¿ç”¨æ–¹å¼ä¸º<code>useCallback(fn, dependencies)</code></p> <p>ä½¿ç”¨<code>useCallback</code>ç¼“å­˜å‡½æ•°åªåœ¨ä¸‹é¢çš„åœºæ™¯ä¸­æœ‰ä»·å€¼ï¼š</p> <ul><li>å°†ç¼“å­˜çš„å‡½æ•°ä½œä¸ºä¸€ä¸ª<code>prop</code>ä¼ é€’ç»™ä¸€ä¸ªè¢«<code>memo</code>åŒ…è£¹çš„ç»„ä»¶ã€‚ä½ æƒ³è¦åœ¨ä¾èµ–å€¼æ²¡æœ‰ä¿®æ”¹æ—¶è·³è¿‡é‡æ–°æ¸²æŸ“ã€‚<code>Memozation</code>å¯ä»¥è®©ç»„ä»¶åªåœ¨ä¾èµ–é¡¹æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“</li> <li>ç¼“å­˜çš„å‡½æ•°è¢«ä½œä¸ºäº†å…¶ä»–<code>Hook</code>çš„ä¾èµ–é¡¹ã€‚ä¾‹å¦‚ï¼Œå¦ä¸€ä¸ªè¢«<code>useCallback</code>åŒ…è£¹çš„å‡½æ•°ä¾èµ–å®ƒæˆ–è€…åœ¨<code>useEffect</code>ä¸­ä½¿ç”¨äº†ä¾èµ–äº†è¯¥å‡½æ•°</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// useCallback hook</span>
<span class="token keyword">function</span> <span class="token function">isCallbackHook</span><span class="token punctuation">(</span><span class="token parameter">hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> hook <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hook <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> hook<span class="token punctuation">.</span>_tag <span class="token operator">===</span> <span class="token string">'callback'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span> wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span> wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">_tag</span><span class="token operator">:</span> <span class="token string">'callback'</span><span class="token punctuation">,</span>
    deps<span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> callback<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>oldHook <span class="token operator">&amp;&amp;</span> <span class="token function">isCallbackHook</span><span class="token punctuation">(</span>oldHook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hasDepsChange <span class="token operator">=</span> <span class="token operator">!</span>deps <span class="token operator">||</span> <span class="token operator">!</span>oldHook<span class="token punctuation">.</span>deps <span class="token operator">||</span> deps<span class="token punctuation">.</span>length <span class="token operator">!==</span> oldHook<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">||</span> deps<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dep <span class="token operator">!==</span> oldHook<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>hasDepsChange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hook<span class="token punctuation">.</span>state <span class="token operator">=</span> oldHook<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  wipFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  hookIndex<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> hook<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="usecontext"><a href="#usecontext" class="header-anchor">#</a> <code>useContext</code></h3> <p><code>useContext</code>æ˜¯ä¸€ä¸ªå¯ä»¥è¯»å–ä»¥åŠè®¢é˜…ä¸Šä¸‹æ–‡<code>context</code>çš„<code>hook</code>ï¼Œä½¿ç”¨æ—¶é€šå¸¸éœ€è¦æ­é…<code>createContext</code>ä»¥åŠ<code>Provider</code>ä¸€èµ·ä½¿ç”¨ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡</span>
<span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token string">'light'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">ThemeApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>theme<span class="token punctuation">,</span> setTheme<span class="token punctuation">]</span> <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'dark'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
    ThemeContext<span class="token punctuation">.</span>Provider<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> theme <span class="token punctuation">}</span><span class="token punctuation">,</span>
    Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>ThemeChild<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTheme</span><span class="token punctuation">(</span>theme <span class="token operator">===</span> <span class="token string">'dark'</span> <span class="token operator">?</span> <span class="token string">'light'</span> <span class="token operator">:</span> <span class="token string">'dark'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Toggle Theme'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ThemeChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> theme <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>ThemeContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Current Theme: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>theme<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹<code>createContext</code>åšäº†ä»€ä¹ˆï¼Œæ ¹æ®è¿™ä¸ªåç§°å¯ä»¥æŒ‡å®šæ˜¯åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¯¹è±¡é‡Œé¢è‡³å°‘éœ€è¦åŒ…å«<code>Provider</code>ä»¥åŠ<code>Consumer</code>ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¸€ä¸ªå‘å­ç»„ä»¶æä¾›ä¸Šä¸‹æ–‡ï¼Œä¸€ä¸ªå¯ä»¥ç”¨æ¥æ¶ˆè´¹ä¸Šä¸‹æ–‡</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// createContext hook</span>
<span class="token keyword">function</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">defaultValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">_value</span><span class="token operator">:</span> defaultValue<span class="token punctuation">,</span> <span class="token comment">// é»˜è®¤å€¼</span>
    <span class="token literal-property property">_currentValue</span><span class="token operator">:</span> defaultValue<span class="token punctuation">,</span> <span class="token comment">// Provider æä¾›çš„å½“å‰å€¼</span>
    <span class="token literal-property property">Provider</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">Consumer</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">_subscribers</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// è®¢é˜…è€…é›†åˆï¼Œå­˜å‚¨æ‰€æœ‰ä½¿ç”¨è¯¥ context çš„ fiber èŠ‚ç‚¹</span>
    <span class="token literal-property property">_needsUpdate</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// æ ‡è®°æ˜¯å¦éœ€è¦æ›´æ–°è®¢é˜…è€…</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Provider ç»„ä»¶</span>
  <span class="token keyword">function</span> <span class="token function">Provider</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ ‡è®° Provider ç»„ä»¶å¯¹åº”çš„ contextï¼Œç”¨äºåœ¨ updateFunctionComponent ä¸­è¯†åˆ«</span>
  Provider<span class="token punctuation">.</span>_context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>Provider <span class="token operator">=</span> Provider<span class="token punctuation">;</span>
  
  <span class="token comment">// Consumer ç»„ä»¶ï¼ˆå¯é€‰ï¼Œé€šå¸¸ä½¿ç”¨ useContextï¼‰</span>
  context<span class="token punctuation">.</span><span class="token function-variable function">Consumer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Consumer</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ<code>Provider</code>æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ç»„ä»¶ï¼Œå°†å…¶<code>props.children</code>å±æ€§è¿”å›è¿›è¡Œå­ç»„ä»¶æ¸²æŸ“ã€‚é‡ç‚¹æ˜¯å°†å½“å‰ä¸Šä¸‹æ–‡å¯¹è±¡<code>context</code>æŒ‚è½½åœ¨äº†<code>Provider._context</code>å¯¹è±¡ä¸Šï¼Œä»¥ä¾¿æ¸²æŸ“çš„æ—¶å€™ä½¿ç”¨ã€‚</p> <p>æ¥ä¸‹æ¥æ˜¯<code>useContext</code>ï¼Œæ ¹æ®å‰é¢çš„å®šä¹‰ï¼Œä½¿ç”¨è¯¥<code>hook</code>å¯ä»¥è¯»å–ä»¥åŠè®¢é˜…ä¼ å…¥çš„ä¸Šä¸‹æ–‡å¯¹è±¡</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// useContext hook</span>
<span class="token keyword">function</span> <span class="token function">useContext</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span>
    wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å‘ä¸Šéå† fiber æ ‘ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„ Provider</span>
  <span class="token keyword">let</span> fiber <span class="token operator">=</span> wipFiber<span class="token punctuation">;</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> context<span class="token punctuation">.</span>_value<span class="token punctuation">;</span> <span class="token comment">// é»˜è®¤å€¼</span>
  <span class="token keyword">let</span> providerFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ä»å½“å‰èŠ‚ç‚¹å‘ä¸Šå±‚éå†parentï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„æä¾›contextå¯¹è±¡çš„Provider</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ£€æŸ¥å½“å‰ fiber æ˜¯å¦æœ‰ context å€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>context <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>context<span class="token punctuation">[</span>context<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> fiber<span class="token punctuation">.</span>context<span class="token punctuation">[</span>context<span class="token punctuation">]</span><span class="token punctuation">;</span>
      providerFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ° Providerï¼Œä½¿ç”¨ context çš„å½“å‰å€¼ï¼ˆå¯èƒ½æ˜¯é»˜è®¤å€¼æˆ–ä¹‹å‰çš„å€¼ï¼‰</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>providerFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> context<span class="token punctuation">.</span>_currentValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  
  <span class="token comment">// é‡ç‚¹ï¼šä¸ºå½“å‰ä¸Šä¸‹æ–‡æ·»åŠ å¯¹è¯¥fiberçš„è®¢é˜…</span>
  context<span class="token punctuation">.</span>_subscribers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wipFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">_tag</span><span class="token operator">:</span> <span class="token string">'context'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> value<span class="token punctuation">,</span>
    <span class="token literal-property property">context</span><span class="token operator">:</span> context<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  
  wipFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  hookIndex<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºåšäº†ä¸¤ä¸ªé‡è¦çš„äº‹ï¼š</p> <ul><li>ç¬¬ä¸€ä¸ªæ˜¯ä»å½“å‰<code>fiber</code>ä¾æ¬¡å‘ä¸Šå±‚æŸ¥æ‰¾åŒ…å«è¯¥ä¸Šä¸‹æ–‡<code>context</code>çš„<code>fiber</code>èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯¥<code>fiber</code>å°±æ˜¯å…·æœ‰ä¸Šä¸‹æ–‡å¯¹è±¡çš„<code>Provider</code></li> <li>å°†è¯¥<code>fiber</code>æ·»åŠ åˆ°ä¸Šä¸‹æ–‡çš„è®¢é˜…ä¸­ï¼Œä»¥ä¾¿çŠ¶æ€å€¼æ›´æ–°åä¼šæ›´æ–°å¯¹åº”çš„<code>fiber</code></li></ul> <p>åªå®Œæˆä¸Šé¢ä¸¤ä¸ªå‡½æ•°è¿˜ä¸è¶³ä»¥å®ç°è¯¥åŠŸèƒ½ï¼Œåœ¨<code>useContext</code>å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°<code>Provider</code>å¯¹åº”çš„<code>fiberNode</code>ä¸­åŒ…å«<code>context</code>å±æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å†<code>updateFunctionComponent</code>å‡½æ•°ä¸­æ·»åŠ å¯¹åº”çš„å¤„ç†</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ›´æ–°å‡½æ•°å¼ç»„ä»¶</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  hookIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  wipFiber<span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å¦‚æœç»„ä»¶æ˜¯ Providerï¼Œå…ˆè®¾ç½® context å€¼</span>
  <span class="token comment">// è¿™æ ·åœ¨æ¸²æŸ“å­ç»„ä»¶æ—¶ï¼ŒuseContext å°±èƒ½è®¿é—®åˆ° context å€¼</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> fiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> context<span class="token punctuation">.</span>_currentValue<span class="token punctuation">;</span>
    <span class="token comment">// Provider ç»„ä»¶çš„å›ºå®šå‘å…¶ä¸­ä¼ å…¥valueå€¼ï¼Œæ‰€ä»¥éœ€è¦ä»propsä¸­è·å–</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    
    <span class="token comment">// å­˜å‚¨åˆ° fiber èŠ‚ç‚¹ä¸Šï¼Œä¾› useContext æŸ¥æ‰¾</span>
    <span class="token comment">// ä¸€ä¸ª fiber èŠ‚ç‚¹ä¸Šï¼Œå¯èƒ½æœ‰å¤šä¸ª context å¯¹è±¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wipFiber<span class="token punctuation">.</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wipFiber<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    wipFiber<span class="token punctuation">.</span>context<span class="token punctuation">[</span>context<span class="token punctuation">]</span> <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
    
    <span class="token comment">// å¦‚æœå€¼æ”¹å˜äº†ï¼Œæ ‡è®° context éœ€è¦æ›´æ–°</span>
    <span class="token comment">// å®é™…çš„æ›´æ–°ä¼šåœ¨ commitRoot å®Œæˆåè¿›è¡Œ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span>_needsUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// å…ˆæ›´æ–°å½“å‰å€¼ï¼Œä¾›æœ¬æ¬¡æ¸²æŸ“ä½¿ç”¨</span>
      context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">const</span> context <span class="token operator">=</span> fiber<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">;</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> context <span class="token operator">?</span> context<span class="token punctuation">.</span><span class="token function">Provider</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span>fiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸Šé¢æ¯”è¾ƒäº†<code>context</code>ä¸­å€¼çš„æ˜¯å¦å˜åŒ–ï¼Œæœ‰å˜åŒ–åˆ™æ›´æ–°çŠ¶æ€å€¼å¹¶æ·»åŠ å¯¹åº”çš„æ ‡è¯†ç¬¦ï¼Œæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯åœ¨æäº¤<code>commit</code>é˜¶æ®µï¼Œåˆ¤æ–­æ›´æ–°çŠ¶æ€</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">runEffectsRecursively</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ£€æŸ¥æ˜¯å¦æœ‰ context éœ€è¦æ›´æ–°ï¼ˆæ£€æŸ¥æœ¬æ¬¡æ¸²æŸ“çš„æ ‘ï¼‰</span>
  <span class="token keyword">const</span> contextsToUpdate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">collectContexts</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// æ£€æŸ¥æ˜¯å¦æ˜¯ Provider ç»„ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> context <span class="token operator">=</span> fiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>_needsUpdate <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>_subscribers<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        contextsToUpdate<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>_needsUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// é‡ç½®æ ‡è®°</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">collectContexts</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">collectContexts</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">collectContexts</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> rootToCommit <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
  currentRoot <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å¦‚æœæœ‰ context æ›´æ–°ï¼Œè§¦å‘è®¢é˜…è€…é‡æ–°æ¸²æŸ“</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>contextsToUpdate<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rootToCommit <span class="token operator">&amp;&amp;</span> rootToCommit<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ”¶é›†æ‰€æœ‰éœ€è¦æ›´æ–°çš„è®¢é˜…è€…</span>
    <span class="token keyword">const</span> subscribersToUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    contextsToUpdate<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span>_subscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">subscriber</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          subscribersToUpdate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæœ‰è®¢é˜…è€…éœ€è¦æ›´æ–°ï¼Œè§¦å‘é‡æ–°æ¸²æŸ“</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribersToUpdate<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä»æ ¹èŠ‚ç‚¹é‡æ–°æ¸²æŸ“</span>
      wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">dom</span><span class="token operator">:</span> rootToCommit<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
        <span class="token literal-property property">props</span><span class="token operator">:</span> rootToCommit<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        <span class="token literal-property property">alternate</span><span class="token operator">:</span> rootToCommit<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      nextUnitOfWork <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
      deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="header-anchor">#</a> å‚è€ƒ</h2> <ul><li><a href="https://pomb.us/build-your-own-react/" target="_blank" rel="noopener noreferrer">build your own react<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/knowledge/react/03.bit.html" class="prev">
        Bit
      </a></span> <span class="next"><a href="/knowledge/react/source-code-analysis/01.travers-fiber-tree.html">
        Travers Fiber Tree
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge/assets/js/app.5153ca81.js" defer></script><script src="/knowledge/assets/js/2.09711cee.js" defer></script><script src="/knowledge/assets/js/1.ecac6abe.js" defer></script><script src="/knowledge/assets/js/84.98c35d72.js" defer></script>
  </body>
</html>
