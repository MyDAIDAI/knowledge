<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Build Yourself a Redux | é‚“æ”€çš„æŠ€æœ¯åšå®¢</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge/assets/css/0.styles.19179342.css" as="style"><link rel="preload" href="/knowledge/assets/js/app.5153ca81.js" as="script"><link rel="preload" href="/knowledge/assets/js/2.09711cee.js" as="script"><link rel="preload" href="/knowledge/assets/js/1.ecac6abe.js" as="script"><link rel="preload" href="/knowledge/assets/js/89.aa1e2fe4.js" as="script"><link rel="prefetch" href="/knowledge/assets/js/10.61451e43.js"><link rel="prefetch" href="/knowledge/assets/js/100.fb313dd8.js"><link rel="prefetch" href="/knowledge/assets/js/101.f6084221.js"><link rel="prefetch" href="/knowledge/assets/js/11.0d8da72b.js"><link rel="prefetch" href="/knowledge/assets/js/12.7874f28d.js"><link rel="prefetch" href="/knowledge/assets/js/13.7e77d130.js"><link rel="prefetch" href="/knowledge/assets/js/14.73222ce7.js"><link rel="prefetch" href="/knowledge/assets/js/15.0b07f9b9.js"><link rel="prefetch" href="/knowledge/assets/js/16.2cc5269e.js"><link rel="prefetch" href="/knowledge/assets/js/17.4dc16511.js"><link rel="prefetch" href="/knowledge/assets/js/18.0f42d2d9.js"><link rel="prefetch" href="/knowledge/assets/js/19.d5eb91b2.js"><link rel="prefetch" href="/knowledge/assets/js/20.748f25e2.js"><link rel="prefetch" href="/knowledge/assets/js/21.518a3952.js"><link rel="prefetch" href="/knowledge/assets/js/22.215fc719.js"><link rel="prefetch" href="/knowledge/assets/js/23.85574af4.js"><link rel="prefetch" href="/knowledge/assets/js/24.179f0801.js"><link rel="prefetch" href="/knowledge/assets/js/25.e813b79e.js"><link rel="prefetch" href="/knowledge/assets/js/26.ea3c2f8a.js"><link rel="prefetch" href="/knowledge/assets/js/27.d9a0e0aa.js"><link rel="prefetch" href="/knowledge/assets/js/28.499e6f9d.js"><link rel="prefetch" href="/knowledge/assets/js/29.7ecc7047.js"><link rel="prefetch" href="/knowledge/assets/js/3.6c565688.js"><link rel="prefetch" href="/knowledge/assets/js/30.938ba476.js"><link rel="prefetch" href="/knowledge/assets/js/31.0a6ecdcd.js"><link rel="prefetch" href="/knowledge/assets/js/32.8aef7027.js"><link rel="prefetch" href="/knowledge/assets/js/33.6f6a3468.js"><link rel="prefetch" href="/knowledge/assets/js/34.d901a786.js"><link rel="prefetch" href="/knowledge/assets/js/35.1fd0524e.js"><link rel="prefetch" href="/knowledge/assets/js/36.77bc3059.js"><link rel="prefetch" href="/knowledge/assets/js/37.679cc1e5.js"><link rel="prefetch" href="/knowledge/assets/js/38.f75e290e.js"><link rel="prefetch" href="/knowledge/assets/js/39.1d0ee5d8.js"><link rel="prefetch" href="/knowledge/assets/js/4.587ffb67.js"><link rel="prefetch" href="/knowledge/assets/js/40.3cb3a24b.js"><link rel="prefetch" href="/knowledge/assets/js/41.027942e8.js"><link rel="prefetch" href="/knowledge/assets/js/42.8eb2c3d5.js"><link rel="prefetch" href="/knowledge/assets/js/43.090ab8dc.js"><link rel="prefetch" href="/knowledge/assets/js/44.3bd0b34a.js"><link rel="prefetch" href="/knowledge/assets/js/45.f8142d41.js"><link rel="prefetch" href="/knowledge/assets/js/46.82abb8fa.js"><link rel="prefetch" href="/knowledge/assets/js/47.0f319d1e.js"><link rel="prefetch" href="/knowledge/assets/js/48.c6480f5c.js"><link rel="prefetch" href="/knowledge/assets/js/49.f4067732.js"><link rel="prefetch" href="/knowledge/assets/js/5.15716dac.js"><link rel="prefetch" href="/knowledge/assets/js/50.757a56db.js"><link rel="prefetch" href="/knowledge/assets/js/51.7ebfa544.js"><link rel="prefetch" href="/knowledge/assets/js/52.9611130c.js"><link rel="prefetch" href="/knowledge/assets/js/53.9a8b6f46.js"><link rel="prefetch" href="/knowledge/assets/js/54.a5ab0902.js"><link rel="prefetch" href="/knowledge/assets/js/55.cba7ef0d.js"><link rel="prefetch" href="/knowledge/assets/js/56.af6cd21e.js"><link rel="prefetch" href="/knowledge/assets/js/57.59fb1a6a.js"><link rel="prefetch" href="/knowledge/assets/js/58.d606fdf7.js"><link rel="prefetch" href="/knowledge/assets/js/59.6761b349.js"><link rel="prefetch" href="/knowledge/assets/js/6.6a6617af.js"><link rel="prefetch" href="/knowledge/assets/js/60.a7f4c4ff.js"><link rel="prefetch" href="/knowledge/assets/js/61.e9190c42.js"><link rel="prefetch" href="/knowledge/assets/js/62.a9401860.js"><link rel="prefetch" href="/knowledge/assets/js/63.b827600a.js"><link rel="prefetch" href="/knowledge/assets/js/64.e38255e6.js"><link rel="prefetch" href="/knowledge/assets/js/65.02b1dd62.js"><link rel="prefetch" href="/knowledge/assets/js/66.8f2338cb.js"><link rel="prefetch" href="/knowledge/assets/js/67.c01adc05.js"><link rel="prefetch" href="/knowledge/assets/js/68.e358bf7d.js"><link rel="prefetch" href="/knowledge/assets/js/69.39b37e2d.js"><link rel="prefetch" href="/knowledge/assets/js/7.ba76af71.js"><link rel="prefetch" href="/knowledge/assets/js/70.dcc63002.js"><link rel="prefetch" href="/knowledge/assets/js/71.12f2ab04.js"><link rel="prefetch" href="/knowledge/assets/js/72.2bfd6ad1.js"><link rel="prefetch" href="/knowledge/assets/js/73.1bc5932a.js"><link rel="prefetch" href="/knowledge/assets/js/74.d9482a02.js"><link rel="prefetch" href="/knowledge/assets/js/75.67d0111b.js"><link rel="prefetch" href="/knowledge/assets/js/76.150ac4a4.js"><link rel="prefetch" href="/knowledge/assets/js/77.4deee2b6.js"><link rel="prefetch" href="/knowledge/assets/js/78.5921430f.js"><link rel="prefetch" href="/knowledge/assets/js/79.f74ff1d0.js"><link rel="prefetch" href="/knowledge/assets/js/80.5c34c25e.js"><link rel="prefetch" href="/knowledge/assets/js/81.6e54321c.js"><link rel="prefetch" href="/knowledge/assets/js/82.e8bbc1c5.js"><link rel="prefetch" href="/knowledge/assets/js/83.49d5e292.js"><link rel="prefetch" href="/knowledge/assets/js/84.98c35d72.js"><link rel="prefetch" href="/knowledge/assets/js/85.f73eb0e7.js"><link rel="prefetch" href="/knowledge/assets/js/86.3d3735cc.js"><link rel="prefetch" href="/knowledge/assets/js/87.5d806d0d.js"><link rel="prefetch" href="/knowledge/assets/js/88.57c59503.js"><link rel="prefetch" href="/knowledge/assets/js/90.2c50ee69.js"><link rel="prefetch" href="/knowledge/assets/js/91.ae6cb9aa.js"><link rel="prefetch" href="/knowledge/assets/js/92.ff541495.js"><link rel="prefetch" href="/knowledge/assets/js/93.8f52d80b.js"><link rel="prefetch" href="/knowledge/assets/js/94.e6d1e6c5.js"><link rel="prefetch" href="/knowledge/assets/js/95.c55344fe.js"><link rel="prefetch" href="/knowledge/assets/js/96.6a87e9ca.js"><link rel="prefetch" href="/knowledge/assets/js/97.43e0ca7f.js"><link rel="prefetch" href="/knowledge/assets/js/98.3fcabc73.js"><link rel="prefetch" href="/knowledge/assets/js/99.f68c9886.js"><link rel="prefetch" href="/knowledge/assets/js/vendors~docsearch.7a484b82.js">
    <link rel="stylesheet" href="/knowledge/assets/css/0.styles.19179342.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge/" class="home-link router-link-active"><!----> <span class="site-name">é‚“æ”€çš„æŠ€æœ¯åšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge/" aria-current="page" class="sidebar-link">æ¬¢è¿</a></li><li><section class="sidebar-group depth-0"><a href="/knowledge/vue" class="sidebar-heading clickable"><span>Vue</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/vue/å“åº”å¼.html" class="sidebar-link">å“åº”å¼</a></li><li><a href="/knowledge/vue/ç¼–è¯‘.html" class="sidebar-link">ç¼–è¯‘</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/react" class="sidebar-heading clickable router-link-active"><span>React</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/react/01.JSX.html" class="sidebar-link">JSX</a></li><li><a href="/knowledge/react/02.Fiber.html" class="sidebar-link">Fiber</a></li><li><a href="/knowledge/react/03.bit.html" class="sidebar-link">Bit</a></li><li><a href="/knowledge/react/BuildYourOwnReact/buildYourOwnReact.html" class="sidebar-link">BuildYourOwnReact</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Source Code Analysis</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/typescript" class="sidebar-heading clickable"><span>TypeScript</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/typescript/type-challenges.html" class="sidebar-link">ç±»å‹ä½“æ“</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/nextjs" class="sidebar-heading clickable"><span>nextjs</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/nextjs/docs/05.Fetching Data.html" class="sidebar-link">Fetching Data</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/nodejs" class="sidebar-heading clickable"><span>Node.js</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/nodejs/å¼‚æ­¥å¼io.html" class="sidebar-link">å¼‚æ­¥å¼IO</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/algorithm" class="sidebar-heading clickable"><span>ç®—æ³•</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/algorithm/äºŒåˆ†æŸ¥æ‰¾.html" class="sidebar-link">äºŒåˆ†æŸ¥æ‰¾</a></li><li><a href="/knowledge/algorithm/å¤§æ•°ç›¸åŠ .html" class="sidebar-link">å¤§æ•°ç›¸åŠ </a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/system-design" class="sidebar-heading clickable"><span>ç³»ç»Ÿè®¾è®¡</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/system-design/news-feed.html" class="sidebar-link">news feed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/interview" class="sidebar-heading clickable"><span>é¢è¯•ç›¸å…³</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/interview/html.html" class="sidebar-link">HTML</a></li><li><a href="/knowledge/interview/JavaScript.html" class="sidebar-link">JavaScript</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/GFE" class="sidebar-heading clickable"><span>GFE</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/GFE/01.debounce/" class="sidebar-link">Debounce</a></li><li><a href="/knowledge/GFE/02.myReduce/" class="sidebar-link">MyReduce</a></li><li><a href="/knowledge/GFE/03.classnames/" class="sidebar-link">ClassNames</a></li><li><a href="/knowledge/GFE/04.flatten/" class="sidebar-link">Flatten</a></li><li><a href="/knowledge/GFE/05.throttle/" class="sidebar-link">Throttle</a></li><li><a href="/knowledge/GFE/06.Type%20Utilities/" class="sidebar-link">Type Utilities</a></li><li><a href="/knowledge/GFE/07.Type%20Utilities%20II/" class="sidebar-link">Type Utilities II</a></li><li><a href="/knowledge/GFE/08.Promise.all/" class="sidebar-link">Promise.all</a></li><li><a href="/knowledge/GFE/09.Data%20Merging/" class="sidebar-link">Data Merging</a></li><li><a href="/knowledge/GFE/10.Deep%20Clone/" class="sidebar-link">Deep Clone</a></li><li><a href="/knowledge/GFE/11.Event%20Emitter/" class="sidebar-link">Event Emitter</a></li><li><a href="/knowledge/GFE/12.getElementsByStyle/" class="sidebar-link">getElementsByStyle</a></li><li><a href="/knowledge/GFE/13.Function.prototype.call/" class="sidebar-link">Function.prototype.call</a></li><li><a href="/knowledge/GFE/14.List%20Format/" class="sidebar-link">List Format</a></li><li><a href="/knowledge/GFE/15.Map%20Async%20Limit/" class="sidebar-link">Map Async Limit</a></li><li><a href="/knowledge/GFE/16.Deep%20Equal/" class="sidebar-link">Deep Equal</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/Blind" class="sidebar-heading clickable"><span>Blind</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/Blind/01.Balanced%20Brackets/" class="sidebar-link">Balanced Brackets</a></li><li><a href="/knowledge/Blind/02.Find%20Duplicates%20in%20Array/" class="sidebar-link">Find Duplicates in Array</a></li><li><a href="/knowledge/Blind/03.Find%20Missing%20Number%20in%20Sequence/" class="sidebar-link">Find Missing Number in Sequence</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/git" class="sidebar-heading clickable"><span>Git</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/git/commit.html" class="sidebar-link">commit</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="build-yourself-a-redux"><a href="#build-yourself-a-redux" class="header-anchor">#</a> Build Yourself a Redux</h1> <h2 id="bring-your-own-state-object"><a href="#bring-your-own-state-object" class="header-anchor">#</a> Bring Your Own State Object</h2> <p>å¤§å¤šæ•°<code>app</code>å°†ä¼šä»æœåŠ¡ç«¯è·å–å¯¹è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºæœ¬åœ°å¯¹è±¡ï¼Œ<code>Redux</code>å¯ä»¥å¸®åŠ©ç®¡ç†çŠ¶æ€çš„æ”¹å˜ï¼Œä½†æ˜¯å®ƒå¹¶ä¸çœŸæ­£çš„å…³å¿ƒçŠ¶æ€æœ¬èº«ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">nextNoteId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="why-redux"><a href="#why-redux" class="header-anchor">#</a> Why Redux?</h2> <p>ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨<code>Redux</code>å‘¢ï¼Ÿåœ¨æˆ‘ä»¬æ·±å…¥æŒ–æ˜ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚æœæ²¡æœ‰<code>Redux</code>ï¼Œæ€ä¹ˆæ„å»ºä¸€ä¸ª<code>app</code>å‘¢ï¼Œæˆ–è®¸éœ€è¦å°†æŸä¸ªå¯¹è±¡æŒ‚è½½åœ¨<code>window</code>ä¸Š <code>window.state = initialState;</code>ï¼Œåœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">onAddNote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>nextNoteId<span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">''</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>nextNoteId<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">renderApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">NoteApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>notes<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ul className<span class="token operator">=</span><span class="token string">&quot;note-list&quot;</span><span class="token operator">&gt;</span>
    <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>notes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
        <span class="token comment">// Obviously we should render something more interesting than the id.</span>
        <span class="token operator">&lt;</span>li className<span class="token operator">=</span><span class="token string">&quot;note-list-item&quot;</span> key<span class="token operator">=</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button className<span class="token operator">=</span><span class="token string">&quot;editor-button&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>onAddNote<span class="token punctuation">}</span><span class="token operator">&gt;</span>New Note<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">renderApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>NoteApp notes<span class="token operator">=</span><span class="token punctuation">{</span>window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">renderApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢çš„å®ç°æ–¹å¼ä¸ä¼˜é›…ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥å·¥ä½œï¼Œé‚£ä¹ˆæ˜¯å¦æˆ‘ä»¬å¯ä»¥ä¸éœ€è¦<code>Redux</code>å‘¢ï¼Ÿ</p> <p>è®©æˆ‘ä»¬åœ¨æ·»åŠ ä¸€ä¸‹åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨<code>onAddNote</code>ä¸­å¢åŠ ä¸€ä¸ªè¯·æ±‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">onAddNote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>onLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token function">renderApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  api<span class="token punctuation">.</span><span class="token function">createNote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">note</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>onLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> note<span class="token punctuation">;</span>
      <span class="token function">renderApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œä¿®æ”¹äº†ä¸¤æ¬¡<code>state</code>çš„å€¼ï¼ŒåŒæ—¶ä¸ºäº†æ›´æ–°ç•Œé¢ï¼Œéœ€è¦è°ƒç”¨ä¸¤æ¬¡<code>renderApp</code>å‡½æ•°æ¥è¿›è¡Œæ›´æ–°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœé€»è¾‘æ›´å¤šï¼Œåˆ™éœ€è¦æ”¹å˜å’Œå¤„ç†çš„æƒ…å†µå°±è¶Šå¤šï¼Œä¹Ÿè¶Šå®¹æ˜“å‡ºç°é—®é¢˜</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">ARCHIVE_TAG_ID</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">onAddTag</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">noteId<span class="token punctuation">,</span> tagId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>onLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// Whoops, forgetting to render here!</span>
  <span class="token comment">// For quick local server, we might not notice.</span>
  api<span class="token punctuation">.</span><span class="token function">addTag</span><span class="token punctuation">(</span>noteId<span class="token punctuation">,</span> tagId<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>onLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>tagMapping<span class="token punctuation">[</span>tagId<span class="token punctuation">]</span> <span class="token operator">=</span> noteId<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ARCHIVE_TAG_ID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Whoops, some naming bugs here. Probably from a</span>
        <span class="token comment">// rogue search and replace. Won't be noticed till</span>
        <span class="token comment">// we test that archive page that nobody really uses.</span>
        window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>archived <span class="token operator">=</span> window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>archive <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>archived<span class="token punctuation">[</span>noteId<span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>noteId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>noteId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">renderApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç æœ‰ä¸¤å¤„é”™è¯¯ï¼Œä¸€ä¸ªæ˜¯åœ¨è®¾ç½®<code>onLoading=true</code>åï¼Œæ²¡æœ‰è°ƒç”¨<code>renderApp</code>ï¼Œé¡µé¢ä¹Ÿå°±æ²¡æœ‰å¯¹è¯¥äº¤äº’è¿›è¡Œæ¸²æŸ“ã€‚è¿˜æœ‰ä¸€ä¸ªæ˜¯ä¸‹é¢çš„å˜é‡å–å€¼é”™è¯¯ï¼Œè¿™ç§é”™è¯¯æ²¡æœ‰æ§åˆ¶å°è­¦å‘Šï¼Œåªèƒ½ä¾èµ–å¼€å‘è€…æ‰‹åŠ¨è°ƒè¯•ï¼Œåœ¨é‡åˆ°ç›¸å…³é—®é¢˜æ—¶æ‰èƒ½æš´éœ²å‡ºæ¥ï¼Œå¹¶ä¸”æéš¾è¢«å‘ç°ã€‚</p> <p>è¿˜æœ‰å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">SomeEvilComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> window<span class="token punctuation">.</span>state<span class="token punctuation">.</span>pureEvil <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Do Evil<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>å…¨å±€çŠ¶æ€å€¼å¯èƒ½è¢«åº”ç”¨åœ¨é¡µé¢çš„å„ä¸ªç»„ä»¶ä¸­ï¼Œå¦‚æœå‡ºç°é—®é¢˜ï¼Œéœ€è¦ä¾èµ–ç»éªŒæŸ¥æ‰¾åŸå› ï¼Œè°ƒè¯•åŠå…¶å›°éš¾ï¼Œä¼šç»™å¼€å‘è€…é€ æˆå¾ˆå¤§çš„æ—¶é—´æµªè´¹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨<code>Redux</code>çš„ä¸»è¦åŸå› ã€‚å¦‚æœæƒ³é™ä½ä¸€ä¸ª<code>app</code>çš„å¤æ‚åº¦ï¼Œæœ€æœ‰æ•ˆçš„æ–¹å¼å°±æ˜¯é™åˆ¶ç¨‹åºçŠ¶æ€å˜æ›´çš„æ–¹å¼ä¸å˜æ›´èŒƒå›´ã€‚<code>Redux</code>å¹¶ä¸æ˜¯ä¸€ä¸ªèƒ½è§£å†³è¿™äº›é—®é¢˜çš„ä¸‡èƒ½è‰¯æ–¹ï¼Œä½†ç”±äºæœ‰äº†è®¸å¤šé™åˆ¶ï¼Œä¸Šé¢çš„é—®é¢˜ä¼šé€æ¸å‡å°‘ã€‚</p> <h2 id="the-reducer"><a href="#the-reducer" class="header-anchor">#</a> The Reducer</h2> <p><code>Redux</code>æ˜¯å¦‚ä½•æä¾›è¿™äº›çº¦æŸå¹¶å¸®åŠ©ç®¡ç†çŠ¶æ€çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªå…ˆå®ç°ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶å½“å‰çš„çŠ¶æ€ä»¥åŠä¸€ä¸ªè¡Œä¸º<code>action</code>ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„çŠ¶æ€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸Šé¢çš„çŠ¶æ€ï¼Œå®Œæˆä¸€ä¸ªå¦‚ä¸‹çš„å‡½æ•°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">CREATE_NOTE</span> <span class="token operator">=</span> <span class="token string">'CREATE_NOTE'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">UPDATE_NOTE</span> <span class="token operator">=</span> <span class="token string">'UPDATE_NOTE'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">nextNoteId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CREATE_NOTE</span><span class="token operator">:</span>
      <span class="token comment">// change the state</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token constant">UPDATE_NOTE</span><span class="token operator">:</span>
      <span class="token comment">// change the state</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢çš„<code>reducer</code>å‡½æ•°ä¹Ÿå¯ä»¥æ¢ä¸€ç§æ–¹å¼å®ç°ï¼Œä½¿ç”¨å¯¹è±¡æ˜ å°„ä¸åŒçš„<code>action</code>æ“ä½œ</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> handlers <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token constant">CREATE_NOTE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token constant">UPDATE_NOTE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> handler <span class="token operator">=</span> handlers<span class="token punctuation">[</span>action<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>reducer</code>çš„å¯ä»¥æŒ‰ç…§ä½ æƒ³è¦çš„ä»»ä½•æ–¹å¼å®ç°ã€‚<code>Redux</code>å¹¶ä¸å…³å¿ƒã€‚</p> <h2 id="immutability"><a href="#immutability" class="header-anchor">#</a> Immutability</h2> <p><code>Redux</code>åªå…³å¿ƒ<code>reducer</code>æ˜¯å¦æ˜¯ä¸€ä¸ª<a href="/knowledge/react/redux/pureFunction.html">çº¯å‡½æ•°</a>ã€‚æ„å‘³ç€ä¸èƒ½å‘ä¸‹é¢ğŸ‘‡ğŸ»è¿™æ ·å®ç°<code>reducer</code>å‡½æ•°</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CREATE_NOTE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// DO NOT MUTATE STATE LIKE THIS!!!</span>
      state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>state<span class="token punctuation">.</span>nextNoteId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> state<span class="token punctuation">.</span>nextNoteId<span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">''</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>nextNoteId<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">UPDATE_NOTE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// DO NOT MUTATE STATE LIKE THIS!!!</span>
      state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> action<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼ç›´æ¥ä¿®æ”¹å¯¹è±¡ï¼Œé‚£ä¹ˆå¯¹è±¡çš„å¼•ç”¨ä¸ä¼šæ”¹å˜ï¼Œåˆ™ä½¿ç”¨è¯¥å¯¹è±¡ä½œä¸ºå±æ€§çš„ç»„ä»¶æ— æ³•æ­£ç¡®æ›´æ–°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜ä¼šä½¿<code>Redux</code>å¼€å‘å·¥å…·æ— æ³•ä½¿ç”¨ï¼Œè¿™äº›å·¥å…·ä¾èµ–è¿½è¸ªå†å²çŠ¶æ€ï¼ŒæŒç»­å¯¹å¯¹è±¡è¿›è¡ŒçŠ¶æ€ä¿®æ”¹ï¼Œåˆ™æ— æ³•è¿›è¡Œ<strong>å›æº¯</strong>ã€‚</p> <p>çº¯å‡½æ•°å…·æœ‰å¯é¢„æµ‹æ€§ï¼Œå› ä¸ºç›¸åŒçš„è¾“å…¥å¿…ç„¶äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚è‹¥ç›´æ¥ä¿®æ”¹çŠ¶æ€ï¼Œåˆ™ä¸€åˆ‡éƒ½å˜å¾—ä¸å¯é¢„æµ‹ã€‚å‡½æ•°è°ƒç”¨å¤±å»ç¡®å®šæ€§ï¼Œå¼€å‘è€…éœ€è¦æ—¶åˆ»åœ¨è„‘æµ·ä¸­ä¿æŒæ•´ä¸ªå‡½æ•°è°ƒç”¨è¿‡ç¨‹çš„ã€‚</p> <p>å¯ä»¥ç›´æ¥ä½¿ç”¨<strong>æ‹“å±•è¿ç®—ç¬¦</strong>æˆ–è€…<code>Object.assign</code>ã€‚å¯¹äºå¯¹è±¡ä¸­ä¸å¯å˜çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç›´æ¥å¼•ç”¨ç°æœ‰å†…å®¹ï¼Œå¦‚ä¸‹ä»£ç ï¼šæˆ‘ä»¬åªéœ€è¦æ”¹å˜<code>notes</code>å±æ€§ï¼Œå› æ­¤<code>state</code>ä¸­çš„å…¶ä»–å±æ€§ä½¿ç”¨æµ…å¤åˆ¶ä¿æŒåŸå¯¹è±¡å¼•ç”¨ã€‚è¿™æ ·çš„è¯å°±å¯ä»¥åˆ©ç”¨<code>shouldComponentUpdate</code>æˆ–è€…<code>PureCompnent</code>ï¼Œå¦‚æœç»„ä»¶ä¸­çš„<code>props</code>ä¸­åŒ…å«æœªå˜æ›´çš„å¯¹è±¡å±æ€§ï¼Œåˆ™å¯ä»¥é¿å…è¢«é‡æ–°æ¸²æŸ“ã€‚åŸºäºæ­¤åŸåˆ™ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥é¿å…å°†<code>reducer</code>ç¼–å†™æˆå¦‚ä¸‹çš„å½¢å¼ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Well, we avoid mutation, but still... DON'T DO THIS!</span>
  state <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">case</span> <span class="token constant">UPDATE_NOTE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// Hey, now I can do good old mutations.</span>
      state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> action<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç ä»æŠ€æœ¯ä¸Šæ¥è¯´åœ¨<code>Redux</code>ä¸­ä¹Ÿèƒ½è¿è¡Œã€‚ä½†æ˜¯è¿™æ ·ä¼šç ´åä¼˜åŒ–æœºåˆ¶ã€‚æ¯æ¬¡çŠ¶æ€å˜æ›´æ—¶ï¼Œæ¯ä¸ªå¯¹è±¡å’Œæ•°ç»„éƒ½ä¼šè¢«é‡æ–°åˆ›å»ºï¼Œå› æ­¤ä¾èµ–è¿™äº›å¯¹è±¡å’Œæ•°ç»„çš„ç»„ä»¶éƒ½å¿…é¡»é‡æ–°æ¸²æŸ“ï¼Œä½†å®é™…ä¸Šå…¶çŠ¶æ€å€¼å¹¶æ²¡æœ‰æ›´æ–°ã€‚</p> <p><code>Immutability</code>å³ä¸º<strong>ä¸å¯å˜æ€§</strong>ï¼ŒæŒ‡æ•°æ®ä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½è¢«ä¿®æ”¹çš„ç‰¹æ€§ã€‚æ„å‘³ç€ï¼š</p> <ul><li>çŠ¶æ€å¯¹è±¡æœ¬èº«ä¸å¯å˜</li> <li>ä»»ä½•çŠ¶æ€æ›´æ–°éƒ½å¿…é¡»è¿”å›<strong>å…¨æ–°çš„å¯¹è±¡</strong>ï¼Œè€Œä¸æ˜¯ä¿®æ”¹åŸå¯¹è±¡</li> <li>çŠ¶æ€æ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸å¯å˜çš„</li></ul> <p>å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// âŒ é”™è¯¯åšæ³•ï¼šç›´æ¥ä¿®æ”¹åŸçŠ¶æ€</span>
<span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ç›´æ¥ä¿®æ”¹</span>
  <span class="token keyword">return</span> state<span class="token punctuation">;</span>  <span class="token comment">// è¿”å›åŒä¸€å¼•ç”¨</span>
<span class="token punctuation">}</span>

<span class="token comment">// âœ… æ­£ç¡®åšæ³•ï¼šè¿”å›æ–°å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>state<span class="token punctuation">,</span>
    <span class="token literal-property property">todos</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>state<span class="token punctuation">.</span>todos<span class="token punctuation">,</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">]</span>  <span class="token comment">// åˆ›å»ºæ–°æ•°ç»„</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ä¸ºä»€ä¹ˆéœ€è¦ä¸å¯å˜å‘¢"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ä¸å¯å˜å‘¢" class="header-anchor">#</a> ä¸ºä»€ä¹ˆéœ€è¦ä¸å¯å˜å‘¢ï¼Ÿ</h3> <h4 id="æ€§èƒ½ä¼˜åŒ–-å¼•ç”¨æ¯”è¾ƒ"><a href="#æ€§èƒ½ä¼˜åŒ–-å¼•ç”¨æ¯”è¾ƒ" class="header-anchor">#</a> æ€§èƒ½ä¼˜åŒ–ï¼šå¼•ç”¨æ¯”è¾ƒ</h4> <p>åœ¨<code>react</code>å†…éƒ¨æ˜¯é€šè¿‡<strong>æµ…æ¯”è¾ƒ</strong>åˆ¤æ–­å±æ€§å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæ¯æ¬¡çŠ¶æ€æ›´æ–°è¿”å›æ–°çš„å¯¹è±¡ä¹Ÿå°±æ˜¯ä¸€ä¸ªæ–°çš„å¼•ç”¨ï¼Œå°±å¯ä»¥é€šè¿‡æµ…æ¯”è¾ƒå‘ç°å…¶çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// é€šè¿‡å¼•ç”¨æ¯”è¾ƒå¿«é€Ÿåˆ¤æ–­çŠ¶æ€æ˜¯å¦å˜åŒ–</span>
<span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token parameter">mapStateToProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€šè¿‡ === æ¯”è¾ƒå¼•ç”¨ï¼ŒO(1)æ—¶é—´å¤æ‚åº¦</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> <span class="token function">mapStateToProps</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    component<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="æ—¶é—´æ—…è¡Œè°ƒè¯•"><a href="#æ—¶é—´æ—…è¡Œè°ƒè¯•" class="header-anchor">#</a> æ—¶é—´æ—…è¡Œè°ƒè¯•</h4> <p>åœ¨æ¯æ¬¡çŠ¶æ€ä¿®æ”¹æ—¶éƒ½å°†çŠ¶æ€ä¿å­˜åˆ°ä¸€ä¸ªå†å²æ ˆä¸­ï¼Œæ¯æ¬¡éƒ½æ˜¯ä¸€ä¸ªæ–°å€¼ï¼Œä¿è¯äº†å†å²æ ˆä¸­å­˜å‚¨çš„æ•°æ®å‡†ç¡®</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ä¿å­˜çŠ¶æ€å†å²</span>
<span class="token keyword">const</span> stateHistory <span class="token operator">=</span> <span class="token punctuation">[</span>initialState<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// æ¯æ¬¡dispatchéƒ½ä¿å­˜å®Œæ•´çŠ¶æ€å¿«ç…§</span>
<span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  stateHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// éœ€è¦ä¸å¯å˜æ€§ä¿è¯å†å²ä¸è¢«ä¿®æ”¹</span>
  currentState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å›é€€åˆ°ä¹‹å‰çš„çŠ¶æ€</span>
<span class="token keyword">function</span> <span class="token function">travelBack</span><span class="token punctuation">(</span><span class="token parameter">step</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentState <span class="token operator">=</span> stateHistory<span class="token punctuation">[</span>stateHistory<span class="token punctuation">.</span>length <span class="token operator">-</span> step<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// åŸçŠ¶æ€ä¿æŒä¸å˜ï¼Œå¯å®‰å…¨ä½¿ç”¨</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="çº¯å‡½æ•°ç‰¹æ€§"><a href="#çº¯å‡½æ•°ç‰¹æ€§" class="header-anchor">#</a> çº¯å‡½æ•°ç‰¹æ€§</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Reducerå¿…é¡»æ˜¯çº¯å‡½æ•°</span>
<span class="token keyword">function</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// çº¯å‡½æ•°è¦æ±‚ï¼š</span>
  <span class="token comment">// 1. ç›¸åŒè¾“å…¥ â†’ ç›¸åŒè¾“å‡º</span>
  <span class="token comment">// 2. æ— å‰¯ä½œç”¨</span>
  <span class="token comment">// 3. ä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€</span>
  
  <span class="token comment">// ä¸å¯å˜æ€§æ˜¯å®ç°çº¯å‡½æ•°çš„åŸºç¡€</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>state<span class="token punctuation">,</span>
    <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// æ¯æ¬¡éƒ½è¿”å›æ–°å¯¹è±¡</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="æ›´æ–°é«˜æ•ˆ"><a href="#æ›´æ–°é«˜æ•ˆ" class="header-anchor">#</a> æ›´æ–°é«˜æ•ˆ</h4> <p>åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨æµ…æ¯”è¾ƒ<code>Props</code>è¿›è¡Œæ›´æ–°åˆ¤æ–­ï¼Œå¦‚æœçŠ¶æ€å¯å˜ï¼Œé‚£ä¹ˆæ·±å±‚éœ€è¦è¿›è¡Œé€’å½’åˆ¤æ–­ï¼Œä»£ä»·éå¸¸æ˜‚è´µã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// React-Reduxçš„æµ…æ¯”è¾ƒ</span>
<span class="token keyword">function</span> <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æµ…å±‚æ¯”è¾ƒpropså¼•ç”¨</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> nextProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// å¦‚æœçŠ¶æ€å¯å˜ï¼Œæ·±å±‚æ¯”è¾ƒä¼šéå¸¸æ˜‚è´µ</span>
</code></pre></div><h2 id="using-our-reducer"><a href="#using-our-reducer" class="header-anchor">#</a> Using our Reducer</h2> <p>è®©æˆ‘ä»¬ä½¿ç”¨åˆ›å»ºçš„<code>reducer</code>æ¥è·å–ä¸€ä¸ªæ–°çš„çŠ¶æ€</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> state0 <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">CREATE_NOTE</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// the value of state 0</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">nextNoteId</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸Šé¢çš„çŠ¶æ€åˆå§‹åŒ–ä¸­ï¼Œæˆ‘ä»¬ä¼ é€’äº†ä¸€ä¸ª<code>undefined</code>å€¼ä½œä¸ºåˆå§‹çŠ¶æ€å€¼ã€‚<code>Redux</code>æ€»æ˜¯ä¼ é€’ä¸€ä¸ª<code>undefined</code>ä½œä¸ºåˆå§‹å˜é‡ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåƒè¿™æ ·çš„é»˜è®¤å‚æ•°<code>state=initialState</code>ã€‚åé¢å¯ä»¥å°†å‰ä¸€ä¸ªçŠ¶æ€<code>previous state</code>ç»§ç»­ä¼ å…¥<code>Redux</code>ä¸­</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> state1  <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state0<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">UPDATE_NOTE</span><span class="token punctuation">,</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Hello, world!'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// state1</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">nextNoteId</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Hello, world!'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼æ¥ä½¿ç”¨çŠ¶æ€ï¼Œå°†å…¶æ”¾ç½®åœ¨<code>html</code>é¡µé¢ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨é¡µé¢ä¸­æ­£ç¡®çš„æ¸²æŸ“äº†è¯¥çŠ¶æ€å€¼ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">CREATE_NOTE</span> <span class="token operator">=</span> <span class="token string">'CREATE_NOTE'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">UPDATE_NOTE</span> <span class="token operator">=</span> <span class="token string">'UPDATE_NOTE'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">nextNoteId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CREATE_NOTE</span><span class="token operator">:</span>
      <span class="token keyword">const</span> id <span class="token operator">=</span> state<span class="token punctuation">.</span>nextNoteId<span class="token punctuation">;</span>
      <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">''</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        <span class="token literal-property property">nextNoteId</span><span class="token operator">:</span> id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">,</span>
          <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">:</span> newNote
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token constant">UPDATE_NOTE</span><span class="token operator">:</span>
      <span class="token keyword">const</span> editedNote <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> action<span class="token punctuation">.</span>content
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>state<span class="token punctuation">.</span>notes<span class="token punctuation">,</span>
          <span class="token punctuation">[</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token operator">:</span> editedNote
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> state0 <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">CREATE_NOTE</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> state1 <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state0<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">UPDATE_NOTE</span><span class="token punctuation">,</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Hello, world!'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>Redux</code>çš„æ ¸å¿ƒæœ¬è´¨ä¸Šå°±æ˜¯ç¼–å†™ä¸€æ®µä»£ç --ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œå®ƒæ¥å—ä¸Šä¸€ä¸ªçŠ¶æ€å’Œä¸€ä¸ªåŠ¨ä½œï¼Œå¹¶è¿”å›ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥è¢«ç›´æ¥åµŒå…¥<code>reduce</code>å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸ºè¿™ä»€ä¹ˆè¿™ä¸ªå‡½æ•°è¢«ç§°ä¸º<code>reducer</code>çš„åŸå› ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">CREATE_NOTE</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">UPDATE_NOTE</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Hello, world!'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> state2 <span class="token operator">=</span> actions<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state2'</span><span class="token punctuation">,</span> state2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// state2</span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">nextNoteId</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">notes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Hello, world!'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢ä¸¤ç§æ–¹å¼ä½¿ç”¨<code>reducer</code>è¿”å›çš„çŠ¶æ€å€¼ç›¸åŒï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<code>Redux</code>è¢«ç§°ä¸ºæ˜¯<code>JavaScript</code>åº”ç”¨ç¨‹åºçš„å¯é¢„æµ‹çŠ¶æ€å®¹å™¨äº†ã€‚è¾“å…¥ç›¸åŒçš„çŠ¶æ€å€¼ä»¥åŠ<code>action</code>ï¼Œæœ€ç»ˆä¼šå¾—åˆ°ç›¸åŒçš„çŠ¶æ€ã€‚</p> <h2 id="the-store"><a href="#the-store" class="header-anchor">#</a> The Store</h2> <p>ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªå­˜å‚¨å™¨<code>store</code>ï¼Œä½¿ç”¨é—­åŒ…çš„æ–¹å¼å°†çŠ¶æ€å€¼ä»¥åŠ<code>reducer</code>ä¿å­˜åœ¨å‡½æ•°çš„å±€éƒ¨ä½œç”¨åŸŸä¸­ï¼Œé¿å…å˜é‡æ±¡æŸ“ã€‚å­˜å‚¨å™¨è¿˜æä¾›ä¿®æ”¹çŠ¶æ€çš„æ–¹æ³•<code>dispatch</code>ä»¥åŠè·å–çŠ¶æ€çš„æ–¹æ³•<code>getState</code>ã€‚é€šè¿‡è¿™ä¸ªæ–¹å¼å¯ä»¥ç®€åŒ–çŠ¶æ€ä¿®æ”¹çš„ä½¿ç”¨ï¼Œå¹¶ä¸”é¿å…ç›´æ¥ä¿®æ”¹çŠ¶æ€å€¼ï¼Œå¿…é¡»ä½¿ç”¨<code>dispatch</code>æ–¹æ³•æ¥è¿›è¡Œä¿®æ”¹ï¼Œæ–¹ä¾¿åæœŸå¯¹çŠ¶æ€ä¿®æ”¹è¿›è¡Œå›æº¯ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">getState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">CREATE_NOTE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">UPDATE_NOTE</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Hello, world!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'store.getState()'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªèƒ½ä½¿ç”¨ä»»æ„<code>reducer</code>æ¥ç®¡ç†çŠ¶æ€çš„å­˜å‚¨åº“ã€‚ä½†æ˜¯ä¸Šé¢çš„<code>store</code>ç¼ºå°‘ä¸€ä¸ªå…³é”®çš„åŠŸèƒ½ï¼Œå°±æ˜¯å½“ä¿®æ”¹åï¼Œä½¿ç”¨è¯¥çŠ¶æ€çš„ç»„ä»¶ä¸èƒ½åŠæ—¶æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯ç¼ºå°‘<strong>è®¢é˜…çŠ¶æ€å˜æ›´çš„æœºåˆ¶</strong>ã€‚å¦‚æœä¸ä½¿ç”¨è¯¥æœºåˆ¶ï¼Œè€Œæ˜¯ä½¿ç”¨å‘½ä»¤æ–¹å¼è¿›è¡Œæ›´æ–°çš„è¯ï¼Œæ˜¯éå¸¸ä¸å‹å¥½çš„ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> subscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
      subscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">handler</span> <span class="token operator">=&gt;</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">getState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">subscribe</span><span class="token operator">:</span> <span class="token parameter">handler</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      subscribers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newIndex <span class="token operator">=</span> subscribers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>newIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          subscribers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>newIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¼ å…¥ä¸€ä¸ªä»»æ„ç±»å‹çš„actionï¼Œæ¥åˆå§‹åŒ–çŠ¶æ€</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'@@redux/INIT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> store<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åˆå§‹åŒ–æ¸²æŸ“</span>
Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'subscribe'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
    Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">UPDATE_NOTE</span><span class="token punctuation">,</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'Hello, world!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å°†ä¸Šé¢çš„ä»£ç æ¸²æŸ“åœ¨é¡µé¢ä¸Šï¼Œå¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–æ¸²æŸ“å®Œæˆä¹‹åï¼Œä½¿ç”¨å®šæ—¶å™¨åœ¨2000æ¯«ç§’ä¹‹åä¿®æ”¹çŠ¶æ€å€¼ï¼Œé¡µé¢ä¹Ÿæ›´æ–°ä¸ºäº†æœ€æ–°çš„çŠ¶æ€å€¼ã€‚</p> <h2 id="middleware"><a href="#middleware" class="header-anchor">#</a> Middleware</h2> <p>æˆ‘ä»¬åœ¨å‰é¢æ„å»ºäº†ä¸€ä¸ªå¾ˆä¸é”™çš„ä¸œè¥¿ï¼Œä½†æ˜¯ç¼ºå¤±äº†æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸æœåŠ¡å™¨ç«¯è¿›è¡Œé€šä¿¡ï¼Œä½†æ˜¯ç°åœ¨çš„æ“ä½œæ˜¯åŒæ­¥çš„ï¼Œå¦‚ä½•å®ç°å¼‚æ­¥æ“ä½œå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åœ¨åˆ†å‘æ“ä½œå’ŒçŠ¶æ€å˜æ›´ä¹‹é—´æ’å…¥ä¸­é—´ä»¶ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> middleware</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state<span class="token punctuation">;</span>
  <span class="token keyword">const</span> subscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">coreDispatch</span> <span class="token operator">=</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">validateAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    subscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">handler</span> <span class="token operator">=&gt;</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">;</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">dispatch</span><span class="token operator">:</span> coreDispatch<span class="token punctuation">,</span>
    getState<span class="token punctuation">,</span>
    <span class="token function-variable function">subscribe</span><span class="token operator">:</span> <span class="token parameter">handler</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      subscribers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> subscribers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          subscribers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    store<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      dispatch<span class="token punctuation">,</span>
      getState
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>coreDispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">coreDispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'@@redux/INIT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> store<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢ä»£ç ä¸­çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºä¸€ä¸ªre-dispatchå‡½æ•°</span>
  <span class="token comment">// ä¸€ä¸ªæœ€åŸå§‹çš„dispatchå‡½æ•°ï¼Œåä¼ å…¥å¤šä¸ªä¸­é—´ä»¶åå¯èƒ½è¢«ä¿®æ”¹</span>
  <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  store<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    dispatch<span class="token punctuation">,</span>
    getState
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>coreDispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">delayMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> delayMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>æ·»åŠ ä¸Šé¢çš„ä»£ç ï¼Œåœ¨æµè§ˆå™¨ç«¯å¯ä»¥çœ‹åˆ°ï¼Œç‚¹å‡»æŒ‰é’®åï¼Œéš”1ç§’<code>store</code>çš„å€¼æ‰è¢«æ›´æ–°</p> <h2 id="composing-middleware-together"><a href="#composing-middleware-together" class="header-anchor">#</a> Composing Middleware Together</h2> <p>ç°åœ¨æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ—¥å¿—ä¸­é—´ä»¶ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loggingMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getState<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'before'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'after'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>æˆ‘ä»¬ç°åœ¨çš„<code>createStore</code>å‡½æ•°åªæ”¯æŒä¼ å…¥ä¸€ä¸ª<code>middleware</code>ï¼Œé‚£ä¹ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªç»„åˆä¸­é—´ä»¶çš„æ–¹æ³•ï¼Œå°†æ‰€æœ‰ä¸­é—´ä»¶å‡½æ•°ç»„åˆèµ·æ¥è¿›è¡Œä½¿ç”¨</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å°†ä¸¤ä¸ªä¸­é—´ä»¶æˆ–è€…å¤šä¸ªä¸­é—´ä»¶è¿›è¡Œ compose</span>
<span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>middleware<span class="token operator">?.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>middleware<span class="token operator">?.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> middleware<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> chain <span class="token operator">=</span> middleware<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> composeMiddleware <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
   
    <span class="token keyword">return</span> <span class="token function">composeMiddleware</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å°†æ¯ä¸ªå‡½æ•°éƒ½ç»‘å®šåˆ°ä¸‹ä¸€ä¸ªåˆ†å‘å‡½æ•°ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ä¸­é—´ä»¶å¿…é¡»å…¨ç¨‹é‡‡ç”¨ç®­å¤´å‡½æ•°ã€‚æœ€ç»ˆå¾—åˆ°çš„å‡½æ•°èƒ½å¤Ÿæ¥æ”¶ä¸€ä¸ªæ“ä½œï¼Œå¹¶æŒç»­è°ƒç”¨ä¸‹ä¸€ä¸ªåˆ†å‘å‡½æ•°ï¼Œç›´è‡³æœ€ç»ˆåˆ°è¾¾åŸå§‹åˆ†å‘å‡½æ•°ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>
  delayMiddleware<span class="token punctuation">,</span>
  loggingMiddleware
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä½ å¯èƒ½å¯¹ä¸Šé¢çš„<code>reduce</code>å‡½æ•°æœ‰äº›å›°æƒ‘ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨åç»­çš„æ–‡ä»¶ä¸­è¿›è¡Œè§£é‡Š <a href="./reduce.js">reduce</a></p> <p>ä¸Šé¢çš„<code>applyMiddleware</code>å‡½æ•°åœ¨ä¼ å…¥<code>createStore</code>æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p> <ol><li><code>middleware</code> ä¸ºä¸‹é¢ <code>applyMiddleware(...middlewares)</code> å‡½æ•°è¿”å›çš„å‡½æ•° <code>(store) =&gt; next =&gt; {...someCode}</code></li> <li><code>middleware({dispatch, getState})</code>æ‰§è¡Œåè¿”å›å‡½æ•°ä¸º <code>next =&gt; { ...someCode }</code></li> <li><code>middleware({dispatch, getState})(coreDispatch)</code>æ‰§è¡Œåè¿”å›ä¸‹é¢çš„å‡½æ•° <code>action =&gt; composeMiddleware(action)</code>, å…¶ä¸­ <code>composeMiddleware</code> ä¸ºä½¿ç”¨ <code>reduce</code> æ–¹æ³•å°†å¤šä¸ªä¸­é—´ä»¶ç»„åˆèµ·æ¥çš„å‡½æ•°</li></ol> <h3 id="compose"><a href="#compose" class="header-anchor">#</a> compose</h3> <p><code>compose</code>éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> chain <span class="token operator">=</span> middleware<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> composeMiddleware <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>å› ä¸ºä¸­é—´ä»¶å‡½æ•°éœ€è¦å‘å†…éƒ¨ä¼ å…¥å¯¹åº”çš„<code>store</code>ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä¼ å…¥<code>dispatch</code>ä»¥åŠ<code>getState</code>ä¾›ä¸­é—´ä»¶å†…éƒ¨ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†ä¸­é—´ä»¶æ‰§è¡Œä¸€éï¼Œå°†å…¶<code>store</code>å˜é‡ä¿å­˜åœ¨å‡½æ•°é—­åŒ…ä¸­ã€‚æ‰§è¡Œå®Œæˆåçš„ä¸­é—´ä»¶å‡½æ•°å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">delayMiddleware</span> <span class="token operator">=</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// å‡½æ•°å†…éƒ¨çš„å¯ä»¥è·å–åˆ°é—­åŒ…ä¸­ä¿å­˜çš„ dispatch ä»¥åŠ getState å‡½æ•°</span>
  <span class="token comment">// å…¶ dispatch ä»¥åŠ getState ä¸ºåœ¨ createStore å‡½æ•°ä¸­æ‰§è¡Œæ—¶ä¼ å…¥</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delayMiddleware'</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">,</span> next<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
  <span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">loggingMiddleware</span> <span class="token operator">=</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loggingMiddleware before'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loggingMiddleware after'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">thunkMiddleware</span> <span class="token operator">=</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'thunkMiddleware'</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> next<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢ä»£ç ä¸­çš„<code>chain</code>ä¹Ÿå°±æ˜¯ä¸Šé¢çš„<code>delayMiddleware</code>ä»¥åŠ<code>loggingMiddleware</code>é›†åˆèµ·æ¥çš„æ•°ç»„ <code>[delayMiddleware, thunkMiddleware, loggingMiddleware]</code>ï¼Œå°†è¯¥æ•°ç»„è¿›è¡Œ<code>reduce</code>æ“ä½œï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶è¿”å›å¦‚ä¸‹å‡½æ•°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// aå‡½æ•°ä¸º delayMiddlewareï¼Œbå‡½æ•°ä¸º thunkMiddleware</span>
<span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// delayMiddleware(thunkMiddleware(next))</span>
  <span class="token keyword">return</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token function">delayMiddleware</span><span class="token punctuation">(</span><span class="token function">thunkMiddleware</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å†æ¬¡æ‰§è¡Œ<code>reduce</code>æ“ä½œæ—¶ä¼šæŠŠä¸Šé¢çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>delayMiddleware(thunkMiddleware(next))</code>ä½œä¸º<code>a</code>å‚æ•°ä¼ å…¥ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸‹é¢ä»£ç ç‰‡æ®µæ‰§è¡Œå®Œæˆåä¸º delayMiddleware(thunkMiddleware(logginMiddleware(next)))</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">delayMiddleware</span><span class="token punctuation">(</span><span class="token function">thunkMiddleware</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">logginMiddleware</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰€ä»¥ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ‰§è¡Œå®Œæˆåï¼Œè¿”å›çš„ä»£ç ä¸º <code>next =&gt; delayMiddleware(thunkMiddleware(logginMiddleware(next)))</code>ï¼Œæ‰§è¡Œè¯¥å‡½æ•°åè¿”å›<code>delayMiddleware(thunkMiddleware(logginMiddleware(next)))</code>ï¼Œå…¶ä¸­ä¼ å…¥<code>logginMiddleware</code>å‡½æ•°ä¸­çš„<code>next</code>å‚æ•°å°±ä¸º<code>coreDispatch</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// delayMiddleware(thunkMiddleware(logginMiddleware(next)))</span>
<span class="token comment">// delayMiddlewareå‡½æ•°å…ˆæ‰§è¡Œï¼Œè¿”å›å¦‚ä¸‹å‡½æ•°ï¼Œå…¶ä¸­ nextä¸ºé—­åŒ…å†…ä¿å­˜çš„thunkMiddlewareå‡½æ•°æ‰§è¡Œåè¿”å›çš„action =&gt; {...some thunk middleware code}</span>
<span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delayMiddleware'</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">,</span> next<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
  <span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//thunkMiddlewareå‡½æ•°æ‰§è¡Œåè¿”å›ä¸‹é¢ä»£ç ï¼Œå…¶ä¸­ nextä¸ºé—­åŒ…å†…ä¿å­˜çš„loggingMiddlewareå‡½æ•° </span>
<span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'thunkMiddleware'</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">,</span> next<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// loggingMiddlewareå‡½æ•°æ‰§è¡Œåè¿”å›ä¸‹é¢ä»£ç ï¼Œå…¶ä¸­nextä¸ºé—­åŒ…å†…ä¼ å…¥çš„ coreDispatchå‡½æ•°</span>
<span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loggingMiddleware before'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loggingMiddleware after'</span><span class="token punctuation">,</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®Œæˆä¸Šé¢ä¸­é—´ä»¶çš„ç»„åˆä»£ç åï¼Œå…¶<code>store.dispatch</code>å‡½æ•°å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>store<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">delayMiddleware</span><span class="token punctuation">(</span><span class="token function">thunkMiddleware</span><span class="token punctuation">(</span><span class="token function">logginMiddleware</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>åœ¨æ‰§è¡Œ<code>delayMiddleware</code>ä¸­çš„ä»£ç ï¼Œè°ƒç”¨<code>next</code>å‡½æ•°åæ‰§è¡Œ<code>loggingMiddleware</code>ä¸­çš„ä»£ç ï¼Œåœ¨<code>loggingMiddleware</code>ä¸­è°ƒç”¨<code>next</code>åä¼šæ‰§è¡Œ<code>coreDispatch</code>å‡½æ•°ï¼Œå…¶<code>coreDispatch</code>å‡½æ•°å°±æ˜¯æ ¸å¿ƒçš„ä¿®æ”¹<code>state</code>å€¼çš„å‡½æ•°ã€‚å¦‚æ­¤ï¼Œå°±å°†æ•´ä¸ªä¸­é—´ä»¶é“¾æŒ‰ç…§<strong>æ´‹è‘±æ¨¡å‹</strong>ä¸²è”èµ·æ¥äº†ã€‚</p> <h2 id="thunk-middleware"><a href="#thunk-middleware" class="header-anchor">#</a> Thunk middleware</h2> <p>ç°åœ¨æˆ‘ä»¬æ¥åšä¸€äº›â€œå¼‚æ­¥â€çš„äº‹æƒ…ï¼Œä¸Šé¢éƒ½æ˜¯åšä¸€äº›åŒæ­¥çš„ï¼ˆ<code>dispatch</code>åªèƒ½æ¥æ”¶çº¯å¯¹è±¡ï¼ˆ<code>plain object</code>ï¼‰ä½œä¸º <code>action</code>ï¼‰ï¼Œä½†æ˜¯åœ¨å®é™…çš„åº”ç”¨ä¸­éœ€è¦å¤„ç†ï¼š</p> <ul><li>å¼‚æ­¥æ“ä½œï¼ˆAPI è°ƒç”¨ï¼‰</li> <li>æ¡ä»¶ <code>dispatch</code></li> <li>å¤šæ­¥ <code>dispatch</code></li> <li>è®¿é—®å½“å‰çŠ¶æ€åå†å†³å®šæ˜¯å¦ <code>dispatch</code></li></ul> <h3 id="è®¾è®¡ç›®æ ‡"><a href="#è®¾è®¡ç›®æ ‡" class="header-anchor">#</a> è®¾è®¡ç›®æ ‡</h3> <p>åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶ï¼Œä½¿å…¶åœ¨<code>dispatch</code>çš„æ—¶å€™å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…å¯ä»¥æ‰§è¡Œå¼‚æ­¥ç­‰æ“ä½œ</p> <p>æˆ‘ä»¬å…ˆæ¥å¼•å…¥ä¸€ä¸ªâ€œå¼‚æ­¥â€ä¸­é—´ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">thunkMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// use like this:</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getState<span class="token punctuation">,</span> dispatch<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Grab something from the state</span>
  <span class="token keyword">const</span> someId <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>someId<span class="token punctuation">;</span>
  <span class="token comment">// Fetch something that depends on knowing that something</span>
  <span class="token function">fetchSomething</span><span class="token punctuation">(</span>someId<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">something</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Dispatch whenever we feel like it</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'someAction'</span><span class="token punctuation">,</span>
        something
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¦‚æœä¼ å…¥ç»™<code>store.dispatch</code>ä¸­çš„<code>action</code>ä¸ºä¸€ä¸ªå‡½æ•°çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å°†<code>dispatch</code>å‡½æ•°(ä¹Ÿå°±æ˜¯<code>const dispatch = (action) =&gt; store.dispatch(action)</code>)ä»¥åŠ<code>getState</code>å‡½æ•°ä¼ å…¥ï¼Œé‚£ä¹ˆåœ¨<code>action</code>å‡½æ•°ä¸­ï¼Œå°±å¯ä»¥ç»§ç»­é€šè¿‡è°ƒç”¨<code>dispatch</code>å‡½æ•°æ¥ä»å¤´è¿›å…¥<strong>æ´‹è‘±æ¨¡å‹</strong>çš„ä¸­é—´ä»¶é“¾ã€‚</p> <p><code>thunkMiddleware</code>çš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†å¤„ç†<strong>å¼‚æ­¥æ“ä½œ</strong>å’Œ<strong>å¤æ‚çš„é€»è¾‘</strong>ï¼Œè¿™äº›é€»è¾‘å¯èƒ½éœ€è¦<strong>å»¶è¿Ÿdispatch</strong>ã€æˆ–è€…<strong>æœ‰æ¡ä»¶åœ°dispatch</strong>ã€‚åœ¨åŸºæœ¬çš„<code>Redux</code>ä¸­ï¼Œ<code>action</code>å¿…é¡»æ˜¯ä¸€ä¸ªçº¯å¯¹è±¡ï¼Œä½†æ˜¯å½“æˆ‘ä»¬éœ€è¦è¿›è¡Œå¼‚æ­¥æ“ä½œï¼ˆæ¯”å¦‚ä»æœåŠ¡å™¨è·å–æ•°æ®ï¼‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>action</code>å‡½æ•°ä¸­æ‰§è¡Œ<strong>å¼‚æ­¥æ“ä½œ</strong>ï¼Œå¹¶åœ¨å¼‚æ­¥æ“ä½œå®Œæˆåå†<code>dispatch</code>ä¸€ä¸ª<code>action</code>ã€‚</p> <h3 id="åŸºæœ¬æ€è·¯"><a href="#åŸºæœ¬æ€è·¯" class="header-anchor">#</a> åŸºæœ¬æ€è·¯</h3> <p><code>thunkMiddleware</code>ä¼šæ£€æŸ¥ä¼ å…¥<code>dispatch</code>çš„<code>action</code>æ˜¯å¦ä¸ºå‡½æ•°ã€‚å¦‚æœæ˜¯å‡½æ•°ï¼Œåˆ™è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶å°†<code>dispatch</code>å’Œ<code>getState</code>ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚è¿™æ ·ï¼Œè¿™ä¸ªå‡½æ•°ï¼ˆå³thunkï¼‰å°±å¯ä»¥åœ¨å†…éƒ¨æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™ä½¿ç”¨<code>dispatch</code>æ¥å‘å‡ºå…¶ä»–çš„<code>action</code>ã€‚</p> <h3 id="å‡½æ•°è§£æ"><a href="#å‡½æ•°è§£æ" class="header-anchor">#</a> å‡½æ•°è§£æ</h3> <ul><li><p>ä¸­é—´ä»¶ç­¾åï¼š<code>Redux</code>ä¸­é—´ä»¶éµå¾ªæŸ¯é‡ŒåŒ–ï¼ˆ<code>currying</code>ï¼‰é£æ ¼ï¼Œä¾æ¬¡æ¥æ”¶<code>{ dispatch, getState }ã€nextã€action</code>è¿™ä¸‰ä¸ªå‚æ•°ã€‚</p> <ul><li><code>{ dispatch, getState }</code>ï¼šè¿™æ˜¯<code>Redux store</code>çš„ä¸¤ä¸ªæ–¹æ³•ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„<code>dispatch</code>æ˜¯ç»è¿‡ä¸­é—´ä»¶é“¾åŒ…è£…åçš„<code>dispatch</code>ï¼ˆå³ä»æœ€å¤–å±‚ä¼ å…¥çš„ï¼Œå¯èƒ½æ˜¯è¢«å…¶ä»–ä¸­é—´ä»¶å¤„ç†è¿‡çš„ï¼‰ï¼Œè€Œ<code>getState</code>å¯ä»¥è·å–å½“å‰çŠ¶æ€ã€‚</li> <li><code>next</code>ï¼šæ˜¯è°ƒç”¨é“¾ä¸­ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„<code>dispatch</code>æ–¹æ³•ã€‚å¦‚æœå½“å‰ä¸­é—´ä»¶æ˜¯æœ€åä¸€ä¸ªï¼Œé‚£ä¹ˆ<code>next</code>å°±æ˜¯åŸå§‹çš„<code>store.dispatch</code>ã€‚</li> <li><code>action</code>ï¼šå½“å‰è¢«<code>dispatch</code>çš„<code>action</code>ã€‚</li></ul></li> <li><p>åˆ¤æ–­<code>action</code>ç±»å‹ï¼š</p> <ul><li>å¦‚æœ<code>action</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¸ç»§ç»­ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¼ å…¥<code>dispatch</code>å’Œ<code>getState</code>ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨<code>dispatch</code>å…¶ä»–çš„<code>action</code>ã€‚</li> <li>å¦‚æœä¸æ˜¯å‡½æ•°ï¼šé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨<code>next(action)</code>ï¼Œå°†<code>action</code>ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæœ€ç»ˆåˆ°è¾¾<code>reducer</code>ã€‚</li></ul></li></ul> <h3 id="æ´‹è‘±æ¨¡å‹"><a href="#æ´‹è‘±æ¨¡å‹" class="header-anchor">#</a> æ´‹è‘±æ¨¡å‹</h3> <div class="language-text extra-class"><pre class="language-text"><code>store.dispatch(action)
    â†“
ä¸­é—´ä»¶1: æ¥æ”¶ actionï¼Œå¤„ç†ï¼Œè°ƒç”¨ next(action)
    â†“
ä¸­é—´ä»¶2: æ¥æ”¶ actionï¼Œå¤„ç†ï¼Œè°ƒç”¨ next(action)
    â†“
thunkMiddleware: å¦‚æœæ˜¯å‡½æ•°ï¼Œæ‰§è¡Œï¼›å¦åˆ™ next(action)
    â†“
ä¸­é—´ä»¶3: ...
    â†“
æœ€ç»ˆåˆ°è¾¾ reducer
</code></pre></div><h3 id="ä¸ºä»€ä¹ˆè¿”å›-thunk-çš„æ‰§è¡Œç»“æœ"><a href="#ä¸ºä»€ä¹ˆè¿”å›-thunk-çš„æ‰§è¡Œç»“æœ" class="header-anchor">#</a> ä¸ºä»€ä¹ˆè¿”å› thunk çš„æ‰§è¡Œç»“æœï¼Ÿ</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">thunkMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿”å› thunk çš„æ‰§è¡Œç»“æœ</span>
    <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é“¾å¼è°ƒç”¨ï¼Œè·å–å¼‚æ­¥è¯·æ±‚çš„è¿”å›å€¼</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ä½¿ç”¨ç¤ºä¾‹ï¼šthunk å¯ä»¥è¿”å› Promise</span>
<span class="token keyword">const</span> <span class="token function-variable function">fetchUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'SET_USER'</span><span class="token punctuation">,</span> <span class="token literal-property property">payload</span><span class="token operator">:</span> response <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">;</span> <span class="token comment">// è¿”å› Promise</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// è°ƒç”¨</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">fetchUser</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User fetched:'</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="æ‰§è¡Œæµç¨‹è¯¦è§£"><a href="#æ‰§è¡Œæµç¨‹è¯¦è§£" class="header-anchor">#</a> æ‰§è¡Œæµç¨‹è¯¦è§£</h3> <p>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸­é—´ä»¶é“¾ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">middleware1</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 1 start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 1 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">middleware2</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 2 start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Middleware 2 end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">thunkMiddleware</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Thunk Middleware start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Action is a function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å…³é”®ï¼šè¿™é‡Œä¼ å…¥çš„ dispatch æ˜¯ store.dispatch</span>
    <span class="token keyword">return</span> <span class="token function">action</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Thunk Middleware end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ç»„åˆä¸­é—´ä»¶é“¾</span>
<span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span>middleware1<span class="token punctuation">,</span> middleware2<span class="token punctuation">,</span> thunkMiddleware<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®šä¹‰ thunk å‡½æ•°</span>
<span class="token keyword">const</span> <span class="token function-variable function">myAsyncThunk</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> getState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Thunk started'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ç¬¬ä¸€æ­¥ï¼šdispatch ä¸€ä¸ªåŒæ­¥ action</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'START_LOADING'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œå¼‚æ­¥æ“ä½œ</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç¬¬ä¸‰æ­¥ï¼šdispatch å¦ä¸€ä¸ª action</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'FINISH_LOADING'</span><span class="token punctuation">,</span> <span class="token literal-property property">payload</span><span class="token operator">:</span> <span class="token string">'data'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// åˆå§‹ dispatch</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">myAsyncThunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹æ—¥å¿—å¦‚ä¸‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>ç¬¬ä¸€æ¬¡ dispatchï¼ˆthunkï¼‰ï¼š
<span class="token number">1.</span> Middleware <span class="token number">1</span> start
<span class="token number">2.</span> Middleware <span class="token number">2</span> start
<span class="token number">3.</span> Thunk Middleware start
<span class="token number">4.</span> Action is a <span class="token keyword">function</span>
<span class="token number">5.</span> Thunk started

åœ¨ thunk å†…ç¬¬ä¸€æ¬¡ <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'START_LOADING'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>ï¼š
<span class="token number">6.</span> Middleware <span class="token number">1</span> start  â† é‡æ–°å¼€å§‹ï¼
<span class="token number">7.</span> Middleware <span class="token number">2</span> start
<span class="token number">8.</span> Thunk Middleware start
<span class="token number">9.</span> Thunk Middleware <span class="token function">end</span> <span class="token punctuation">(</span>action æ˜¯å¯¹è±¡<span class="token punctuation">)</span>
<span class="token number">10.</span> Middleware <span class="token number">2</span> end
<span class="token number">11.</span> Middleware <span class="token number">1</span> end

åœ¨ thunk å†…ç¬¬äºŒæ¬¡ <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'FINISH_LOADING'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>ï¼ˆå¼‚æ­¥ï¼‰ï¼š
<span class="token number">12.</span> Middleware <span class="token number">1</span> start  â† å†æ¬¡é‡æ–°å¼€å§‹ï¼
<span class="token number">13.</span> Middleware <span class="token number">2</span> start
<span class="token number">14.</span> Thunk Middleware start
<span class="token number">15.</span> Thunk Middleware <span class="token function">end</span> <span class="token punctuation">(</span>action æ˜¯å¯¹è±¡<span class="token punctuation">)</span>
<span class="token number">16.</span> Middleware <span class="token number">2</span> end
<span class="token number">17.</span> Middleware <span class="token number">1</span> end
</code></pre></div><p>å¯ä»¥ä»ä¸Šé¢çš„æ—¥å¿—ä¸­å‘ç°ï¼Œå½“ç¬¬ä¸€æ¬¡è¿›è¡Œ<code>dispatch</code>æ—¶ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šä¾æ¬¡è¿›å…¥æ´‹è‘±æ¨¡å‹æ‰§è¡Œ<code>Middleware1</code>ã€<code>Middleware2</code>ä»¥åŠ<code>thunkMiddleware</code>ã€‚åœ¨<code>thunkMiddleware</code>ä¸­åˆ¤æ–­å…¶<code>action</code>ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œåˆ™æ‰§è¡Œè¯¥å‡½æ•°ï¼Œä¸ç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ã€‚åç»­åœ¨<code>action</code>å‡½æ•°ä¸­ç»§ç»­<code>dispatch</code>åï¼Œé‡æ–°å¼€å§‹æ‰§è¡Œæ´‹è‘±æ¨¡å‹ã€‚</p> <h3 id="ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡"><a href="#ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡" class="header-anchor">#</a> ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ</h3> <ul><li>ä¿æŒä¸­é—´ä»¶é“¾çš„å®Œæ•´æ€§</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ—¥å¿—ä¸­é—´ä»¶</span>
<span class="token keyword">const</span> <span class="token function-variable function">loggerMiddleware</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Dispatching:'</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Next state:'</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// å’Œ Thunk Middleware ä¸€èµ·ä½¿ç”¨</span>
<span class="token function">applyMiddleware</span><span class="token punctuation">(</span>loggerMiddleware<span class="token punctuation">,</span> thunkMiddleware<span class="token punctuation">)</span>

<span class="token comment">// åœ¨ thunk å†… dispatch çš„ action ä¹Ÿåº”è¯¥è¢« logger è®°å½•</span>
<span class="token comment">// æ‰€ä»¥å¿…é¡»é‡æ–°èµ°ä¸€éä¸­é—´ä»¶é“¾</span>
</code></pre></div><ul><li>ä¿è¯ä¸­é—´ä»¶é¡ºåºæ‰§è¡Œ</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ä¸­é—´ä»¶å¯èƒ½æœ‰ä¾èµ–å…³ç³»</span>
<span class="token keyword">const</span> <span class="token function-variable function">middlewareA</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// éœ€è¦å…ˆå¤„ç† action</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'SPECIAL'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    action<span class="token punctuation">.</span>processed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">middlewareB</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¾èµ–äº A çš„å¤„ç†ç»“æœ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>processed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç‰¹æ®Šå¤„ç†</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// å¦‚æœ thunk å†…çš„ dispatch ä¸é‡æ–°èµ°ä¸­é—´ä»¶é“¾</span>
<span class="token comment">// middlewareB å°±çœ‹ä¸åˆ° middlewareA çš„å¤„ç†ç»“æœ</span>
</code></pre></div><ul><li>æ”¯æŒåµŒå¥—çš„å¼‚æ­¥æ“ä½œ</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åµŒå¥—çš„ thunk</span>
<span class="token keyword">const</span> <span class="token function-variable function">complexAsyncFlow</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'STEP_1'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ ¹æ®ç»“æœ dispatch ä¸åŒçš„ action</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>requiresMore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åµŒå¥— dispatch å¦ä¸€ä¸ª thunk</span>
    <span class="token keyword">await</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">fetchMoreData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'STEP_2'</span><span class="token punctuation">,</span> <span class="token literal-property property">payload</span><span class="token operator">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// æ‰€æœ‰ dispatch éƒ½åº”è¯¥ç»è¿‡ç›¸åŒçš„ä¸­é—´ä»¶å¤„ç†</span>
</code></pre></div><h2 id="bring-your-own-components"><a href="#bring-your-own-components" class="header-anchor">#</a> Bring Your own Components</h2> <p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨è¿‡ç»„ä»¶å†…éƒ¨çš„çŠ¶æ€ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨<code>Redux</code>çŠ¶æ€åº“å‘¢ï¼Ÿåªéœ€è¦è€ƒè™‘ä¸‹é¢çš„é—®é¢˜ï¼š</p> <blockquote><p>çŠ¶æ€æ˜¯å¦éœ€è¦åœ¨ç»„ä»¶å¸è½½ä¹‹åç»§ç»­å­˜åœ¨
å¦‚æœä¸Šé¢çš„ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œé‚£ä¹ˆç»„ä»¶çŠ¶æ€å¯èƒ½æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ã€‚å¯¹äºéœ€è¦æŒä¹…åŒ–åˆ°æœåŠ¡å™¨æˆ–è€…éœ€è¦åœ¨å¤šä¸ªç‹¬ç«‹æŒ‚è½½å’Œå¸è½½çš„ç»„ä»¶ä¹‹é—´å…±äº«çš„çŠ¶æ€ï¼Œé‚£ä¹ˆä½¿ç”¨<code>Redux</code>å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">NoteApp</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NoteApp'</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>notes<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

  <span class="token keyword">const</span> notes <span class="token operator">=</span> len <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>notes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
    Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>notes<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">...</span>notes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">onClick</span><span class="token operator">:</span> props<span class="token punctuation">.</span>onAddNote <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Add Note'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">NoteContainer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NoteContainer'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Deact<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useEffect'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback subscribe'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setState'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onAddNote</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">CREATE_NOTE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onAddNote'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>NoteApp<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">notes</span><span class="token operator">:</span> state<span class="token punctuation">.</span>notes<span class="token punctuation">,</span> onAddNote <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>NoteContainer<span class="token punctuation">,</span> <span class="token punctuation">{</span> store <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>åœ¨ä¸Šé¢å®ç°ç»„ä»¶å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†çŠ¶æ€å€¼<code>state</code>ä½œä¸ºå±æ€§å€¼ä¼ å…¥ç»„ä»¶ï¼Œå­ç»„ä»¶å¯ä»¥å¯¹å…¶å€¼è¿›è¡Œæ¸²æŸ“ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°<code>NoteContainer</code>ç»„ä»¶æ²¡æœ‰å®é™…çš„ä½œç”¨ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ·»åŠ çŠ¶æ€å€¼ï¼Œä»¥åŠå¯¹çŠ¶æ€å€¼è¿›è¡Œ<code>subscribe</code>ã€<code>unsubscribe</code>æ“ä½œã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ¯ä¸ªç»„ä»¶éƒ½éœ€è¦ä½¿ç”¨<code>container</code>è¿›è¡ŒåŒ…è£¹çš„è¯ï¼Œæ— ç–‘æ˜¯å¾ˆéº»çƒ¦çš„ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜...</p> <h2 id="provider-and-connect"><a href="#provider-and-connect" class="header-anchor">#</a> <code>Provider and Connect</code></h2> <p>ä¸Šé¢çš„è¯•å®ç°å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸€äº›é—®é¢˜ï¼š</p> <ul><li>éœ€è¦åˆ›å»ºé‡å¤çš„<code>container</code>å®¹å™¨ä»£ç </li> <li>æ¯æ¬¡æƒ³è¦ç”¨<code>store</code>ä¸æŸä¸ªç»„ä»¶é“¾æ¥çš„æ—¶å€™ï¼Œéƒ½å¿…é¡»ä½¿ç”¨å…¨å±€<code>store</code>å¯¹è±¡ï¼Œæˆ–è€…æˆ‘ä»¬éœ€è¦å°†<code>store</code>å±æ€§ä¼ é€’ç»™æ•´ä¸ªç»„ä»¶æ ‘ï¼Œè¿™ç§å†™æ³•åœ¨å¤§å‹åº”ç”¨ä¸­ä¸æ˜¯ç†æƒ³çš„.</li></ul> <p>é‚£å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>React Redux</code>ä¸­çš„<code>Provider</code>å’Œ<code>connect</code>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">Provider</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Deact<span class="token punctuation">.</span>Provider<span class="token punctuation">,</span> 
    <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> props<span class="token punctuation">.</span>store <span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token punctuation">.</span>children
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„<code>Provider</code>ç»„ä»¶åˆ©ç”¨äº†<code>React</code>çš„ä¸Šä¸‹æ–‡åŠŸèƒ½ï¼Œå°†<code>store</code>è½¬æ¢ä¸ºä¸Šä¸‹æ–‡<code>context</code>å±æ€§ã€‚ä¸Šä¸‹æ–‡<code>context</code>æ˜¯ä¸€ç§å°†ä¿¡æ¯ä»é¡¶å±‚ç»„ä»¶ä¼ æ¯’ç»™å­ç»„ä»¶çš„æ–¹å¼ï¼Œä¸­é—´ç»„ä»¶æ— éœ€æ˜¾å¼ä¼ é€’å±æ€§ã€‚<code>Provider</code>åªæä¾›äº†çŠ¶æ€çš„ä¼ é€’ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç»„ä»¶æ¥å®ç°çŠ¶æ€å€¼æ”¹å˜çš„è®¢é˜…ç­‰æ“ä½œ.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> StoreContext <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Connect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">mapStateToProps<span class="token punctuation">,</span> mapDispatchToProps</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> store <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>StoreContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// ä½¿ç”¨ useRef ä¿å­˜æœ€æ–°çš„ props å’Œæ˜ å°„å‡½æ•°ï¼Œä»¥ä¾¿åœ¨è®¢é˜…å›è°ƒä¸­ä½¿ç”¨</span>
      <span class="token keyword">const</span> propsRef <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> mapStateToPropsRef <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> mapDispatchToPropsRef <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span>mapDispatchToProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// æ›´æ–° ref çš„å€¼ï¼Œç¡®ä¿è®¢é˜…å›è°ƒä¸­æ€»æ˜¯ä½¿ç”¨æœ€æ–°çš„å€¼</span>
      propsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> props<span class="token punctuation">;</span>
      mapStateToPropsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> mapStateToProps<span class="token punctuation">;</span>
      mapDispatchToPropsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> mapDispatchToProps<span class="token punctuation">;</span>
      
      <span class="token comment">// è®¡ç®—å½“å‰çš„ props</span>
      <span class="token keyword">const</span> currentState <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> stateProps <span class="token operator">=</span> <span class="token function">mapStateToProps</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dispatchProps <span class="token operator">=</span> <span class="token function">mapDispatchToProps</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// ä½¿ç”¨ useState æ¥å­˜å‚¨ä¸€ä¸ªå¼ºåˆ¶æ›´æ–°çš„è®¡æ•°å™¨</span>
      <span class="token comment">// å½“ store å˜åŒ–æ—¶ï¼Œé€’å¢è®¡æ•°å™¨ï¼Œè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>updateCount<span class="token punctuation">,</span> setUpdateCount<span class="token punctuation">]</span> <span class="token operator">=</span> Deact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è®¢é˜… store çš„å˜åŒ–</span>
      Deact<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setUpdateCount</span><span class="token punctuation">(</span><span class="token parameter">prev</span> <span class="token operator">=&gt;</span> prev <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// æ¯æ¬¡æ¸²æŸ“æ—¶ï¼Œé‡æ–°è®¡ç®—å¹¶ç›´æ¥ä¼ é€’ç»™å­ç»„ä»¶</span>
      <span class="token keyword">const</span> mergedProps <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>stateProps<span class="token punctuation">,</span> <span class="token operator">...</span>dispatchProps <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span>mergedProps<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">mapStateToProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">notes</span><span class="token operator">:</span> state<span class="token punctuation">.</span>notes<span class="token punctuation">,</span>
    <span class="token literal-property property">openNoteId</span><span class="token operator">:</span> state<span class="token punctuation">.</span>openNoteId
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">mapDispatchToProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onAddNote</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">CREATE_NOTE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onOpenNote</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">OPEN_NOTE</span><span class="token punctuation">,</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onCloseNote</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">CLOSE_NOTE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> NoteAppContainer <span class="token operator">=</span> <span class="token function">Connect</span><span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">,</span> mapDispatchToProps<span class="token punctuation">)</span><span class="token punctuation">(</span>NoteApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NoteAppContainer'</span><span class="token punctuation">,</span> NoteAppContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
Deact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
    StoreContext<span class="token punctuation">.</span>Provider<span class="token punctuation">,</span> 
    <span class="token punctuation">{</span> 
      <span class="token literal-property property">value</span><span class="token operator">:</span> store 
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    Deact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>NoteAppContainer<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span> 
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå®ç°äº†ä¸€ä¸ª<code>Connect</code>ç»„ä»¶ï¼Œå‘è¯¥å‡½æ•°ä¼ å…¥ä¸¤ä¸ªæ˜ å°„å‡½æ•°ï¼Œä¸€ä¸ªå°†<code>state</code>æ˜ å°„ä¸º<code>props</code>ä¸­çš„å±æ€§ï¼Œä¸€ä¸ªå°†<code>dispatch</code>æ˜ å°„ä¸º<code>props</code>ä¸­çš„æ–¹æ³•ï¼Œç„¶åä¼ å…¥ä¸€ä¸ªéœ€è¦è¢«åŒ…è£¹çš„ç»„ä»¶ï¼Œæ‰§è¡Œå®Œæˆåä¼šè¿”å›ä¸€ä¸ªç»„ä»¶å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æœ‰è¢«æ˜ å°„çš„å±æ€§ä»¥åŠæ–¹æ³•ï¼Œè¿˜æœ‰æœ€é‡è¦çš„å°±æ˜¯ï¼Œå¯¹<code>store</code>ä¿®æ”¹æ·»åŠ è®¢é˜…æ›´æ–°äº‹ä»¶<code>subscribe</code></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge/assets/js/app.5153ca81.js" defer></script><script src="/knowledge/assets/js/2.09711cee.js" defer></script><script src="/knowledge/assets/js/1.ecac6abe.js" defer></script><script src="/knowledge/assets/js/89.aa1e2fe4.js" defer></script>
  </body>
</html>
