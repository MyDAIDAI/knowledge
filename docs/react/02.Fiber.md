# React åŸç†ä¹‹ Fiber

## åˆ›å»º`FiberRootNode`

åœ¨æ¸²æŸ“é¡µé¢æ—¶ä½¿ç”¨äº†ä¸‹é¢æ–¹æ³•æ¥è¿›è¡Œ`JSX`ä¸`DOM`å®¹å™¨çš„å…³è”

```ts
createRoot(document.getElementById("root")!).render(<App />);
```

è¯¦ç»†è¿›å…¥`createRoot`å¯ä»¥çœ‹åˆ°ï¼š

```ts
export function createRoot(container) {
  const root = createContainer(container);
  return {
    render(element) {
      return updateContainer(element, root);
    },
  };
}
```

å¯ä»¥çœ‹åˆ°ä¸»è¦æ‰§è¡Œäº†ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±å®Œæˆäº†`JSX`çš„è½¬æ¢ä»¥åŠ`DOM`æ ‘çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œé‚£ä¹ˆæ˜¯è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Œä¸‹é¢ ğŸ‘‡ğŸ» æˆ‘ä»¬åˆ†æ­¥éª¤æ¥è¿›è¡Œè§£æï¼Œé¦–å…ˆè¿›å…¥`createContainer`æ–¹æ³•

```ts
export function createContainer(container: Container) {
  const hostRootFiber = new FiberNode(HostRoot, {}, null);
  const root = new FiberRootNode(container, hostRootFiber);
  hostRootFiber.updateQueue = createUpdateQueue<ReactElement>();
  return root;
}
```

åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦æ˜¯åˆ›å»ºäº†ä¸¤ä¸ªå®ä¾‹ï¼Œä¸€ä¸ªæ˜¯`hostRootFiber`ï¼Œä¸€ä¸ªæ˜¯`root`ï¼Œå¹¶ä¸”è°ƒç”¨`createUpdateQueue`åˆ›å»ºäº†ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—ï¼Œå°±æ˜¯è¿”å›äº†ä¸€ä¸ªç»“æ„ä¸º`{ shared: { pending: null }}`çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„å€¼ç°åœ¨ä¸º`null`ï¼ŒåæœŸåœ¨ç¬¬äºŒé˜¶æ®µä¼šå°†å…¶æŒ‡å‘ä¸ºéœ€è¦æ›´æ–°çš„`<App />`

```ts
export const createUpdateQueue = <Action>() => {
  const updateQueue: UpdateQueue<Action> = {
    shared: {
      pending: null,
    },
    dispatch: null,
  };
  return updateQueue;
};
```

`hostRootFiber`æ˜¯ä¸€ä¸ª`FiberNode`çš„å®ä¾‹ï¼Œå…¶`type`å€¼ä¸º`HostRoot`ï¼Œä¹Ÿå°±æ˜¯å‡­ç©ºåˆ›å»ºäº†ä¸€ä¸ªé¡¶çº§çš„`FiberNode`èŠ‚ç‚¹

`root`æ˜¯`FiberRootNode`çš„å®ä¾‹ï¼Œåœ¨è¿™ä¸ªå®ä¾‹å¯¹è±¡ä¸­ï¼Œå°†`hostRootFiber`ä¸`DOM`èŠ‚ç‚¹è¿›è¡Œäº†å…³è”ï¼Œåœ¨å†…å­˜ä¸­ç”Ÿæˆäº†å¦‚ä¸‹æ•°æ®æ¨¡å‹
![02.1](image-2.png)

![02.2](image.png)

è¯¦ç»†æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

- `root`ç»“æ„

```json
callbackNode:null
callbackPriority:0
container:div#root
current:FiberNode {tag: 3, key: null, stateNode: FiberRootNode, type: null, return: null, â€¦}
finishedLanes:0
finishedWork:null
pendingLanes:0
pendingPassiveEffects:{unmount: Array(0), update: Array(0)}
```

- `hostRootFiber`ç»“æ„

```json
alternate:null
child:null
deletions:null
flags:0
index:0
key:null
lanes:0
memoizedProps:null
memoizedState:null
pendingProps:{}
ref:null
return:null
sibling:null
stateNode:FiberRootNode {container: div#root, current: FiberNode, finishedWork: null, pendingPassiveEffects: {â€¦}, pendingLanes: 0, â€¦}
subtreeFlags:0
tag:3
type:null
updateQueue:{shared: {pending: null}}
```

## `updateContainer`

åœ¨åˆ›å»ºäº†ä¸€ä¸ªæ ¹`fiber`çš„`root`èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†å…¶ä¸å®¹å™¨`DOM`è¿›è¡Œå…³è”ä¹‹åï¼Œæ‰§è¡Œäº†`updateContainer`å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å°†éœ€è¦æ›´æ–°çš„`JSX`æ”¾å…¥äº†æ›´æ–°é˜Ÿåˆ—`updateQueue`ä¸­ï¼Œå¹¶ä½¿ç”¨çš„æ·±åº¦ä¼˜å…ˆéå†è¿›è¡Œå­æ ‘çš„`FiberNode`çš„åˆ›å»º

```ts
export function updateContainer(
  element: ReactElement | null,
  root: FiberRootNode
) {
  const hostRootFiber = root.current;
  const update = createUpdate<ReactElement | null>(element, rootRenderPriority);
  enqueueUpdate(
    hostRootFiber.updateQueue as UpdateQueue<ReactElement | null>,
    update
  );
  scheduleUpdateOnFiber(hostRootFiber, rootRenderPriority);
  return element;
}
```

ä¸Šé¢çš„`createUpdate`å‡½æ•°å¾ˆç®€å•ï¼Œå°±æ˜¯è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­`action`æŒ‡å‘éœ€è¦æ›´æ–°çš„`ReactElement`å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯`<App />`

```ts
action: {$$typeof: Symbol(react.element), key: null, ref: null, props: {â€¦}, type: Æ’, â€¦}
lane: 1
next: null
```

ç„¶åæ‰§è¡Œ`enqueueUpdate`å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯å°†ä¹‹å‰è¿”å›çš„`update`ä»»åŠ¡åŠ å…¥åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶ç”±äºæ˜¯åˆæ¬¡æ‰§è¡Œï¼Œæ‰€ä»¥`updateQueue.shared.pending`ä¸º`null`ï¼Œæ‰§è¡Œåç”Ÿæˆå¦‚ä¸‹ç»“æ„
![alt text](image-3.png)

ç„¶åæ‰§è¡Œè°ƒåº¦æ–¹æ³•è¿›è¡Œè°ƒåº¦`scheduleUpdateOnFiber`


