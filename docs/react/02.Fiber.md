# React åŸç†ä¹‹ Fiber

åœ¨æ¸²æŸ“é¡µé¢æ—¶ä½¿ç”¨äº†ä¸‹é¢æ–¹æ³•æ¥è¿›è¡Œ`JSX`ä¸`DOM`å®¹å™¨çš„å…³è”

```ts
createRoot(document.getElementById("root")!).render(<App />);
```

è¯¦ç»†è¿›å…¥`createRoot`å¯ä»¥çœ‹åˆ°ï¼š

```ts
export function createRoot(container) {
  const root = createContainer(container);
  return {
    render(element) {
      return updateContainer(element, root);
    },
  };
}
```

å¯ä»¥çœ‹åˆ°ä¸»è¦æ‰§è¡Œäº†ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±å®Œæˆäº†`JSX`çš„è½¬æ¢ä»¥åŠ`DOM`æ ‘çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œé‚£ä¹ˆæ˜¯è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Œä¸‹é¢ ğŸ‘‡ğŸ» æˆ‘ä»¬åˆ†æ­¥éª¤æ¥è¿›è¡Œè§£æï¼Œé¦–å…ˆè¿›å…¥`createContainer`æ–¹æ³•

```ts
export function createContainer(container: Container) {
  const hostRootFiber = new FiberNode(HostRoot, {}, null);
  const root = new FiberRootNode(container, hostRootFiber);
  hostRootFiber.updateQueue = createUpdateQueue<ReactElement>();
  return root;
}
```

åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦æ˜¯åˆ›å»ºäº†ä¸¤ä¸ªå®ä¾‹ï¼Œä¸€ä¸ªæ˜¯`hostRootFiber`ï¼Œä¸€ä¸ªæ˜¯`root`ï¼Œå¹¶ä¸”è°ƒç”¨`createUpdateQueue`åˆ›å»ºäº†ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—ï¼Œå°±æ˜¯è¿”å›äº†ä¸€ä¸ªç»“æ„ä¸º`{ shared: { pending: null }}`çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„å€¼ç°åœ¨ä¸º`null`ï¼ŒåæœŸåœ¨ç¬¬äºŒé˜¶æ®µä¼šå°†å…¶æŒ‡å‘ä¸ºéœ€è¦æ›´æ–°çš„`<App />`

```ts
export const createUpdateQueue = <Action>() => {
  const updateQueue: UpdateQueue<Action> = {
    shared: {
      pending: null,
    },
    dispatch: null,
  };
  return updateQueue;
};
```

`hostRootFiber`æ˜¯ä¸€ä¸ª`FiberNode`çš„å®ä¾‹ï¼Œå…¶`type`å€¼ä¸º`HostRoot`ï¼Œä¹Ÿå°±æ˜¯å‡­ç©ºåˆ›å»ºäº†ä¸€ä¸ªé¡¶çº§çš„`FiberNode`èŠ‚ç‚¹

`root`æ˜¯`FiberRootNode`çš„å®ä¾‹ï¼Œåœ¨è¿™ä¸ªå®ä¾‹å¯¹è±¡ä¸­ï¼Œå°†`hostRootFiber`ä¸`DOM`èŠ‚ç‚¹è¿›è¡Œäº†å…³è”ï¼Œåœ¨å†…å­˜ä¸­ç”Ÿæˆäº†å¦‚ä¸‹æ•°æ®æ¨¡å‹
![02.1](image-2.png)

![02.2](image.png)
