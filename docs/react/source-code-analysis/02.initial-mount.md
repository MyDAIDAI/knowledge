# reactå†…éƒ¨çš„åˆå§‹åŒ–æŒ‚è½½

ç°åœ¨ä¸‹é¢æœ‰å¦‚ä¸‹é¡µé¢æ¸²æŸ“ä»£ç ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>React in HTML</title>
    <script src="./react.development.js"></script>
    <script src="./react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<style>
  .component {
    border: 1px solid #ccc;
    padding: 10px;
    margin: 10px;
  }
</style>
<body>
  <div id="root"></div>

  <!-- ä½¿ç”¨ type="text/babel" è®© Babel ç¼–è¯‘ JSX -->
  <script type="text/babel">

    function A() {
      return (
        <div className="component" data-name="A">
          <div>A</div>
          <div>B</div>
        </div>
      );
    }


    // åˆ›å»º React ç»„ä»¶
    function App() {
      return (
        <A />
      );
    }

    // æ¸²æŸ“ç»„ä»¶åˆ° DOM
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
```

## Fiberç»“æ„ä»‹ç»

ä¸Šé¢çš„ä»£ç å¤§æ¦‚æ˜¯å¦‚ä¸‹çš„å±‚çº§ç»“æ„ï¼š

```jsx
<App>
    <A>
        <div>
            <div>A</div>
            <div>B</div>
        </div>
    </A>
</App>
```

ä¸Šé¢çš„ç»“æ„åœ¨`React`ä¸­ä¼šæ„å»ºå¦‚ä¸‹å›¾çš„ä¸€ä¸ª`FiberTree`
![alt text](image-2.png)

ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¯¥`FiberTree`ä¸­ä¸€å…±åŒ…å«2ç§ä¸åŒçš„ç±»å‹ï¼š

- `FiberRootNode`: `FiberRootNode` æ˜¯ä¸€ä¸ªç‰¹æ®ŠèŠ‚ç‚¹ï¼Œå……å½“ `React` çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒä¿å­˜ç€æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€çš„å…ƒæ•°æ®ã€‚å…¶ `current` å±æ€§æŒ‡å‘å®é™…çš„ `Fiber` æ ‘ç»“æ„ï¼Œæ¯æ¬¡æ„å»ºæ–°çš„ `Fiber` æ ‘æ—¶ï¼Œå®ƒéƒ½ä¼šå°† `current` é‡æ–°æŒ‡å‘æ–°çš„ `HostRoot`ã€‚
- `FiberNode`: `react`å†…éƒ¨ä¸­å¯¹ç»“ç‚¹çš„ä¸€ç§è¡¨ç¤ºï¼ŒåŒ…å«å¾ˆå¤šå±æ€§å¯ä»¥å¯¹å…¶ç»“ç‚¹è¿›è¡Œæè¿°
  - `tag`: `FiberNode`æœ‰è®¸å¤šä¸åŒçš„å­ç±»å‹ï¼Œåœ¨`render`ä»¥åŠ`commit`é˜¶æ®µä¼šæ ¹æ®è¯¥å€¼è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œå¦‚`HostRoot`ã€`FunctionComponent`ã€`ClassComponent`ã€`HostComponent`ç­‰ç­‰
  - `stateNode`: å¯¹äº`tag`ä¸º`HostComponet`çš„`FiberNode`ï¼Œå…¶æŒ‡å‘é¡µé¢ä¸­å®é™…æ¸²æŸ“çš„`DOM`èŠ‚ç‚¹
  - `child`ã€`sibling`ã€`return`: åˆ†åˆ«æŒ‡å‘å­èŠ‚ç‚¹ï¼Œå…„å¼ŸèŠ‚ç‚¹ä»¥åŠçˆ¶èŠ‚ç‚¹ï¼Œç”¨äºæ„é€ å®Œæ•´`Fiber`æ ‘
  - `flags`: ç”¨äºè¡¨ç¤ºåœ¨ `commit` é˜¶æ®µéœ€è¦æ›´æ–°çš„ç±»å‹ã€‚subtreeFlags è¡¨ç¤ºå…¶å­æ ‘éœ€è¦æ›´æ–°çš„ç±»å‹

ä¸Šé¢å¯¹äº`FiberNode`çš„å±æ€§ä»‹ç»åªåŒ…å«å½“å‰åˆå§‹åŒ–é¡µé¢æ‰€éœ€è¦çš„å±æ€§ï¼Œå…¶ä»–å±æ€§åœ¨åé¢éœ€è¦ç”¨åˆ°æ—¶å†è¿›è¡Œè§£é‡Šã€‚

## å¤§è‡´è¿‡ç¨‹

æˆ‘ä»¬å…ˆæ¥æŠŠæ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹è¿›è¡Œä¸€ä¸ªç²—ç•¥çš„ä»‹ç»ï¼Œæˆ‘ä»¬åœ¨æ¸²æŸ“é¡µé¢æ—¶ï¼Œä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç 

```jsx
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ†ä¸ºäº†ä»¥ä¸‹ä¸¤ä¸ªä¸»è¦è¿‡ç¨‹ï¼š

1. `createRoot`
2. `render`

### `createRoot`

ä¸Šé¢çš„`createRoot`ä¼šåˆ›å»ºä¸€ä¸ª`FiberRootNode`

```jsx
function createRoot(container, options) {
    var root = createContainer(container, ConcurrentRoot, null, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError);
    return new ReactDOMRoot(root);
  }

function createContainer(containerInfo, tag, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError, transitionCallbacks) {
    var hydrate = false;
    var initialChildren = null;
    return createFiberRoot(containerInfo, tag, hydrate, initialChildren, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError);
  }


function createFiberRoot(containerInfo, tag, hydrate, initialChildren, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError, transitionCallbacks) {
    var root = new FiberRootNode(containerInfo, tag, hydrate, identifierPrefix, onRecoverableError);
    var uninitializedFiber = createHostRootFiber(tag, isStrictMode);
    root.current = uninitializedFiber;
    uninitializedFiber.stateNode = root;
    return root;
  }
```

ä¸Šé¢ä»£ç çš„å¤§è‡´æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š
![alt text](image-3.png)

æ‰§è¡Œå®Œæˆåï¼Œä¼šåˆ›å»ºä¸€ä¸ª`FiberRootNode`ï¼Œä¿å­˜åœ¨`ReactDomRoot`å®ä¾‹çš„`this._internalRoot`ä¸­ï¼Œå……å½“ `React` çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒä¿å­˜ç€æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€çš„å…ƒæ•°æ®ã€‚å…¶ `current` å±æ€§æŒ‡å‘å®é™…çš„ `Fiber` æ ‘ç»“æ„ï¼Œæ¯æ¬¡æ„å»ºæ–°çš„ `Fiber` æ ‘æ—¶ï¼Œå®ƒéƒ½ä¼šå°† `current` é‡æ–°æŒ‡å‘æ–°çš„ `HostRoot`ã€‚

å½“å‰çš„`root`å±æ€§å¦‚ä¸‹ï¼š

![alt text](image-4.png)

ä¸Šå›¾ä¸­çš„`root`ä¸ºå½“å‰`ReactDOMRoot`çš„å®ä¾‹ï¼Œå†…éƒ¨`_internalRoot`ä¸ºå½“å‰å®ä¾‹çš„`FiberRootNode`ï¼Œå…¶`current`æŒ‡å‘å½“å‰é¡µé¢çš„`FiberNode`èŠ‚ç‚¹ã€‚å…¶ä¸­`tag`çš„å€¼ä¸º`3`ï¼Œè¡¨ç¤º`FiberNode`çš„èŠ‚ç‚¹ç±»å‹ä¸º`HostRoot`ã€‚

![alt text](image-5.png)

### render

åœ¨`render`è¿‡ç¨‹ä¸­ä¸»è¦æ‰§è¡Œäº†ä¸‹é¢å†…å®¹ï¼š

```jsx
ReactDOMRoot.prototype.render = function (children) {
  var root = this._internalRoot;
  updateContainer(children, root, null, null);
};

function updateContainer(element, container, parentComponent, callback) {
  // some other code...
  var update = createUpdate(eventTime, lane);
  update.payload = {
    element: element
  };
  callback = callback === undefined ? null : callback;
  var root = enqueueUpdate(current$1, update, lane);

  if (root !== null) {
    // è¿›å…¥è°ƒåº¦å™¨ schedule
    scheduleUpdateOnFiber(root, current$1, lane, eventTime);
  }
  return lane;
}

function scheduleUpdateOnFiber(root, fiber, lane, eventTime) {
  if ((executionContext & RenderContext) !== NoLanes && root === workInProgressRoot) {
    // some code...
  } else {
    // ç¡®ä¿FiberRootNodeè¢«è°ƒåº¦
    ensureRootIsScheduled(root, eventTime);
  }
}

function ensureRootIsScheduled(root, currentTime) {
  // some code...
  // è·å–æ›´æ–°ä¼˜å…ˆçº§ï¼Œæ‹¿å–æœ€é«˜çº§åˆ«çš„ä¼˜å…ˆçº§ä»»åŠ¡è¿›è¡Œæ‰§è¡Œ
   scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));
}

function performSyncWorkOnRoot(root) {
    var exitStatus = renderRootSync(root, lanes);
    var finishedWork = root.current.alternate;
    root.finishedWork = finishedWork;
    root.finishedLanes = lanes;
    commitRoot(root, workInProgressRootRecoverableErrors, workInProgressTransitions);
    return null;
  }
```

ä¸Šé¢çš„ä»£ç å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‹é¢çš„æµç¨‹å›¾ï¼š
![alt text](image-6.png)

å…¶ä¸­`scheduleUpdateOnFiber`ã€`ensureRootIsScheduled`ä»¥åŠ`scheduleSyncCallback`éƒ½æ˜¯è°ƒåº¦ç›¸å…³çš„å‡½æ•°ï¼Œæœ¬ç« çš„é‡ç‚¹æ˜¯æ¸²æŸ“ï¼Œå…ˆæš‚æ—¶è·³è¿‡è¿™äº›å†…å®¹ï¼ŒåæœŸè°ƒåº¦ç›¸å…³ä¼šè¯¦ç»†è®²è§£ã€‚æ¸²æŸ“ç›¸å…³çš„æ ¸å¿ƒå‡½æ•°ä¸º`performSyncWorkOnRoot`ï¼Œä»¥åŠ`performConcurrentWorkOnRoot`å‡½æ•°ï¼Œ`performSyncWorkOnRoot`ä¸º**åŒæ­¥æ¨¡å¼**ï¼Œ`performConcurrentWorkOnRoot`ä¸º**å¹¶å‘æ¨¡å¼**

#### åŒæ­¥æ¨¡å¼

```text
performSyncWorkOnRoot
    â†“
renderRootSync  // åŒæ­¥æ¸²æŸ“æ ¹èŠ‚ç‚¹
    â†“
workLoopSync    // åŒæ­¥å·¥ä½œå¾ªç¯ï¼ˆä¸å¯ä¸­æ–­ï¼‰
    â†“
completeUnitWork // å®Œæˆå•å…ƒå·¥ä½œ
    â†“
commitRoot      // æäº¤å˜æ›´åˆ°DOM
```

#### å¹¶å‘æ¨¡å¼

```text
performConcurrentWorkOnRoot
    â†“
renderRootConcurrent  // å¹¶å‘æ¸²æŸ“æ ¹èŠ‚ç‚¹
    â†“
workLoopConcurrent    // å¹¶å‘å·¥ä½œå¾ªç¯ï¼ˆå¯ä¸­æ–­ï¼‰
    â†“
shouldYield? â†’ æ˜¯ â†’ æš‚åœå¹¶è¿”å›
    â†“
completeUnitWork
    â†“
commitRoot
```

ä¸Šé¢çš„åŒæ­¥æ¨¡å¼ä¸å¹¶å‘æ¨¡å¼çš„ä¸»è¦åŒºåˆ«ä¸ºæ¸²æŸ“æ ¹èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œ**åŒæ­¥æ¨¡å¼**åˆ›å»º`FiberTree`çš„è¿‡ç¨‹**ä¸å¯ä¸­æ–­**ï¼Œ**å¹¶å‘æ¨¡å¼**åˆ™å¯ä»¥è¢«**é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¸­æ–­**ï¼Œè€Œ`commitRoot`è¿‡ç¨‹åˆ™æ˜¯ä¸€è‡´éƒ½ï¼Œéƒ½æ˜¯åŒæ­¥æ‰§è¡Œã€‚

ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°`render`å‡½æ•°ä¸­æ‰§è¡Œäº†`renderRootSync`ä¸`commitRoot`ä¸¤ä¸ªå‡½æ•°ï¼Œä¹Ÿæ˜¯`React`ä¸­æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º`FiberNode`ä»¥åŠå¯¹åº”çš„`stateNode`ã€`flags`ã€`subtreeFlags`,å¹¶ç”Ÿæˆ`FiberTree`ï¼Œå¦ä¸€ä¸ªæ˜¯æ ¹æ®å‰é¢åˆ›å»ºçš„`FiberTree`ï¼Œè·å–å¯¹åº”èŠ‚ç‚¹çš„`flags`ä»¥åŠ`subtreeFlags`æ¥è¿›è¡Œå¯¹åº”çš„`DOM`èŠ‚ç‚¹æŒ‚è½½æ“ä½œã€‚

ğŸ“¢ æ³¨æ„ï¼šç”±äº`commitRoot`æ˜¯ä¸€æ¬¡æ‰§è¡Œå®Œæˆçš„æŒ‚è½½è¿‡ç¨‹ï¼Œä¸ºäº†é¿å…æµè§ˆå™¨äº§ç”Ÿé—ªçƒä»¥åŠé‡ç»˜ç­‰ï¼Œ`React`å†…éƒ¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨`render`é˜¶æ®µï¼Œå°±å°†å­æ ‘çš„æ•´ä¸ª`DOM`æ ‘æ„å»ºå®Œæˆäº†ã€‚ä¸‹é¢ä¼šè¿›è¡Œè¯¦ç»†çš„è§£æï¼š

#### renderRootSync

åœ¨`renderRootSync`å‡½æ•°ä¸­çš„æ ¸å¿ƒä¸º`do...while(true)`çš„æ‰§è¡Œ`workLoopSync`å‡½æ•°

```jsx
function renderRootSync(root, lanes) {
  prepareFreshStack(root, lanes);
  do {
    try {
      workLoopSync();
      break;
    } catch (thrownValue) {
      handleError(root, thrownValue);
    }
  } while (true);
  workInProgressRoot = null;
  workInProgressRootRenderLanes = NoLanes;

  return workInProgressRootExitStatus;
}

function prepareFreshStack(root, lanes) {
    root.finishedWork = null;
    root.finishedLanes = NoLanes;

    workInProgressRoot = root;
    var rootWorkInProgress = createWorkInProgress(root.current, null);
    workInProgress = rootWorkInProgress;
    finishQueueingConcurrentUpdates();
    return rootWorkInProgress;
  }

function workLoopSync() {
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}


function performUnitOfWork(unitOfWork) {
  var current = unitOfWork.alternate;
  setCurrentFiber(unitOfWork);
  var next;

  if ( (unitOfWork.mode & ProfileMode) !== NoMode) {
    next = beginWork(current, unitOfWork, subtreeRenderLanes);
  } else {
    next = beginWork(current, unitOfWork, subtreeRenderLanes);
  }

  resetCurrentFiber();
  unitOfWork.memoizedProps = unitOfWork.pendingProps;

  if (next === null) {
    completeUnitOfWork(unitOfWork);
  } else {
    workInProgress = next;
  }

  ReactCurrentOwner$2.current = null;
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`prepareFreshStack`å‡½æ•°å°†å½“å‰`FiberRootNode`ç±»å‹çš„èŠ‚ç‚¹ä¼ å…¥ï¼Œä½¿ç”¨å…¶`root.current`å±æ€§åˆ›å»º`workInProgress`ï¼Œ`root.current`ä¸ºå½“å‰å®¹å™¨çš„`FiberNode`èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯`FiberNode(HostRoot)`ï¼Œ`workLoopSync`ä»¥åŠ`performUnitOfWork`å‡½æ•°å®ç°äº†å¯¹`FiberTree`çš„åˆ›å»ºï¼Œå…¶ä¸­`beginWork`æ˜¯åˆ›å»º`FiberNode`ï¼Œ`completeUnitOfWork`ä¸ºåˆ›å»º`stateNode`å¹¶æ„å»ºå½“å‰èŠ‚ç‚¹çš„`DOM`æ ‘çš„è¿‡ç¨‹ã€‚

##### beginWork

ä¸‹é¢æ˜¯`beginWork`å‡½æ•°çš„ä¸»è¦å†…å®¹ï¼Œä¸»è¦å°±æ˜¯æ ¹æ®`fiberNode`çš„`tag`å€¼æ‰§è¡Œä¸åŒçš„æ–¹æ³•

```jsx
function beginWork(current, workInProgress, renderLanes) {
  workInProgress.lanes = NoLanes;

  switch (workInProgress.tag) {
    case IndeterminateComponent:
      {
        return mountIndeterminateComponent(current, workInProgress, workInProgress.type, renderLanes);
      }

    case FunctionComponent:
      {
        var Component = workInProgress.type;
        var unresolvedProps = workInProgress.pendingProps;
        var resolvedProps = workInProgress.elementType === Component ? unresolvedProps : resolveDefaultProps(Component, unresolvedProps);
        return updateFunctionComponent(current, workInProgress, Component, resolvedProps, renderLanes);
      }

    case HostRoot:
      return updateHostRoot(current, workInProgress, renderLanes);

    case HostComponent:
      return updateHostComponent(current, workInProgress, renderLanes);

    case HostText:
      return updateHostText(current, workInProgress);
  }
}
```

è®©æˆ‘ä»¬ä»å¤´è¿›å…¥è¯¥å‡½æ•°ï¼Œäº†è§£ä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹ï¼Œç°åœ¨ä½¿ç”¨äº†å¦‚ä¸‹çš„ç»“æ„è¿›è¡Œæ¸²æŸ“ï¼š

```jsx
<App>
    <A>
        <div>
            <div>A</div>
            <div>B</div>
        </div>
    </A>
</App>
```
