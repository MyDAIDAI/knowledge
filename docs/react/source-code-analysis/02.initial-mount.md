# reactå†…éƒ¨çš„åˆå§‹åŒ–æŒ‚è½½

ç°åœ¨ä¸‹é¢æœ‰å¦‚ä¸‹é¡µé¢æ¸²æŸ“ä»£ç ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>React in HTML</title>
    <script src="./react.development.js"></script>
    <script src="./react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<style>
  .component {
    border: 1px solid #ccc;
    padding: 10px;
    margin: 10px;
  }
</style>
<body>
  <div id="root"></div>

  <!-- ä½¿ç”¨ type="text/babel" è®© Babel ç¼–è¯‘ JSX -->
  <script type="text/babel">

    function A() {
      return (
        <div className="component" data-name="A">
          <div>A</div>
          <div>B</div>
        </div>
      );
    }


    // åˆ›å»º React ç»„ä»¶
    function App() {
      return (
        <A />
      );
    }

    // æ¸²æŸ“ç»„ä»¶åˆ° DOM
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
```

## Fiberç»“æ„ä»‹ç»

ä¸Šé¢çš„ä»£ç å¤§æ¦‚æ˜¯å¦‚ä¸‹çš„å±‚çº§ç»“æ„ï¼š

```jsx
<App>
    <A>
        <div>
            <div>A</div>
            <div>B</div>
        </div>
    </A>
</App>
```

ä¸Šé¢çš„ç»“æ„åœ¨`React`ä¸­ä¼šæ„å»ºå¦‚ä¸‹å›¾çš„ä¸€ä¸ª`FiberTree`
![alt text](./images/image-2.png)

ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¯¥`FiberTree`ä¸­ä¸€å…±åŒ…å«2ç§ä¸åŒçš„ç±»å‹ï¼š

- `FiberRootNode`: `FiberRootNode` æ˜¯ä¸€ä¸ªç‰¹æ®ŠèŠ‚ç‚¹ï¼Œå……å½“ `React` çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒä¿å­˜ç€æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€çš„å…ƒæ•°æ®ã€‚å…¶ `current` å±æ€§æŒ‡å‘å®é™…çš„ `Fiber` æ ‘ç»“æ„ï¼Œæ¯æ¬¡æ„å»ºæ–°çš„ `Fiber` æ ‘æ—¶ï¼Œå®ƒéƒ½ä¼šå°† `current` é‡æ–°æŒ‡å‘æ–°çš„ `HostRoot`ã€‚
- `FiberNode`: `react`å†…éƒ¨ä¸­å¯¹ç»“ç‚¹çš„ä¸€ç§è¡¨ç¤ºï¼ŒåŒ…å«å¾ˆå¤šå±æ€§å¯ä»¥å¯¹å…¶ç»“ç‚¹è¿›è¡Œæè¿°
  - `tag`: `FiberNode`æœ‰è®¸å¤šä¸åŒçš„å­ç±»å‹ï¼Œåœ¨`render`ä»¥åŠ`commit`é˜¶æ®µä¼šæ ¹æ®è¯¥å€¼è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œå¦‚`HostRoot`ã€`FunctionComponent`ã€`ClassComponent`ã€`HostComponent`ç­‰ç­‰
  - `stateNode`: å¯¹äº`tag`ä¸º`HostComponet`çš„`FiberNode`ï¼Œå…¶æŒ‡å‘é¡µé¢ä¸­å®é™…æ¸²æŸ“çš„`DOM`èŠ‚ç‚¹
  - `child`ã€`sibling`ã€`return`: åˆ†åˆ«æŒ‡å‘å­èŠ‚ç‚¹ï¼Œå…„å¼ŸèŠ‚ç‚¹ä»¥åŠçˆ¶èŠ‚ç‚¹ï¼Œç”¨äºæ„é€ å®Œæ•´`Fiber`æ ‘
  - `flags`: ç”¨äºè¡¨ç¤ºåœ¨ `commit` é˜¶æ®µéœ€è¦æ›´æ–°çš„ç±»å‹ã€‚subtreeFlags è¡¨ç¤ºå…¶å­æ ‘éœ€è¦æ›´æ–°çš„ç±»å‹

ä¸Šé¢å¯¹äº`FiberNode`çš„å±æ€§ä»‹ç»åªåŒ…å«å½“å‰åˆå§‹åŒ–é¡µé¢æ‰€éœ€è¦çš„å±æ€§ï¼Œå…¶ä»–å±æ€§åœ¨åé¢éœ€è¦ç”¨åˆ°æ—¶å†è¿›è¡Œè§£é‡Šã€‚

## å¤§è‡´è¿‡ç¨‹

æˆ‘ä»¬å…ˆæ¥æŠŠæ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹è¿›è¡Œä¸€ä¸ªç²—ç•¥çš„ä»‹ç»ï¼Œæˆ‘ä»¬åœ¨æ¸²æŸ“é¡µé¢æ—¶ï¼Œä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç 

```jsx
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ†ä¸ºäº†ä»¥ä¸‹ä¸¤ä¸ªä¸»è¦è¿‡ç¨‹ï¼š

1. `createRoot`
2. `render`

### `createRoot`

ä¸Šé¢çš„`createRoot`ä¼šåˆ›å»ºä¸€ä¸ª`FiberRootNode`

```jsx
function createRoot(container, options) {
    var root = createContainer(container, ConcurrentRoot, null, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError);
    return new ReactDOMRoot(root);
  }

function createContainer(containerInfo, tag, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError, transitionCallbacks) {
    var hydrate = false;
    var initialChildren = null;
    return createFiberRoot(containerInfo, tag, hydrate, initialChildren, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError);
  }


function createFiberRoot(containerInfo, tag, hydrate, initialChildren, hydrationCallbacks, isStrictMode, concurrentUpdatesByDefaultOverride, identifierPrefix, onRecoverableError, transitionCallbacks) {
    var root = new FiberRootNode(containerInfo, tag, hydrate, identifierPrefix, onRecoverableError);
    var uninitializedFiber = createHostRootFiber(tag, isStrictMode);
    root.current = uninitializedFiber;
    uninitializedFiber.stateNode = root;
    return root;
  }
```

ä¸Šé¢ä»£ç çš„å¤§è‡´æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š
![alt text](./images/image-13.png)

æ‰§è¡Œå®Œæˆåï¼Œä¼šåˆ›å»ºä¸€ä¸ª`FiberRootNode`ï¼Œä¿å­˜åœ¨`ReactDomRoot`å®ä¾‹çš„`this._internalRoot`ä¸­ï¼Œå……å½“ `React` çš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒä¿å­˜ç€æ•´ä¸ªåº”ç”¨ç¨‹åºæ‰€éœ€çš„å…ƒæ•°æ®ã€‚å…¶ `current` å±æ€§æŒ‡å‘å®é™…çš„ `Fiber` æ ‘ç»“æ„ï¼Œæ¯æ¬¡æ„å»ºæ–°çš„ `Fiber` æ ‘æ—¶ï¼Œå®ƒéƒ½ä¼šå°† `current` é‡æ–°æŒ‡å‘æ–°çš„ `HostRoot`ã€‚ç”Ÿæˆå¦‚ä¸‹`FiberTree`ç»“æ„ï¼š
![alt text](./images/image-8.png)

å½“å‰çš„`root`å±æ€§å¦‚ä¸‹ï¼š

![alt text](./images/image-4.png)

ä¸Šå›¾ä¸­çš„`root`ä¸ºå½“å‰`ReactDOMRoot`çš„å®ä¾‹ï¼Œå†…éƒ¨`_internalRoot`ä¸ºå½“å‰å®ä¾‹çš„`FiberRootNode`ï¼Œå…¶`current`æŒ‡å‘å½“å‰é¡µé¢çš„`FiberNode`èŠ‚ç‚¹ã€‚å…¶ä¸­`tag`çš„å€¼ä¸º`3`ï¼Œè¡¨ç¤º`FiberNode`çš„èŠ‚ç‚¹ç±»å‹ä¸º`HostRoot`ã€‚

![alt text](./images/image-5.png)

### render

åœ¨`render`è¿‡ç¨‹ä¸­ä¸»è¦æ‰§è¡Œäº†ä¸‹é¢å†…å®¹ï¼š

```jsx
ReactDOMRoot.prototype.render = function (children) {
  var root = this._internalRoot;
  updateContainer(children, root, null, null);
};

function updateContainer(element, container, parentComponent, callback) {
  // some other code...
  var update = createUpdate(eventTime, lane);
  update.payload = {
    element: element
  };
  callback = callback === undefined ? null : callback;
  var root = enqueueUpdate(current$1, update, lane);

  if (root !== null) {
    // è¿›å…¥è°ƒåº¦å™¨ schedule
    scheduleUpdateOnFiber(root, current$1, lane, eventTime);
  }
  return lane;
}

function scheduleUpdateOnFiber(root, fiber, lane, eventTime) {
  if ((executionContext & RenderContext) !== NoLanes && root === workInProgressRoot) {
    // some code...
  } else {
    // ç¡®ä¿FiberRootNodeè¢«è°ƒåº¦
    ensureRootIsScheduled(root, eventTime);
  }
}

function ensureRootIsScheduled(root, currentTime) {
  // some code...
  // è·å–æ›´æ–°ä¼˜å…ˆçº§ï¼Œæ‹¿å–æœ€é«˜çº§åˆ«çš„ä¼˜å…ˆçº§ä»»åŠ¡è¿›è¡Œæ‰§è¡Œ
   scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));
}

function performSyncWorkOnRoot(root) {
    var exitStatus = renderRootSync(root, lanes);
    var finishedWork = root.current.alternate;
    root.finishedWork = finishedWork;
    root.finishedLanes = lanes;
    commitRoot(root, workInProgressRootRecoverableErrors, workInProgressTransitions);
    return null;
  }
```

ä¸Šé¢çš„ä»£ç å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‹é¢çš„æµç¨‹å›¾ï¼š
![alt text](./images/image-6.png)

å…¶ä¸­`scheduleUpdateOnFiber`ã€`ensureRootIsScheduled`ä»¥åŠ`scheduleSyncCallback`éƒ½æ˜¯è°ƒåº¦ç›¸å…³çš„å‡½æ•°ï¼Œæœ¬ç« çš„é‡ç‚¹æ˜¯æ¸²æŸ“ï¼Œå…ˆæš‚æ—¶è·³è¿‡è¿™äº›å†…å®¹ï¼ŒåæœŸè°ƒåº¦ç›¸å…³ä¼šè¯¦ç»†è®²è§£ã€‚æ¸²æŸ“ç›¸å…³çš„æ ¸å¿ƒå‡½æ•°ä¸º`performSyncWorkOnRoot`ï¼Œä»¥åŠ`performConcurrentWorkOnRoot`å‡½æ•°ï¼Œ`performSyncWorkOnRoot`ä¸º**åŒæ­¥æ¨¡å¼**ï¼Œ`performConcurrentWorkOnRoot`ä¸º**å¹¶å‘æ¨¡å¼**

#### åŒæ­¥æ¨¡å¼

```text
performSyncWorkOnRoot
    â†“
renderRootSync  // åŒæ­¥æ¸²æŸ“æ ¹èŠ‚ç‚¹
    â†“
workLoopSync    // åŒæ­¥å·¥ä½œå¾ªç¯ï¼ˆä¸å¯ä¸­æ–­ï¼‰
    â†“
completeUnitWork // å®Œæˆå•å…ƒå·¥ä½œ
    â†“
commitRoot      // æäº¤å˜æ›´åˆ°DOM
```

#### å¹¶å‘æ¨¡å¼

```text
performConcurrentWorkOnRoot
    â†“
renderRootConcurrent  // å¹¶å‘æ¸²æŸ“æ ¹èŠ‚ç‚¹
    â†“
workLoopConcurrent    // å¹¶å‘å·¥ä½œå¾ªç¯ï¼ˆå¯ä¸­æ–­ï¼‰
    â†“
shouldYield? â†’ æ˜¯ â†’ æš‚åœå¹¶è¿”å›
    â†“
completeUnitWork
    â†“
commitRoot
```

ä¸Šé¢çš„åŒæ­¥æ¨¡å¼ä¸å¹¶å‘æ¨¡å¼çš„ä¸»è¦åŒºåˆ«ä¸ºæ¸²æŸ“æ ¹èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œ**åŒæ­¥æ¨¡å¼**åˆ›å»º`FiberTree`çš„è¿‡ç¨‹**ä¸å¯ä¸­æ–­**ï¼Œ**å¹¶å‘æ¨¡å¼**åˆ™å¯ä»¥è¢«**é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¸­æ–­**ï¼Œè€Œ`commitRoot`è¿‡ç¨‹åˆ™æ˜¯ä¸€è‡´éƒ½ï¼Œéƒ½æ˜¯åŒæ­¥æ‰§è¡Œã€‚

ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°`render`å‡½æ•°ä¸­æ‰§è¡Œäº†`renderRootSync`ä¸`commitRoot`ä¸¤ä¸ªå‡½æ•°ï¼Œä¹Ÿæ˜¯`React`ä¸­æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º`FiberNode`ä»¥åŠå¯¹åº”çš„`stateNode`ã€`flags`ã€`subtreeFlags`,å¹¶ç”Ÿæˆ`FiberTree`ï¼Œå¦ä¸€ä¸ªæ˜¯æ ¹æ®å‰é¢åˆ›å»ºçš„`FiberTree`ï¼Œè·å–å¯¹åº”èŠ‚ç‚¹çš„`flags`ä»¥åŠ`subtreeFlags`æ¥è¿›è¡Œå¯¹åº”çš„`DOM`èŠ‚ç‚¹æŒ‚è½½æ“ä½œã€‚

ğŸ“¢ æ³¨æ„ï¼šç”±äº`commitRoot`æ˜¯ä¸€æ¬¡æ‰§è¡Œå®Œæˆçš„æŒ‚è½½è¿‡ç¨‹ï¼Œä¸ºäº†é¿å…æµè§ˆå™¨äº§ç”Ÿé—ªçƒä»¥åŠé‡ç»˜ç­‰ï¼Œ`React`å†…éƒ¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨`render`é˜¶æ®µï¼Œå°±å°†å­æ ‘çš„æ•´ä¸ª`DOM`æ ‘æ„å»ºå®Œæˆäº†ã€‚ä¸‹é¢ä¼šè¿›è¡Œè¯¦ç»†çš„è§£æï¼š

#### renderRootSync

åœ¨`renderRootSync`å‡½æ•°ä¸­çš„æ ¸å¿ƒä¸º`do...while(true)`çš„æ‰§è¡Œ`workLoopSync`å‡½æ•°

```jsx
function renderRootSync(root, lanes) {
  prepareFreshStack(root, lanes);
  do {
    try {
      workLoopSync();
      break;
    } catch (thrownValue) {
      handleError(root, thrownValue);
    }
  } while (true);
  workInProgressRoot = null;
  workInProgressRootRenderLanes = NoLanes;

  return workInProgressRootExitStatus;
}

function prepareFreshStack(root, lanes) {
    root.finishedWork = null;
    root.finishedLanes = NoLanes;

    workInProgressRoot = root;
    var rootWorkInProgress = createWorkInProgress(root.current, null);
    workInProgress = rootWorkInProgress;
    finishQueueingConcurrentUpdates();
    return rootWorkInProgress;
  }

function workLoopSync() {
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}


function performUnitOfWork(unitOfWork) {
  var current = unitOfWork.alternate;
  setCurrentFiber(unitOfWork);
  var next;

  if ( (unitOfWork.mode & ProfileMode) !== NoMode) {
    next = beginWork(current, unitOfWork, subtreeRenderLanes);
  } else {
    next = beginWork(current, unitOfWork, subtreeRenderLanes);
  }

  resetCurrentFiber();
  unitOfWork.memoizedProps = unitOfWork.pendingProps;

  if (next === null) {
    completeUnitOfWork(unitOfWork);
  } else {
    workInProgress = next;
  }

  ReactCurrentOwner$2.current = null;
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä¸»è¦å®ç°äº†ä¸¤éƒ¨åˆ†é‡è¦å†…å®¹ï¼š

- 1.åˆ›å»º`workInProgress`ï¼š`prepareFreshStack`å‡½æ•°å°†å½“å‰`FiberRootNode`ç±»å‹çš„èŠ‚ç‚¹ä¼ å…¥ï¼Œä½¿ç”¨å…¶`root.current`å±æ€§åˆ›å»º`workInProgress`ï¼Œ`root.current`ä¸ºå½“å‰å®¹å™¨çš„`FiberNode`èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯`FiberNode(HostRoot)`
- 2.å¼€å¯å·¥ä½œå¾ªç¯ï¼š`workLoopSync`ä»¥åŠ`performUnitOfWork`å‡½æ•°å®ç°äº†å¯¹`FiberTree`çš„åˆ›å»ºï¼Œå…¶ä¸­`beginWork`æ˜¯åˆ›å»º`FiberNode`ï¼Œ`completeUnitOfWork`ä¸ºåˆ›å»º`stateNode`å¹¶æ„å»ºå½“å‰èŠ‚ç‚¹çš„`DOM`æ ‘çš„è¿‡ç¨‹ã€‚

æ‰§è¡Œå®Œä¸Šé¢çš„å†…å®¹åï¼Œå½“å‰å†…å­˜ä¸­çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-14.png)

##### workLoopSync

ä¸‹é¢æ˜¯`beginWork`å‡½æ•°çš„ä¸»è¦å†…å®¹ï¼Œä¸»è¦å°±æ˜¯æ ¹æ®`fiberNode`çš„`tag`å€¼æ‰§è¡Œä¸åŒçš„æ–¹æ³•

```jsx
function beginWork(current, workInProgress, renderLanes) {
  workInProgress.lanes = NoLanes;

  switch (workInProgress.tag) {
    case IndeterminateComponent:
      {
        return mountIndeterminateComponent(current, workInProgress, workInProgress.type, renderLanes);
      }

    case FunctionComponent:
      {
        var Component = workInProgress.type;
        var unresolvedProps = workInProgress.pendingProps;
        var resolvedProps = workInProgress.elementType === Component ? unresolvedProps : resolveDefaultProps(Component, unresolvedProps);
        return updateFunctionComponent(current, workInProgress, Component, resolvedProps, renderLanes);
      }

    case HostRoot:
      return updateHostRoot(current, workInProgress, renderLanes);

    case HostComponent:
      return updateHostComponent(current, workInProgress, renderLanes);

    case HostText:
      return updateHostText(current, workInProgress);
  }
}
```

è®©æˆ‘ä»¬ä»å¤´è¿›å…¥è¯¥å‡½æ•°ï¼Œäº†è§£ä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹ï¼Œç°åœ¨ä½¿ç”¨äº†å¦‚ä¸‹çš„ç»“æ„è¿›è¡Œæ¸²æŸ“ï¼š

```jsx
<App>
    <A>
        <div>
            <div>A</div>
            <div>B</div>
        </div>
    </A>
</App>
```

#### beginWorké˜¶æ®µ

##### **ç¬¬ä¸€æ¬¡ workLoop**

å‡½æ•°æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š
![alt text](./images/react-begin-loop1.png)

è¿™æ˜¯ç¬¬ä¸€æ¬¡`workLoop`å¾ªç¯ï¼Œå½“å‰çš„`workInProgress === FiberNode(HostRoot)`ï¼Œè¿›å…¥`beginWork`å‡½æ•°ï¼Œæ ¹æ®å½“å‰`tag === 3`ï¼Œè¿›å…¥`updateHostRoot`å‡½æ•°ï¼Œç„¶åè¿›å…¥`reconcileChildren`å‡½æ•°ä¸­ï¼Œæ­¤æ—¶ï¼Œä¼šå°† `<App />`è¢«`babel`ç¼–è¯‘åçš„`ReactElement`å¯¹è±¡ä½œä¸º`newChild`ä¼ å…¥`reconcileChildFibers`ä½œä¸ºå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸ºæ‰§è¡Œ`ChildReconciler(true)`åè¿”å›çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯`ChildReconciler`å‡½æ•°ä¸­çš„é—­åŒ…`reconcileChildFibers`å‡½æ•°ï¼Œå…¶ä¸­`shouldTrackSideEffects`å‚æ•°ä¸º`true`ã€‚åé¢ç»§ç»­è¿›å…¥`reconcileSingleElement`å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»º`FiberNode(<App />)`ï¼Œå¹¶å°†å…¶`return`å±æ€§ï¼ŒæŒ‡å‘å½“å‰`FiberNode(HostRoot)`ã€‚åç»­å°†å½“å‰æ–°åˆ›å»ºçš„`FiberNode(<App />)`ä½œä¸ºå‚æ•°ä¼ å…¥`placeSingleChild`å‡½æ•°ï¼Œæ·»åŠ `flags`ï¼Œå…¶`shouldTrackSideEffects === true`ï¼Œåˆ™`FiberNode(<App />).flags === Placement`ï¼Œæ‰§è¡Œåˆ°å½“å‰çš„å†…å­˜æ•°æ®æ¥å£å¦‚ä¸‹ï¼š

![alt text](./images/image-17.png)

ç„¶åä»`placeSingleChild`ä¾æ¬¡ä»è°ƒç”¨æ ˆä¸­è¿›è¡Œè¿”å›ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯åœ¨`reconcileChildren`å‡½æ•°ä¸­ï¼Œå°†`workInProgress.child`å±æ€§æŒ‡å‘äº†æ–°åˆ›å»ºçš„`FiberNode(<App />)`èŠ‚ç‚¹ã€‚æ­¤æ—¶ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-18.png)

ç„¶ååœ¨`performUnitOfWork`å‡½æ•°ä¸­ï¼Œå°†`workInProgress`æŒ‡å‘äº†`FiberNode(<App />)`èŠ‚ç‚¹ã€‚æ­¤æ—¶ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-19.png)

##### **ç¬¬äºŒæ¬¡workLoop**

æ­¤æ—¶è¿›å…¥ä¸‹ä¸€æ¬¡`workLoopSync`å¾ªç¯ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
![alt text](./images/react-work-loop2.png)

å½“å‰å¾ªç¯ä¸ä¸Šä¸€æ¬¡å¾ªç¯ä¸åŒä¹‹å¤„åœ¨äºï¼Œæ­¤æ—¶çš„`FiberNode(<App />).tag === IndeterminateComponent`å¹¶ä¸”æ­¤æ—¶`workInProgress`çš„`current`ä¸º`null`ï¼Œäºæ˜¯è¿›å…¥`mountIndeterminateComponent`å‡½æ•°ï¼Œå°†è¯¥`FiberNode<App />.tag`ä¿®æ”¹ä¸º`FunctionComponent`ï¼Œç„¶åç»§ç»­æ‰§è¡Œ`renderWithHooks`å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…ï¼Œå¦‚æœæ˜¯å‡½æ•°ç»„ä»·ï¼Œåˆ™è·å–å…¶`type`ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æ¥è¿›è¡Œæ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆåçš„è¿”å›å€¼ï¼Œä¼ å…¥`reconcileChildren`å‡½æ•°å†…ï¼Œç”±äº`current === null`ï¼Œæ‰€ä»¥æ‰§è¡Œ`mountChildFibers`å‡½æ•°ï¼Œåˆ›å»º`FiberNode(<A />)`ï¼Œå½“å‰æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-22.png)

åœ¨å‡½æ•°è¿”å›åé€æ¸è¿”å›è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œå¹¶åœ¨`reconcileChildren`å‡½æ•°ä¸­å°†`workInProgress.child`æŒ‡å‘å½“å‰æ–°çš„ç»“ç‚¹`FiberNode(<A />)`ï¼Œå¹¶åœ¨`performUnitOfWork`å‡½æ•°ä¸­å°†å½“å‰æ–°åˆ›å»ºçš„ç»“ç‚¹æŒ‡å‘`workInProgress`ï¼Œå½“å‰æ•°æ®ç»“æ„å¦‚ä¸‹:
![alt text](./images/image-23.png)

##### **ç¬¬ä¸‰æ¬¡workLoop**

ç»§ç»­æ‰§è¡Œç¬¬ä¸‰æ¬¡`workLoop`å¾ªç¯ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
![alt text](./images/react-work-loop3.png)
å½“å‰å¾ªç¯ä¸ä¸Šæ¬¡å¾ªç¯è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œé™¤äº†ç”Ÿæˆçš„`FiberNode`çš„`tag === HostComponent`ç±»å‹ï¼Œè¿™æ˜¯åœ¨`createFiberFromTypeAndProps`å‡½æ•°ä¸­æ ¹æ®å½“å‰çš„`type`å€¼å†³å®šçš„ï¼Œå½“å‰`type === div`ï¼Œè¡¨ç¤ºä¸º**å®¿ä¸»ç»„ä»¶**ï¼Œåˆ™å°†`tag = HostComponent`ï¼Œå½“å‰æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-24.png)
ä¾æ¬¡è¿”å›è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œæœ¬è½®å¾ªç¯æ‰§è¡Œå®Œæˆåæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-25.png)

##### **ç¬¬å››æ¬¡workLoop**

![alt text](./images/react-work-loop4.png)

ç¬¬å››æ¬¡å¾ªç¯æµç¨‹å¦‚ä¸Šå›¾ğŸ‘†ğŸ»ï¼Œå½“å‰`workInProgress === FiberNode(div)`ï¼Œåˆ™åœ¨`beginWork`å‡½æ•°ä¸­æ ¹æ®`tag === HostComponent`ï¼Œä¼šè¿›å…¥`updateHostComponent`å‡½æ•°ï¼Œ`babel`åœ¨ç¼–è¯‘æ—¶å°†`HostComponent`ç»„ä»¶çš„å­å…ƒç´ ä½œä¸º`children`å±æ€§æ”¾åœ¨äº†å…¶`element.props`ä¸­ï¼Œç„¶åå†åˆ›å»º`FiberNode`æ—¶ï¼Œä¿å­˜åœ¨äº†`FiberNode(div).pendingProps`å±æ€§ä¸­ã€‚å¦‚ä¸‹ä»£ç ï¼š

```jsx
function createFiberFromElement(element, mode, lanes) {
  var type = element.type;
  var key = element.key;
  var pendingProps = element.props;
  var fiber = createFiberFromTypeAndProps(type, key, pendingProps, owner, mode, lanes);
  return fiber;
}
```

ç„¶åå†`updateHostComponent`ä¸­æ‰§è¡Œä¸‹é¢ä»£ç ï¼Œå°†å…¶å­å…ƒç´ ä¼ å…¥äº†`reconcileChildren`å‡½æ•°

```jsx
var nextProps = workInProgress.pendingProps;
var prevProps = current !== null ? current.memoizedProps : null;
var nextChildren = nextProps.children;
```

æ‰§è¡Œåˆ°`reconcileChildFibers`å‡½æ•°å†…éƒ¨ï¼Œå‘ç°å…¶`isArray(newChild) === true`ï¼Œåˆ™æ‰§è¡Œäº†`reconcileChildrenArray`å‡½æ•°

```jsx
function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren, lanes) {
  var resultingFirstChild = null;
  var previousNewFiber = null;
  var oldFiber = currentFirstChild;
  var lastPlacedIndex = 0;
  var newIdx = 0;
  var nextOldFiber = null;

  if (oldFiber === null) {
    for (; newIdx < newChildren.length; newIdx++) {
      var _newFiber = createChild(returnFiber, newChildren[newIdx], lanes);

      if (_newFiber === null) {
        continue;
      }

      lastPlacedIndex = placeChild(_newFiber, lastPlacedIndex, newIdx);

      if (previousNewFiber === null) {
        resultingFirstChild = _newFiber;
      } else {
        previousNewFiber.sibling = _newFiber;
      }

      previousNewFiber = _newFiber;
    }

    return resultingFirstChild;
  }
  return resultingFirstChild;
}
```

å½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆåçš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼š
![alt text](./images/image-27.png)
å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç”Ÿæˆäº†å¯¹åº”çš„`FiberNode(div-A)`èŠ‚ç‚¹ï¼Œä»¥åŠ`FiberNode(div-B)`èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶é€šè¿‡`sibling`å±æ€§è¿›è¡Œè¿æ¥ã€‚å¹¶ä¸”å®ƒä»¬çš„`return`èŠ‚ç‚¹éƒ½æŒ‡å‘äº†`FiberNode(div)`èŠ‚ç‚¹ã€‚

åç»­ä¾æ¬¡è¿”å›è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œæœ¬è½®å¾ªç¯æ‰§è¡Œå®Œæˆåæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-29.png)

##### **ç¬¬äº”æ¬¡workLoop**

è¿›å…¥ç¬¬äº”æ¬¡`workLoop`å¾ªç¯ä¸­çš„`beginWork`å‡½æ•°ï¼Œå½“å‰`workInProgress === FiberNode(div-A)`ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
![alt text](./images/react-work-loop5.png)ï¼Œå¤§è‡´æµç¨‹ä¸ä¸Šæ¬¡å¾ªç¯ä¸€è‡´ï¼Œä¸åŒç‚¹ä¸ºæ²¡æœ‰å…¶å­å…ƒç´ ï¼Œå‡½æ•°è¿”å›çš„ä¸º`null`ï¼Œå…¶æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œäºæ˜¯è¿›å…¥`performUnitOfWork`å‡½æ•°ä¸­çš„`completeUnitOfWork`å‡½æ•°ã€‚å½“å‰å†…å­˜ä¸­æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
![alt text](./images/image-30.png)
