<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise.all | 邓攀的技术博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge/assets/css/0.styles.ef1330c5.css" as="style"><link rel="preload" href="/knowledge/assets/js/app.d13ce116.js" as="script"><link rel="preload" href="/knowledge/assets/js/2.bc15d414.js" as="script"><link rel="preload" href="/knowledge/assets/js/1.6c0ff8f4.js" as="script"><link rel="preload" href="/knowledge/assets/js/50.02a683f2.js" as="script"><link rel="prefetch" href="/knowledge/assets/js/10.e193d6c0.js"><link rel="prefetch" href="/knowledge/assets/js/11.8e802c1e.js"><link rel="prefetch" href="/knowledge/assets/js/12.65553447.js"><link rel="prefetch" href="/knowledge/assets/js/13.2be48d38.js"><link rel="prefetch" href="/knowledge/assets/js/14.fbcaafc6.js"><link rel="prefetch" href="/knowledge/assets/js/15.e40ead57.js"><link rel="prefetch" href="/knowledge/assets/js/16.49184ae1.js"><link rel="prefetch" href="/knowledge/assets/js/17.dc3323dd.js"><link rel="prefetch" href="/knowledge/assets/js/18.648b10c4.js"><link rel="prefetch" href="/knowledge/assets/js/19.2a696a53.js"><link rel="prefetch" href="/knowledge/assets/js/20.89f58454.js"><link rel="prefetch" href="/knowledge/assets/js/21.0e698439.js"><link rel="prefetch" href="/knowledge/assets/js/22.2951858e.js"><link rel="prefetch" href="/knowledge/assets/js/23.fad55543.js"><link rel="prefetch" href="/knowledge/assets/js/24.1811a1e3.js"><link rel="prefetch" href="/knowledge/assets/js/25.7d611585.js"><link rel="prefetch" href="/knowledge/assets/js/26.2706e843.js"><link rel="prefetch" href="/knowledge/assets/js/27.2ffa03e5.js"><link rel="prefetch" href="/knowledge/assets/js/28.2e367c11.js"><link rel="prefetch" href="/knowledge/assets/js/29.cb85613d.js"><link rel="prefetch" href="/knowledge/assets/js/3.f74b7660.js"><link rel="prefetch" href="/knowledge/assets/js/30.652b9bc5.js"><link rel="prefetch" href="/knowledge/assets/js/31.e2d5d8ed.js"><link rel="prefetch" href="/knowledge/assets/js/32.2097c650.js"><link rel="prefetch" href="/knowledge/assets/js/33.c3b9402b.js"><link rel="prefetch" href="/knowledge/assets/js/34.9690a5a6.js"><link rel="prefetch" href="/knowledge/assets/js/35.a3e2d1a4.js"><link rel="prefetch" href="/knowledge/assets/js/36.40ee0a89.js"><link rel="prefetch" href="/knowledge/assets/js/37.e5c4e5c6.js"><link rel="prefetch" href="/knowledge/assets/js/38.3da1edcd.js"><link rel="prefetch" href="/knowledge/assets/js/39.dde21d94.js"><link rel="prefetch" href="/knowledge/assets/js/4.d0407187.js"><link rel="prefetch" href="/knowledge/assets/js/40.183865a3.js"><link rel="prefetch" href="/knowledge/assets/js/41.fbed79bd.js"><link rel="prefetch" href="/knowledge/assets/js/42.ddb9e519.js"><link rel="prefetch" href="/knowledge/assets/js/43.d8c6b670.js"><link rel="prefetch" href="/knowledge/assets/js/44.b8600c23.js"><link rel="prefetch" href="/knowledge/assets/js/45.8fdbb89e.js"><link rel="prefetch" href="/knowledge/assets/js/46.2c0b6696.js"><link rel="prefetch" href="/knowledge/assets/js/47.ba0b752b.js"><link rel="prefetch" href="/knowledge/assets/js/48.77af7173.js"><link rel="prefetch" href="/knowledge/assets/js/49.4165aa91.js"><link rel="prefetch" href="/knowledge/assets/js/5.6b5b30dd.js"><link rel="prefetch" href="/knowledge/assets/js/51.377c538d.js"><link rel="prefetch" href="/knowledge/assets/js/52.2b8cd451.js"><link rel="prefetch" href="/knowledge/assets/js/53.b6fbea0a.js"><link rel="prefetch" href="/knowledge/assets/js/54.465ac807.js"><link rel="prefetch" href="/knowledge/assets/js/55.0dbe2c3d.js"><link rel="prefetch" href="/knowledge/assets/js/56.58d40823.js"><link rel="prefetch" href="/knowledge/assets/js/57.cd68dd2d.js"><link rel="prefetch" href="/knowledge/assets/js/58.ab749b89.js"><link rel="prefetch" href="/knowledge/assets/js/59.d290e425.js"><link rel="prefetch" href="/knowledge/assets/js/6.ded172f2.js"><link rel="prefetch" href="/knowledge/assets/js/60.3c53fd43.js"><link rel="prefetch" href="/knowledge/assets/js/61.5f83939f.js"><link rel="prefetch" href="/knowledge/assets/js/62.73a942e4.js"><link rel="prefetch" href="/knowledge/assets/js/63.0838cf95.js"><link rel="prefetch" href="/knowledge/assets/js/64.d3240197.js"><link rel="prefetch" href="/knowledge/assets/js/65.80115882.js"><link rel="prefetch" href="/knowledge/assets/js/66.b3f1a356.js"><link rel="prefetch" href="/knowledge/assets/js/67.19eee347.js"><link rel="prefetch" href="/knowledge/assets/js/68.8be7df47.js"><link rel="prefetch" href="/knowledge/assets/js/69.20fbf51a.js"><link rel="prefetch" href="/knowledge/assets/js/7.48ee682d.js"><link rel="prefetch" href="/knowledge/assets/js/70.be66b6a3.js"><link rel="prefetch" href="/knowledge/assets/js/71.1cb926bc.js"><link rel="prefetch" href="/knowledge/assets/js/72.a00945dc.js"><link rel="prefetch" href="/knowledge/assets/js/73.a2552003.js"><link rel="prefetch" href="/knowledge/assets/js/74.cbe8f2ff.js"><link rel="prefetch" href="/knowledge/assets/js/75.0d9796c1.js"><link rel="prefetch" href="/knowledge/assets/js/76.81666afa.js"><link rel="prefetch" href="/knowledge/assets/js/77.c982ce9e.js"><link rel="prefetch" href="/knowledge/assets/js/78.cdad9a20.js"><link rel="prefetch" href="/knowledge/assets/js/79.f5c2f5e9.js"><link rel="prefetch" href="/knowledge/assets/js/80.f34dff30.js"><link rel="prefetch" href="/knowledge/assets/js/81.a63fca8d.js"><link rel="prefetch" href="/knowledge/assets/js/vendors~docsearch.94b65286.js">
    <link rel="stylesheet" href="/knowledge/assets/css/0.styles.ef1330c5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge/" class="home-link router-link-active"><!----> <span class="site-name">邓攀的技术博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/MyDAIDAI" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge/" aria-current="page" class="sidebar-link">欢迎</a></li><li><section class="sidebar-group depth-0"><a href="/knowledge/vue" class="sidebar-heading clickable"><span>Vue</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/vue/响应式.html" class="sidebar-link">响应式</a></li><li><a href="/knowledge/vue/编译.html" class="sidebar-link">编译</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/react" class="sidebar-heading clickable"><span>React</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/react/JSX.html" class="sidebar-link">JSX</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/typescript" class="sidebar-heading clickable"><span>TypeScript</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/typescript/type-challenges.html" class="sidebar-link">类型体操</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/nextjs" class="sidebar-heading clickable"><span>nextjs</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/nextjs/docs.html" class="sidebar-link">文档</a></li><li><a href="/knowledge/nextjs/use.html" class="sidebar-link">使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/algorithm" class="sidebar-heading clickable"><span>算法</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/algorithm/二分查找.html" class="sidebar-link">二分查找</a></li><li><a href="/knowledge/algorithm/大数相加.html" class="sidebar-link">大数相加</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/system-design" class="sidebar-heading clickable"><span>系统设计</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/system-design/news-feed.html" class="sidebar-link">news feed</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/interview" class="sidebar-heading clickable"><span>面试相关</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/interview/html.html" class="sidebar-link">HTML</a></li><li><a href="/knowledge/interview/JavaScript.html" class="sidebar-link">JavaScript</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/GFE" class="sidebar-heading clickable router-link-active open"><span>GFE</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/GFE/01.debounce/" class="sidebar-link">Debounce</a></li><li><a href="/knowledge/GFE/02.myReduce/" class="sidebar-link">MyReduce</a></li><li><a href="/knowledge/GFE/03.classnames/" class="sidebar-link">ClassNames</a></li><li><a href="/knowledge/GFE/04.flatten/" class="sidebar-link">Flatten</a></li><li><a href="/knowledge/GFE/05.throttle/" class="sidebar-link">Throttle</a></li><li><a href="/knowledge/GFE/06.Type%20Utilities/" class="sidebar-link">Type Utilities</a></li><li><a href="/knowledge/GFE/07.Type%20Utilities%20II/" class="sidebar-link">Type Utilities II</a></li><li><a href="/knowledge/GFE/08.Promise.all/" aria-current="page" class="active sidebar-link">Promise.all</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge/GFE/08.Promise.all/#solution" class="sidebar-link">Solution</a></li><li class="sidebar-sub-header"><a href="/knowledge/GFE/08.Promise.all/#类型签名解析" class="sidebar-link">类型签名解析</a></li></ul></li><li><a href="/knowledge/GFE/09.Data%20Merging/" class="sidebar-link">Data Merging</a></li><li><a href="/knowledge/GFE/10.Deep%20Clone/" class="sidebar-link">Deep Clone</a></li><li><a href="/knowledge/GFE/11.Event%20Emitter/" class="sidebar-link">Event Emitter</a></li><li><a href="/knowledge/GFE/12.getElementsByStyle/" class="sidebar-link">getElementsByStyle</a></li><li><a href="/knowledge/GFE/13.Function.prototype.call/" class="sidebar-link">Function.prototype.call</a></li><li><a href="/knowledge/GFE/14.List%20Format/" class="sidebar-link">List Format</a></li><li><a href="/knowledge/GFE/15.Map%20Async%20Limit/" class="sidebar-link">Map Async Limit</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/Blind" class="sidebar-heading clickable"><span>Blind</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/Blind/01.Balanced%20Brackets/" class="sidebar-link">Balanced Brackets</a></li><li><a href="/knowledge/Blind/02.Find%20Duplicates%20in%20Array/" class="sidebar-link">Find Duplicates in Array</a></li><li><a href="/knowledge/Blind/03.Find%20Missing%20Number%20in%20Sequence/" class="sidebar-link">Find Missing Number in Sequence</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge/git" class="sidebar-heading clickable"><span>Git</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/git/commit.html" class="sidebar-link">commit</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise-all"><a href="#promise-all" class="header-anchor">#</a> Promise.all</h1> <p><code>Promise.all()</code> 静态方法接受一个 <code>Promise</code> 可迭代对象作为输入，并返回一个 <code>Promise</code>。当所有输入的 <code>Promise</code> 都被兑现时，返回的 <code>Promise</code> 也将被兑现（即使传入的是一个空的可迭代对象），并返回一个包含所有兑现值的数组。如果输入的任何 <code>Promise</code> 被拒绝，则返回的 <code>Promise</code> 将被拒绝，并带有第一个被拒绝的原因。</p> <p><code>Promise.all()</code>一般被用来处理多个并发的请求，会等待所有的请求都被完成才会执行后续方法</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Resolved example.</span>
<span class="token keyword">const</span> p0 <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">promiseAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [3, 42, 'foo']</span>

<span class="token comment">// Rejection example.</span>
<span class="token keyword">const</span> p0 <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'An error occurred!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">promiseAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'An error occurred!'</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="solution"><a href="#solution" class="header-anchor">#</a> Solution</h2> <p>主要需要解决以下几点：</p> <ul><li>外部会调用<code>then</code>或者<code>catch</code>等函数，所以需要返回一个<code>Promise</code></li> <li>当传入一个空数组时，直接返回一个<code>Promise.resolve</code>即可</li> <li>返回的<code>Promise</code>需要包含传入数组的执行结果，并且顺序必须相同</li> <li>如果有一个执行被<code>reject</code>了，那么<code>Promise.all</code>会立即执行<code>reject</code>函数，无需等待其他返回结果</li> <li>需要处理输入的内容不为<code>promise</code>的情况</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ReturnValue<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">-</span><span class="token keyword">readonly</span> <span class="token punctuation">[</span><span class="token constant">P</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> Awaited<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">P</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">promiseAll</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token keyword">readonly</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  iterable<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">{</span> <span class="token operator">-</span><span class="token keyword">readonly</span> <span class="token punctuation">[</span><span class="token constant">P</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> Awaited<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">P</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>iterable<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> unresolved <span class="token operator">=</span> iterable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>unresolved <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>results <span class="token keyword">as</span> ReturnValue<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    iterable<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        unresolved<span class="token operator">--</span><span class="token punctuation">;</span>
        results<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>unresolved <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>results <span class="token keyword">as</span> ReturnValue<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="类型签名解析"><a href="#类型签名解析" class="header-anchor">#</a> 类型签名解析</h2> <h3 id="typescript-promiseall-类型系统深度解析"><a href="#typescript-promiseall-类型系统深度解析" class="header-anchor">#</a> TypeScript <code>promiseAll</code> 类型系统深度解析</h3> <p>这个函数签名实现了 TypeScript 的高级类型系统特性，提供了比原生 <code>Promise.all</code> 更精确的类型推断。让我们详细解析它的类型系统设计：</p> <h4 id="函数签名分析"><a href="#函数签名分析" class="header-anchor">#</a> 函数签名分析</h4> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">promiseAll</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token keyword">readonly</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  iterable<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">{</span> <span class="token operator">-</span><span class="token keyword">readonly</span> <span class="token punctuation">[</span><span class="token constant">P</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> Awaited<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">P</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span>
</code></pre></div><h5 id="_1-泛型约束-t-extends-readonly-unknown"><a href="#_1-泛型约束-t-extends-readonly-unknown" class="header-anchor">#</a> 1. 泛型约束 <code>T extends readonly unknown[] | []</code></h5> <ul><li><strong><code>readonly unknown[]</code></strong>：接受任何只读数组类型，包括：
<ul><li>普通数组：<code>number[]</code></li> <li>只读数组：<code>readonly number[]</code></li> <li>元组：<code>[Promise&lt;number&gt;, string]</code></li> <li>只读元组：<code>readonly [Promise&lt;number&gt;, string]</code></li></ul></li> <li><strong><code>| []</code></strong>：专门处理空数组情况</li> <li>使用 <code>readonly</code> 确保兼容 <code>as const</code> 断言创建的只读元组</li></ul> <h5 id="_2-返回类型-promise-readonly-p-in-keyof-t-awaited-t-p"><a href="#_2-返回类型-promise-readonly-p-in-keyof-t-awaited-t-p" class="header-anchor">#</a> 2. 返回类型 <code>Promise&lt;{ -readonly [P in keyof T]: Awaited&lt;T[P]&gt; }&gt;</code></h5> <p>这是一个复杂但精妙的映射类型：</p> <p>a. 映射类型 <code>[P in keyof T]</code></p> <ul><li>遍历类型 <code>T</code> 的所有属性（数组索引）</li> <li>对于元组 <code>[A, B]</code>，<code>P</code> 会是 <code>&quot;0&quot; | &quot;1&quot; | &quot;length&quot; | ...</code></li> <li><strong>关键点</strong>：TypeScript 会识别数字索引映射，自动创建对应的元组类型</li></ul> <p>b. <code>-readonly</code> 修饰符</p> <ul><li><p>移除只读属性</p></li> <li><p>输入是只读元组时，输出变成可变元组：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  <span class="token comment">// readonly [Promise&lt;number&gt;]</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">promiseAll</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// [number] (可变元组)</span>
</code></pre></div></li></ul> <p>c. <code>Awaited&lt;T[P]&gt;</code> 类型</p> <ul><li><p>TypeScript 4.5+ 引入的工具类型</p></li> <li><p>递归解包 Promise 类型：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">Example1</span> <span class="token operator">=</span> Awaited<span class="token operator">&lt;</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>      <span class="token comment">// string</span>
<span class="token keyword">type</span> <span class="token class-name">Example2</span> <span class="token operator">=</span> Awaited<span class="token operator">&lt;</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">;</span> <span class="token comment">// number</span>
<span class="token keyword">type</span> <span class="token class-name">Example3</span> <span class="token operator">=</span> Awaited<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>               <span class="token comment">// number (非Promise保持不变)</span>
</code></pre></div></li></ul> <h5 id="_3-完整的类型转换过程"><a href="#_3-完整的类型转换过程" class="header-anchor">#</a> 3. 完整的类型转换过程</h5> <p>输入类型 <code>T</code> → 输出类型 <code>{ -readonly [P in keyof T]: Awaited&lt;T[P]&gt; }</code></p> <p>示例1：基本元组</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 输入类型</span>
<span class="token constant">T</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>

<span class="token comment">// 输出类型</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;0&quot;</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>  <span class="token comment">// -readonly 移除了只读属性</span>
  <span class="token string-property property">&quot;1&quot;</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  length<span class="token operator">:</span> <span class="token number">2</span>      <span class="token comment">// 保持元组长度</span>
<span class="token punctuation">}</span>
<span class="token comment">// TypeScript 识别为: [number, string]</span>
</code></pre></div><p>示例2：混合类型 + 只读元组</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 输入类型</span>
<span class="token constant">T</span> <span class="token operator">=</span> <span class="token keyword">readonly</span> <span class="token punctuation">[</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span>

<span class="token comment">// 输出类型</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;0&quot;</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;1&quot;</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>   <span class="token comment">// Awaited&lt;string&gt; = string</span>
  <span class="token string-property property">&quot;2&quot;</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>  <span class="token comment">// 递归解包</span>
  length<span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
<span class="token comment">// 识别为: [number, string, boolean] (可变元组)</span>
</code></pre></div><p>示例3：嵌套 Promise</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 输入类型</span>
<span class="token constant">T</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">]</span>

<span class="token comment">// 输出类型</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;0&quot;</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>  <span class="token comment">// 递归解包多层Promise</span>
  length<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment">// 识别为: [string]</span>
</code></pre></div><h5 id="_4-类型系统优势"><a href="#_4-类型系统优势" class="header-anchor">#</a> 4. 类型系统优势</h5> <ol><li><p><strong>精确的元组类型保持</strong></p> <ul><li>保持输入元组的长度和位置关系</li> <li>原生 <code>Promise.all</code> 返回 <code>Promise&lt;any[]&gt;</code> 会丢失类型信息</li></ul></li> <li><p><strong>自动解包嵌套 Promise</strong></p> <ul><li>递归处理任意深度的 Promise 嵌套</li> <li>原生类型需要手动处理深层 Promise</li></ul></li> <li><p><strong>只读处理</strong></p> <ul><li>正确处理 <code>as const</code> 创建的只读元组</li> <li>输出转换为可变元组，符合实际使用场景</li></ul></li> <li><p><strong>空数组特化</strong></p> <ul><li>单独处理 <code>[]</code> 情况，确保返回 <code>Promise&lt;[]&gt;</code></li></ul></li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code>iterable<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类型安全：</span>
    <span class="token comment">// 1. `item` 是 T[number] 类型</span>
    <span class="token comment">// 2. `data` 是 Awaited&lt;T[number]&gt; 类型</span>
    results<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 最终断言：</span>
<span class="token function">resolve</span><span class="token punctuation">(</span>results <span class="token keyword">as</span> ReturnValue<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge/GFE/07.Type%20Utilities%20II/" class="prev">
        Type Utilities II
      </a></span> <span class="next"><a href="/knowledge/GFE/09.Data%20Merging/">
        Data Merging
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge/assets/js/app.d13ce116.js" defer></script><script src="/knowledge/assets/js/2.bc15d414.js" defer></script><script src="/knowledge/assets/js/1.6c0ff8f4.js" defer></script><script src="/knowledge/assets/js/50.02a683f2.js" defer></script>
  </body>
</html>
